<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Shopping Cart - BookStore</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #6d28d9;
      --primary-dark: #5b21b6;
      --secondary: #f1f5f9;
      --accent: #10b981;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --card-bg: #ffffff;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #e74c3c;
      --pre-order: #3b82f6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
    body { background-color: #f8fafc; color: var(--text); line-height: 1.6; }

    .cart-container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .cart-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border);
    }
    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo i { font-size: 2rem; color: var(--primary); }
    .logo h1 {
      font-size: 1.8rem; font-weight: 700;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-welcome { color: var(--text-light); font-weight: 500; }
    .username { color: var(--primary); font-weight: 600; }
    .nav-links { display: flex; gap: 20px; }
    .nav-link {
      text-decoration: none; color: var(--text-light); font-weight: 500; padding: 8px 0;
      position: relative; transition: color 0.3s; display: flex; align-items: center; gap: 5px;
    }
    .nav-link:hover { color: var(--primary); }
    .nav-link.active { color: var(--primary); }
    .nav-link.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background-color: var(--primary); }

    .cart-title {
      font-size: 2rem; font-weight: 700; margin-bottom: 30px; color: var(--text);
      display: flex; align-items: center; gap: 10px;
    }
    .cart-title i { color: var(--primary); }

    .cart-content { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }

    .cart-items-container {
      background-color: var(--card-bg); border-radius: 12px; padding: 25px;
      box-shadow: var(--shadow); height: 500px; display: flex; flex-direction: column;
    }

    .cart-header-actions {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);
    }

    .select-all { display: flex; align-items: center; gap: 10px; }
    .select-all input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .select-all label { cursor: pointer; font-weight: 500; }

    .action-buttons { display: flex; gap: 10px; }
    .action-btn {
      padding: 8px 16px; background-color: var(--secondary); border: none; border-radius: 6px;
      color: var(--text); font-weight: 500; cursor: pointer; transition: background-color 0.3s;
      display: flex; align-items: center; gap: 5px;
    }
    .action-btn:hover { background-color: #e2e8f0; }

    .cart-items-scroll { flex: 1; overflow-y: auto; padding-right: 10px; }
    .cart-items-scroll::-webkit-scrollbar { width: 6px; }
    .cart-items-scroll::-webkit-scrollbar-track { background: var(--secondary); border-radius: 3px; }
    .cart-items-scroll::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

    .loading { text-align: center; padding: 40px; color: var(--text-light); }
    .loading i { font-size: 2rem; margin-bottom: 10px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .empty-cart { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-cart i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    .empty-cart h3 { font-size: 1.5rem; margin-bottom: 10px; color: var(--text); }
    .empty-cart p { margin-bottom: 30px; }
    .continue-shopping {
      display: inline-block; padding: 12px 30px; background-color: var(--primary); color: white;
      text-decoration: none; border-radius: 8px; font-weight: 600; transition: background-color 0.3s;
    }
    .continue-shopping:hover { background-color: var(--primary-dark); }

    .cart-item {
      display: grid; grid-template-columns: auto 100px 1fr auto;
      gap: 15px; padding: 15px; border-bottom: 1px solid var(--border);
      align-items: center; transition: background-color 0.3s;
    }
    .cart-item:hover { background-color: var(--secondary); }
    .cart-item:last-child { border-bottom: none; }

    .item-checkbox { display: flex; align-items: center; }
    .item-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .item-image {
      width: 100px; height: 120px; background: linear-gradient(135deg, var(--secondary), #e2e8f0);
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      color: var(--text-light); overflow: hidden; cursor: pointer;
    }
    .item-image i { font-size: 2.5rem; opacity: 0.7; }

    .item-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; color: var(--text); cursor: pointer; }
    .item-title:hover { color: var(--primary); }
    .item-author { color: var(--text-light); margin-bottom: 10px; font-size: 0.9rem; }
    .item-category { display: inline-block; background-color: var(--secondary); padding: 3px 8px; border-radius: 4px; color: var(--text-light); font-size: 0.85rem; margin-bottom: 10px; }
    .item-price { font-weight: 700; color: var(--primary); font-size: 1.1rem; }

    .pre-order-badge, .available-badge {
      display: inline-block; color: white; padding: 3px 8px; border-radius: 4px;
      font-size: 0.75rem; font-weight: 600; margin-left: 5px;
    }
    .pre-order-badge { background-color: var(--pre-order); }
    .available-badge { background-color: var(--success); }

    .item-stock { font-size: 0.85rem; color: var(--text-light); margin-top: 5px; }
    .in-stock { color: var(--success); }
    .low-stock { color: var(--warning); }
    .out-of-stock { color: var(--danger); }
    .pre-order-stock { color: var(--pre-order); }

    .item-actions { display: flex; align-items: center; gap: 15px; }

    .quantity-control { display: flex; align-items: center; gap: 10px; }
    .quantity-btn {
      width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);
      background-color: white; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s;
    }
    .quantity-btn:hover { background-color: var(--secondary); }
    .quantity-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .quantity-input {
      width: 50px; text-align: center; padding: 5px;
      border: 1px solid var(--border); border-radius: 4px; font-size: 1rem;
    }
    .quantity-input:focus { outline: none; border-color: var(--primary); }
    .quantity-input:disabled { background-color: var(--secondary); cursor: not-allowed; }

    .remove-btn {
      background: none; border: none; color: var(--danger); cursor: pointer; padding: 8px;
      border-radius: 4px; transition: background-color 0.3s;
    }
    .remove-btn:hover { background-color: rgba(239, 68, 68, 0.1); }

    .item-total { text-align: right; font-weight: 700; font-size: 1.2rem; min-width: 100px; }

    .selected-summary { background-color: var(--secondary); border-radius: 8px; padding: 15px; margin-top: 20px; }
    .summary-title { font-size: 1rem; font-weight: 600; margin-bottom: 10px; color: var(--text); }
    .selected-items-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
    .selected-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .selected-item:last-child { border-bottom: none; }
    .selected-item-name { flex: 1; font-size: 0.9rem; }
    .selected-item-price { font-weight: 600; color: var(--primary); }

    .cart-summary {
      background-color: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: var(--shadow);
      height: fit-content; position: sticky; top: 20px;
    }
    .summary-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: var(--text); }
    .summary-details { margin-bottom: 25px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    .summary-row.total { font-size: 1.3rem; font-weight: 700; color: var(--primary); border-bottom: none; padding-top: 10px; margin-top: 10px; }
    .summary-label { color: var(--text-light); }
    .summary-value { font-weight: 600; }

    .checkout-btn {
      width: 100%; padding: 15px; background-color: var(--primary); color: white; border: none; border-radius: 8px;
      font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s;
      margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .checkout-btn:hover { background-color: var(--primary-dark); }
    .checkout-btn:disabled { background-color: var(--text-light); cursor: not-allowed; }

    .clear-cart-btn {
      width: 100%; padding: 15px; background-color: var(--secondary); color: var(--text); border: none; border-radius: 8px;
      font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .clear-cart-btn:hover { background-color: #e2e8f0; }

    .pre-order-btn {
      padding: 8px 16px; background-color: var(--pre-order); color: white; border: none; border-radius: 6px;
      font-weight: 500; cursor: pointer; transition: background-color 0.3s;
    }
    .pre-order-btn:hover { background-color: #2563eb; }
    .pre-order-btn:disabled { background-color: #94a3b8; cursor: not-allowed; }

    .checkout-preorder-btn {
      padding: 8px 16px; background-color: var(--success); color: white; border: none; border-radius: 6px;
      font-weight: 500; cursor: pointer; transition: background-color 0.3s;
    }
    .checkout-preorder-btn:hover { background-color: #0d9c6c; }

    .cancel-preorder-btn {
      padding: 8px 16px; background-color: var(--danger); color: white; border: none; border-radius: 6px;
      font-weight: 500; cursor: pointer; transition: background-color 0.3s;
    }
    .cancel-preorder-btn:hover { background-color: #dc2626; }

    .toast {
      position: fixed; bottom: 20px; right: 20px; background-color: var(--primary); color: white;
      padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001; display: flex; align-items: center; gap: 10px;
      transform: translateY(100px); opacity: 0; transition: transform 0.3s, opacity 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background-color: var(--success); }
    .toast.error { background-color: var(--danger); }
    .toast.warning { background-color: var(--warning); }

    .checkout-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-content {
      background: white; border-radius: 12px; padding: 30px; width: 650px; max-width: 92%;
      max-height: 85vh; overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }

    .payment-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
    .payment-option {
      border: 2px solid var(--border); border-radius: 8px; padding: 15px; text-align: center;
      cursor: pointer; transition: all 0.3s;
    }
    .payment-option:hover { border-color: var(--primary); }
    .payment-option.selected { border-color: var(--primary); background: rgba(109, 40, 217, 0.05); }
    .payment-option i { font-size: 1.5rem; margin-bottom: 8px; color: var(--primary); }

    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; flex: 1; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--secondary); color: var(--text); }
    .btn-secondary:hover { background: #e2e8f0; }

    .form-section {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin: 10px 0 18px;
      background: #fff;
    }
    .form-section h3 { margin-bottom: 8px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-grid-1 { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .form-field label { display: block; font-weight: 600; margin-top: 6px; }
    .form-field input, .form-field textarea, .form-field select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 6px;
      outline: none;
    }
    .form-field textarea { resize: vertical; min-height: 70px; }
    .form-field input:focus, .form-field textarea:focus, .form-field select:focus { border-color: var(--primary); }

    .inline-hint { color: var(--text-light); font-size: 0.9rem; margin-top: 6px; }

    .card-row { display: flex; gap: 10px; }
    .card-row > div { flex: 1; }

    @media (max-width: 992px) {
      .cart-content { grid-template-columns: 1fr; }
      .cart-summary { position: static; }
      .modal-content { width: 92%; }
    }

    @media (max-width: 768px) {
      .cart-header { flex-direction: column; gap: 20px; text-align: center; }
      .user-info { flex-direction: column; }
      .nav-links { justify-content: center; flex-wrap: wrap; }
      .cart-header-actions { flex-direction: column; gap: 15px; align-items: flex-start; }
      .cart-item { grid-template-columns: 1fr; text-align: center; gap: 10px; }
      .item-actions { justify-content: center; flex-wrap: wrap; }
      .item-checkbox { justify-content: center; }
      .payment-options { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .card-row { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="cart-container">
    <header class="cart-header">
      <a href="Main.html" class="logo">
        <i class="fas fa-book"></i>
        <h1>BookStore</h1>
      </a>

      <div class="user-info">
        <div class="user-welcome">
          Welcome, <span class="username" id="username">Guest</span>
        </div>
        <div class="nav-links">
          <a href="customer_view.html" class="nav-link"><i class="fas fa-book"></i> Browse Books</a>
          <a href="cart.html" class="nav-link active"><i class="fas fa-shopping-cart"></i> Cart (<span id="cart-count">0</span>)</a>
          <a href="preorders.html" class="nav-link"><i class="fas fa-clock"></i> Pre-orders</a>
          <a href="order_history.html" class="nav-link"><i class="fas fa-history"></i> Order History</a>
          <a href="user_profile.html" class="nav-link"><i class="fas fa-user"></i> Profile</a>
          <a href="../Login/Login.html" class="nav-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </header>

    <h1 class="cart-title"><i class="fas fa-shopping-cart"></i> My Shopping Cart</h1>

    <div class="cart-content">
      <div class="cart-items-container">
        <div class="cart-header-actions">
          <div class="select-all">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <label for="selectAll">Select All</label>
          </div>
          <div class="action-buttons">
            <button class="action-btn" onclick="removeSelected()"><i class="fas fa-trash"></i> Remove Selected</button>
            <button class="action-btn" onclick="saveForLater()"><i class="far fa-bookmark"></i> Save for Later</button>
          </div>
        </div>

        <div class="cart-items-scroll" id="cartItemsScroll">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading cart...</p>
          </div>
        </div>
      </div>

      <div class="cart-summary" id="cartSummary">
        <h2 class="summary-header">Order Summary</h2>

        <div class="selected-summary" id="selectedSummary" style="display:none;">
          <div class="summary-title">Selected Items</div>
          <div class="selected-items-list" id="selectedItemsList"></div>
        </div>

        <div class="summary-details">
          <div class="summary-row">
            <span class="summary-label">Subtotal (<span id="selected-count">0</span> items)</span>
            <span class="summary-value" id="subtotal">RM 0.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipping</span>
            <span class="summary-value">RM 5.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Tax (6%)</span>
            <span class="summary-value" id="tax">RM 0.00</span>
          </div>
          <div class="summary-row total">
            <span class="summary-label">Total</span>
            <span class="summary-value" id="total">RM 0.00</span>
          </div>
        </div>

        <button class="checkout-btn" id="checkoutBtn" onclick="processCheckout()" disabled>
          <i class="fas fa-credit-card"></i> Proceed to Checkout
        </button>
        <button class="clear-cart-btn" onclick="clearCart()"><i class="fas fa-trash"></i> Clear Cart</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="checkout-modal" id="checkoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Complete Your Order</h2>
        <button class="close-btn" onclick="closeCheckoutModal()">&times;</button>
      </div>

      <div id="modalContent">
        <div class="loading" id="modalLoading">
          <i class="fas fa-spinner"></i>
          <p>Processing...</p>
        </div>

        <!-- Payment Selection -->
        <div id="paymentSelection" style="display:none;">
          <div class="form-section">
            <h3>Shipping Address</h3>
            <p class="inline-hint">Required for delivery. Please fill in your home shipping details.</p>

            <div class="form-grid">
              <div class="form-field">
                <label for="shipName">Full Name *</label>
                <input type="text" id="shipName" placeholder="e.g., Ganesh Kumar">
              </div>
              <div class="form-field">
                <label for="shipPhone">Phone *</label>
                <input type="text" id="shipPhone" placeholder="e.g., 012-3456789">
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label for="shipEmail">Email *</label>
                <input type="email" id="shipEmail" placeholder="e.g., user@example.com">
              </div>
              <div class="form-field">
                <label for="shipCountry">Country *</label>
                <input type="text" id="shipCountry" placeholder="e.g., Malaysia" value="Malaysia">
              </div>
            </div>

            <div class="form-grid-1">
              <div class="form-field">
                <label for="shipAddress1">Address Line 1 *</label>
                <input type="text" id="shipAddress1" placeholder="House/Unit, Street">
              </div>
              <div class="form-field">
                <label for="shipAddress2">Address Line 2 (Optional)</label>
                <input type="text" id="shipAddress2" placeholder="Apartment, Building, Landmark">
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label for="shipCity">City *</label>
                <input type="text" id="shipCity" placeholder="e.g., Kuala Lumpur">
              </div>
              <div class="form-field">
                <label for="shipState">State *</label>
                <input type="text" id="shipState" placeholder="e.g., Selangor / WP Kuala Lumpur">
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label for="shipPostcode">Postcode *</label>
                <input type="text" id="shipPostcode" placeholder="e.g., 50450">
              </div>
              <div class="form-field">
                <label for="shipNotes">Delivery Notes (Optional)</label>
                <input type="text" id="shipNotes" placeholder="Gate code, call before delivery, etc.">
              </div>
            </div>
          </div>

          <h3>Select Payment Method</h3>
          <div class="payment-options">
            <div class="payment-option" data-method="credit_card" onclick="selectPaymentMethod('credit_card')">
              <i class="fas fa-credit-card"></i>
              <div>Credit Card</div>
            </div>
            <div class="payment-option" data-method="paypal" onclick="selectPaymentMethod('paypal')">
              <i class="fab fa-paypal"></i>
              <div>PayPal</div>
            </div>
            <div class="payment-option" data-method="bank_transfer" onclick="selectPaymentMethod('bank_transfer')">
              <i class="fas fa-university"></i>
              <div>Bank Transfer</div>
            </div>
            <div class="payment-option" data-method="debit_card" onclick="selectPaymentMethod('debit_card')">
              <i class="fas fa-credit-card"></i>
              <div>Debit Card</div>
            </div>
            <div class="payment-option" data-method="cash_on_delivery" onclick="selectPaymentMethod('cash_on_delivery')">
              <i class="fas fa-truck"></i>
              <div>Cash on Delivery</div>
            </div>
          </div>

          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeCheckoutModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmPayment()" id="confirmPaymentBtn" disabled>Continue</button>
          </div>
        </div>

        <!-- Card Details Section -->
        <div id="cardDetailsSection" class="form-section" style="display:none;">
          <h3>Card Details</h3>

          <div class="form-field">
            <label for="cardNumber">Card Number *</label>
            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
          </div>

          <div class="card-row">
            <div class="form-field">
              <label for="cardExpiry">Expiry Date (MM/YY) *</label>
              <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
            </div>
            <div class="form-field">
              <label for="cardCVV">CVV *</label>
              <input type="password" id="cardCVV" placeholder="123" maxlength="4">
            </div>
          </div>

          <div class="form-field">
            <label for="cardName">Cardholder Name *</label>
            <input type="text" id="cardName" placeholder="John Doe">
          </div>

          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="backToPaymentSelection()">Back</button>
            <button class="btn btn-primary" onclick="submitCardDetails()">Confirm Card Details</button>
          </div>
        </div>

        <!-- PayPal Details Section (SAFE SIMULATION) -->
        <div id="paypalDetailsSection" class="form-section" style="display:none;">
          <h3>PayPal Authorization</h3>
          <p class="inline-hint">
            For demo/assignment: we simulate PayPal authorization. Real PayPal login happens on PayPal’s site.
          </p>

          <div class="form-field">
            <label for="paypalEmail">PayPal Email *</label>
            <input type="email" id="paypalEmail" placeholder="user@paypal.com">
          </div>

          <div class="form-field">
            <label for="paypalApprovalCode">Approval Code (Simulated) *</label>
            <input type="text" id="paypalApprovalCode" placeholder="e.g., PP-APPROVED-12345">
          </div>

          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="backToPaymentSelection()">Back</button>
            <button class="btn btn-primary" onclick="submitPaypalAuthorization()">Authorize PayPal</button>
          </div>
        </div>

        <!-- Bank Transfer Section -->
        <div id="bankTransferSection" class="form-section" style="display:none;">
          <h3>Bank Transfer Instructions</h3>
          <p class="inline-hint">
            Please transfer the exact total amount to the bank account below. Use the reference number so we can match your payment.
          </p>

          <div style="background:#f1f5f9; padding:14px; border-radius:10px; margin-top:12px;">
            <div style="margin:6px 0;"><strong>Bank:</strong> Maybank</div>
            <div style="margin:6px 0;"><strong>Account Name:</strong> BookStore Sdn Bhd</div>
            <div style="margin:6px 0;"><strong>Account Number:</strong> 1234567890</div>
            <div style="margin:6px 0;"><strong>Amount:</strong> <span id="bankTransferAmountText">RM 0.00</span></div>
            <div style="margin:6px 0;"><strong>Reference:</strong> <span id="bankTransferRef" style="color:var(--primary); font-weight:700;"></span></div>
          </div>

          <p class="inline-hint" style="margin-top:10px;">
            After you complete the transfer, click “I Have Completed the Transfer”. Your order will be placed and marked as pending verification.
          </p>

          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="backToPaymentSelection()">Back</button>
            <button class="btn btn-primary" onclick="confirmBankTransfer()">I Have Completed the Transfer</button>
          </div>
        </div>

        <!-- Order Confirmation -->
        <div id="orderConfirmation" style="display:none;">
          <div style="text-align:center; padding:20px;">
            <i class="fas fa-check-circle" style="font-size:3rem; color:var(--success); margin-bottom:20px;"></i>
            <h3>Order Confirmed!</h3>
            <p id="confirmationMessage"></p>
            <div style="margin-top:20px;">
              <div><strong>Order ID:</strong> <span id="confirmedOrderId"></span></div>
              <div><strong>Payment ID:</strong> <span id="confirmedPaymentId"></span></div>
              <div><strong>Total Amount:</strong> <span id="confirmedAmount"></span></div>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" onclick="viewOrderHistory()">View Order History</button>
            <button class="btn btn-secondary" onclick="continueShopping()">Continue Shopping</button>
          </div>
        </div>

        <!-- Error Display -->
        <div id="paymentError" style="display:none; text-align:center; padding:20px; color:var(--danger);">
          <i class="fas fa-exclamation-triangle" style="font-size:3rem; margin-bottom:20px;"></i>
          <h3>Checkout Failed</h3>
          <p id="errorMessage"></p>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="retryPayment()">Retry</button>
            <button class="btn btn-primary" onclick="closeCheckoutModal()">Close</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle" id="toast-icon"></i>
    <span id="toast-message">Item added to cart!</span>
  </div>

  <script>
    // APIs
    const CHECK_LOGIN_API = 'check_login.php';
    const GET_CART_API = 'get_cart.php';
    const UPDATE_CART_API = 'update_cart.php';
    const CLEAR_CART_API = 'clear_cart.php';
    const CREATE_ORDER_API = 'create_order.php';
    const CONVERT_TO_PREORDER_API = 'convert_to_preorder.php';
    const PROCESS_PREORDER_API = 'process_preorder.php';

    // DOM
    const cartItemsScroll = document.getElementById('cartItemsScroll');
    const usernameElement = document.getElementById('username');
    const cartCountElement = document.getElementById('cart-count');
    const selectAllCheckbox = document.getElementById('selectAll');

    const selectedSummary = document.getElementById('selectedSummary');
    const selectedItemsList = document.getElementById('selectedItemsList');
    const selectedCountElement = document.getElementById('selected-count');

    const subtotalElement = document.getElementById('subtotal');
    const taxElement = document.getElementById('tax');
    const totalElement = document.getElementById('total');
    const checkoutBtn = document.getElementById('checkoutBtn');

    const checkoutModal = document.getElementById('checkoutModal');
    const modalLoading = document.getElementById('modalLoading');
    const paymentSelection = document.getElementById('paymentSelection');
    const cardDetailsSection = document.getElementById('cardDetailsSection');
    const paypalDetailsSection = document.getElementById('paypalDetailsSection');
    const bankTransferSection = document.getElementById('bankTransferSection');
    const bankTransferRefEl = document.getElementById('bankTransferRef');
    const bankTransferAmountText = document.getElementById('bankTransferAmountText');

    const orderConfirmation = document.getElementById('orderConfirmation');
    const paymentError = document.getElementById('paymentError');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');

    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    // Shipping fields
    const shipName = document.getElementById('shipName');
    const shipPhone = document.getElementById('shipPhone');
    const shipEmail = document.getElementById('shipEmail');
    const shipCountry = document.getElementById('shipCountry');
    const shipAddress1 = document.getElementById('shipAddress1');
    const shipAddress2 = document.getElementById('shipAddress2');
    const shipCity = document.getElementById('shipCity');
    const shipState = document.getElementById('shipState');
    const shipPostcode = document.getElementById('shipPostcode');
    const shipNotes = document.getElementById('shipNotes');

    // Card fields
    const cardNumber = document.getElementById('cardNumber');
    const cardExpiry = document.getElementById('cardExpiry');
    const cardCVV = document.getElementById('cardCVV');
    const cardName = document.getElementById('cardName');

    // PayPal fields
    const paypalEmail = document.getElementById('paypalEmail');
    const paypalApprovalCode = document.getElementById('paypalApprovalCode');

    // State
    let cartData = null;
    let currentUser = null;

    let selectedItems = new Set();
    let selectedItemsData = new Map();

    let selectedPaymentMethod = null;
    let currentShipping = null;

    window.cardValidated = false;
    window.paypalAuthorized = false;

    window.bankTransferConfirmed = false;
    let bankTransferReference = '';

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      checkLoginStatus();

      document.addEventListener('change', (e) => {
        if (e.target && e.target.type === 'checkbox' && e.target.classList.contains('item-checkbox')) {
          updateSelectedItems(e.target);
        }
      });
    });

    async function checkLoginStatus() {
      try {
        const response = await fetch(CHECK_LOGIN_API, { credentials: 'include' });
        const data = await response.json();

        if (data.logged_in) {
          currentUser = data;
          usernameElement.textContent = data.username || data.first_name || 'User';
          await loadCart();
          prefillShippingFromUser();
        } else {
          usernameElement.textContent = 'Guest';
          showToast('Please login to view cart', 'error');
          redirectToLogin();
        }
      } catch (error) {
        console.error('Error checking login status:', error);
        showToast('Error loading user info', 'error');
        displayEmptyCart();
      }
    }

    function prefillShippingFromUser() {
      if (!currentUser) return;
      if (currentUser.first_name && !shipName.value) shipName.value = currentUser.first_name;
      if (currentUser.phone && !shipPhone.value) shipPhone.value = currentUser.phone;
      if (currentUser.email && !shipEmail.value) shipEmail.value = currentUser.email;
      if (currentUser.address && !shipAddress1.value) shipAddress1.value = currentUser.address;
    }

    async function loadCart() {
      try {
        const response = await fetch(GET_CART_API, { credentials: 'include' });

        if (response.status === 401) {
          showToast('Please login to view cart', 'error');
          redirectToLogin();
          return;
        }

        const data = await response.json();

        if (data.success) {
          cartData = data;
          displayCartItems();
          updateCartCount();
        } else {
          showToast(data.error || 'Failed to load cart', 'error');
          displayEmptyCart();
        }
      } catch (error) {
        console.error('Error loading cart:', error);
        showToast('Error loading cart. Please try again.', 'error');
        displayEmptyCart();
      }
    }

    function displayCartItems() {
      if (!cartData || !cartData.cart_items || cartData.cart_items.length === 0) {
        displayEmptyCart();
        return;
      }

      let html = '';

      cartData.cart_items.forEach(item => {
        const subtotal = (item.price * item.quantity).toFixed(2);
        const isPreOrder = item.is_pre_order == 1;
        const stockStatus = getStockStatus(item.stock_quantity, isPreOrder, item.pre_order_status);

        const canSelect = !isPreOrder && item.stock_quantity > 0;
        const isPreOrderAvailable = isPreOrder && item.pre_order_status === 'available';

        html += `
          <div class="cart-item" data-cart-id="${item.cart_id}" data-book-id="${item.book_id}" data-is-preorder="${isPreOrder ? '1' : '0'}">
            <div class="item-checkbox">
              <input
                type="checkbox"
                class="item-checkbox"
                data-cart-id="${item.cart_id}"
                data-book-id="${item.book_id}"
                data-title="${escapeHtml(item.title)}"
                data-price="${item.price}"
                data-quantity="${item.quantity}"
                ${selectedItems.has(parseInt(item.cart_id)) ? 'checked' : ''}
                ${!canSelect ? 'disabled' : ''}
              >
            </div>

            <div class="item-image" onclick="viewBookDetail(${item.book_id})">
              <i class="fas fa-book-open"></i>
            </div>

            <div class="item-details">
              <h3 class="item-title" onclick="viewBookDetail(${item.book_id})">
                ${escapeHtml(item.title)}
                ${isPreOrder ? '<span class="pre-order-badge">PRE-ORDER</span>' : ''}
                ${isPreOrderAvailable ? '<span class="available-badge">AVAILABLE</span>' : ''}
              </h3>
              <p class="item-author">by ${escapeHtml(item.author || 'Unknown Author')}</p>
              <span class="item-category">${escapeHtml(item.category_name || 'Uncategorized')}</span>
              <div class="item-price">RM ${parseFloat(item.price).toFixed(2)} each</div>

              <div class="item-stock ${stockStatus.class}">
                ${stockStatus.text}
                ${item.expected_date ? `<br><small>Expected: ${escapeHtml(item.expected_date)}</small>` : ''}
              </div>
            </div>

            <div class="item-actions">
              ${
                isPreOrder
                  ? (
                      isPreOrderAvailable
                        ? `
                          <button class="checkout-preorder-btn" onclick="processAvailablePreorder(${item.cart_id})">
                            <i class="fas fa-check"></i> Checkout Now
                          </button>
                          <button class="cancel-preorder-btn" onclick="cancelPreorder(${item.cart_id})">
                            <i class="fas fa-times"></i> Cancel
                          </button>
                        `
                        : `
                          <button class="cancel-preorder-btn" onclick="cancelPreorder(${item.cart_id})">
                            <i class="fas fa-times"></i> Cancel Pre-order
                          </button>
                        `
                    )
                  : `
                    <div class="quantity-control">
                      <button class="quantity-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity - 1})" ${item.stock_quantity <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-minus"></i>
                      </button>

                      <input
                        type="number"
                        class="quantity-input"
                        value="${item.quantity}"
                        min="1"
                        max="${Math.max(item.stock_quantity, item.quantity)}"
                        onchange="updateQuantity(${item.cart_id}, this.value)"
                        ${item.stock_quantity <= 0 ? 'disabled' : ''}
                      >

                      <button class="quantity-btn" onclick="updateQuantity(${item.cart_id}, ${item.quantity + 1})" ${item.stock_quantity <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>

                    ${
                      item.stock_quantity <= 0 && item.pre_order_available == 1
                        ? `
                          <button class="pre-order-btn" onclick="convertToPreorder(${item.cart_id})">
                            <i class="fas fa-clock"></i> Convert to Pre-order
                          </button>
                        `
                        : (item.stock_quantity <= 0 ? `<span style="color: var(--danger); font-size: 0.9rem;">Out of Stock</span>` : ``)
                    }
                  `
              }

              <button class="remove-btn" onclick="removeFromCart(${item.cart_id})">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>

            <div class="item-total">RM ${subtotal}</div>
          </div>
        `;
      });

      cartItemsScroll.innerHTML = html;
      updateSelectedSummary();
      updateSummary();
    }

    function getStockStatus(stockQuantity, isPreOrder = false, preOrderStatus = 'pending') {
      if (isPreOrder) {
        if (preOrderStatus === 'available') return { class: 'in-stock', text: 'Pre-Order Available for Checkout' };
        return { class: 'pre-order-stock', text: 'Pre-Order Item' };
      }
      if (stockQuantity <= 0) return { class: 'out-of-stock', text: 'Out of Stock' };
      if (stockQuantity < 10) return { class: 'low-stock', text: `Low Stock (${stockQuantity} left)` };
      return { class: 'in-stock', text: 'In Stock' };
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function displayEmptyCart() {
      cartItemsScroll.innerHTML = `
        <div class="empty-cart">
          <i class="fas fa-shopping-cart"></i>
          <h3>Your cart is empty</h3>
          <p>Looks like you haven't added any books to your cart yet.</p>
          <a href="customer_view.html" class="continue-shopping">
            <i class="fas fa-book"></i> Continue Shopping
          </a>
        </div>
      `;
      selectedSummary.style.display = 'none';
      checkoutBtn.disabled = true;
      cartCountElement.textContent = '0';
      selectedItems.clear();
      selectedItemsData.clear();
      selectAllCheckbox.checked = false;
      updateSummary();
    }

    function updateCartCount() {
      if (cartData && cartData.total_items != null) cartCountElement.textContent = cartData.total_items;
    }

    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.item-checkbox:not(:disabled)');
      const selectAll = selectAllCheckbox.checked;

      selectedItems.clear();
      selectedItemsData.clear();

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll) {
          const cartId = parseInt(checkbox.dataset.cartId);
          const title = checkbox.dataset.title;
          const price = parseFloat(checkbox.dataset.price);
          const quantity = parseInt(checkbox.dataset.quantity);

          selectedItems.add(cartId);
          selectedItemsData.set(cartId, { title, price, quantity, subtotal: price * quantity });
        }
      });

      updateSelectedSummary();
      updateSummary();
    }

    function updateSelectedItems(checkbox) {
      if (checkbox.disabled) return;

      const cartId = parseInt(checkbox.dataset.cartId);
      const title = checkbox.dataset.title;
      const price = parseFloat(checkbox.dataset.price);
      const quantity = parseInt(checkbox.dataset.quantity);

      if (checkbox.checked) {
        selectedItems.add(cartId);
        selectedItemsData.set(cartId, { title, price, quantity, subtotal: price * quantity });
      } else {
        selectedItems.delete(cartId);
        selectedItemsData.delete(cartId);
        selectAllCheckbox.checked = false;
      }

      updateSelectedSummary();
      updateSummary();
    }

    function updateSelectedSummary() {
      if (selectedItems.size === 0) {
        selectedSummary.style.display = 'none';
        checkoutBtn.disabled = true;
        selectedCountElement.textContent = '0';
        return;
      }

      selectedSummary.style.display = 'block';
      checkoutBtn.disabled = false;

      let html = '';
      selectedItemsData.forEach((item) => {
        html += `
          <div class="selected-item">
            <div class="selected-item-name">${escapeHtml(item.title)}</div>
            <div class="selected-item-price">RM ${item.price.toFixed(2)} × ${item.quantity}</div>
          </div>
        `;
      });

      selectedItemsList.innerHTML = html;
      selectedCountElement.textContent = selectedItems.size;
    }

    function updateSummary() {
      if (selectedItems.size === 0) {
        subtotalElement.textContent = 'RM 0.00';
        taxElement.textContent = 'RM 0.00';
        totalElement.textContent = 'RM 0.00';
        return;
      }

      let subtotal = 0;
      selectedItemsData.forEach(item => subtotal += item.subtotal);

      const shipping = 5.00;
      const tax = subtotal * 0.06;
      const total = subtotal + shipping + tax;

      subtotalElement.textContent = `RM ${subtotal.toFixed(2)}`;
      taxElement.textContent = `RM ${tax.toFixed(2)}`;
      totalElement.textContent = `RM ${total.toFixed(2)}`;
    }

    async function updateQuantity(cartId, newQuantity) {
      newQuantity = parseInt(newQuantity);
      if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1;

      try {
        const response = await fetch(UPDATE_CART_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart_id: cartId, quantity: newQuantity, action: 'update' })
        });

        const data = await response.json();
        if (data.success) {
          showToast('Quantity updated successfully', 'success');
          await loadCart();
        } else {
          showToast(data.error || 'Failed to update quantity', 'error');
        }
      } catch (error) {
        console.error('Error updating quantity:', error);
        showToast('Error updating quantity. Please try again.', 'error');
      }
    }

    async function removeFromCart(cartId) {
      if (!confirm('Are you sure you want to remove this item from your cart?')) return;

      try {
        const response = await fetch(UPDATE_CART_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart_id: cartId, action: 'remove' })
        });

        const data = await response.json();
        if (data.success) {
          showToast('Item removed from cart', 'success');
          selectedItems.delete(cartId);
          selectedItemsData.delete(cartId);
          await loadCart();
        } else {
          showToast(data.error || 'Failed to remove item', 'error');
        }
      } catch (error) {
        console.error('Error removing item:', error);
        showToast('Error removing item. Please try again.', 'error');
      }
    }

    async function removeSelected() {
      if (selectedItems.size === 0) {
        showToast('Please select items to remove', 'warning');
        return;
      }

      if (!confirm(`Are you sure you want to remove ${selectedItems.size} selected item(s) from your cart?`)) return;

      try {
        const cartIds = Array.from(selectedItems);
        const response = await fetch(UPDATE_CART_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart_ids: cartIds, action: 'bulk_remove' })
        });

        const data = await response.json();
        if (data.success) {
          showToast(`${selectedItems.size} item(s) removed from cart`, 'success');
          selectedItems.clear();
          selectedItemsData.clear();
          selectAllCheckbox.checked = false;
          await loadCart();
        } else {
          showToast(data.error || 'Failed to remove selected items', 'error');
        }
      } catch (error) {
        console.error('Error removing selected items:', error);
        showToast('Error removing items. Please try again.', 'error');
      }
    }

    async function saveForLater() {
      if (selectedItems.size === 0) {
        showToast('Please select items to save for later', 'warning');
        return;
      }
      showToast(`${selectedItems.size} item(s) saved for later`, 'success');
      await removeSelected();
    }

    async function clearCart() {
      if (!cartData || !cartData.cart_items || cartData.cart_items.length === 0) {
        showToast('Your cart is already empty', 'warning');
        return;
      }
      if (!confirm('Are you sure you want to clear your entire cart?')) return;

      try {
        const response = await fetch(CLEAR_CART_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({})
        });

        const data = await response.json();
        if (data.success) {
          showToast('Cart cleared successfully', 'success');
          selectedItems.clear();
          selectedItemsData.clear();
          selectAllCheckbox.checked = false;
          await loadCart();
        } else {
          showToast(data.error || 'Failed to clear cart', 'error');
        }
      } catch (error) {
        console.error('Error clearing cart:', error);
        showToast('Error clearing cart. Please try again.', 'error');
      }
    }

    async function convertToPreorder(cartId) {
      if (!confirm('This item is out of stock. Would you like to convert it to a pre-order?')) return;

      try {
        const response = await fetch(CONVERT_TO_PREORDER_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart_id: cartId, action: 'convert' })
        });

        const data = await response.json();
        if (data.success) {
          showToast('Item converted to pre-order', 'success');
          await loadCart();
        } else {
          showToast(data.error || 'Failed to convert to pre-order', 'error');
        }
      } catch (error) {
        console.error('Error converting to pre-order:', error);
        showToast('Error converting to pre-order. Please try again.', 'error');
      }
    }

    async function processAvailablePreorder(cartId) {
      if (!confirm('This pre-order is now available. Would you like to process it now?')) return;

      try {
        const response = await fetch(PROCESS_PREORDER_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart_id: cartId, action: 'process' })
        });

        const data = await response.json();
        if (data.success) {
          showToast('Pre-order processed successfully.', 'success');
          await loadCart();
        } else {
          showToast(data.error || 'Failed to process pre-order', 'error');
        }
      } catch (error) {
        console.error('Error processing pre-order:', error);
        showToast('Error processing pre-order. Please try again.', 'error');
      }
    }

    async function cancelPreorder(cartId) {
      if (!confirm('Are you sure you want to cancel this pre-order?')) return;

      try {
        const response = await fetch(CONVERT_TO_PREORDER_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart_id: cartId, action: 'cancel' })
        });

        const data = await response.json();
        if (data.success) {
          showToast('Pre-order cancelled', 'success');
          await loadCart();
        } else {
          showToast(data.error || 'Failed to cancel pre-order', 'error');
        }
      } catch (error) {
        console.error('Error cancelling pre-order:', error);
        showToast('Error cancelling pre-order. Please try again.', 'error');
      }
    }

    // Checkout
    async function processCheckout() {
      if (selectedItems.size === 0) {
        showToast('Please select items to checkout', 'warning');
        return;
      }

      const hasPreOrderItems = Array.from(selectedItems).some(cartId => {
        const item = document.querySelector(`[data-cart-id="${cartId}"]`);
        return item && item.dataset.isPreorder === '1';
      });

      if (hasPreOrderItems) {
        showToast('Pre-order items cannot be checked out with regular items.', 'error');
        return;
      }

      for (const [cartId, item] of selectedItemsData) {
        const cartItem = document.querySelector(`[data-cart-id="${cartId}"]`);
        if (!cartItem) continue;
        const quantityInput = cartItem.querySelector('.quantity-input');
        if (!quantityInput) continue;
        const maxQuantity = parseInt(quantityInput.max);
        if (item.quantity > maxQuantity && maxQuantity > 0) {
          showToast(`Insufficient stock for "${item.title}". Only ${maxQuantity} available.`, 'error');
          return;
        }
      }

      showCheckoutModal();
    }

    function showCheckoutModal() {
      checkoutModal.style.display = 'flex';

      modalLoading.style.display = 'block';
      paymentSelection.style.display = 'none';
      cardDetailsSection.style.display = 'none';
      paypalDetailsSection.style.display = 'none';
      bankTransferSection.style.display = 'none';
      orderConfirmation.style.display = 'none';
      paymentError.style.display = 'none';

      selectedPaymentMethod = null;
      currentShipping = null;

      window.cardValidated = false;
      window.paypalAuthorized = false;
      window.bankTransferConfirmed = false;
      bankTransferReference = '';

      document.querySelectorAll('.payment-option').forEach(option => option.classList.remove('selected'));
      confirmPaymentBtn.disabled = true;

      setTimeout(() => {
        modalLoading.style.display = 'none';
        paymentSelection.style.display = 'block';
      }, 300);
    }

    function closeCheckoutModal() {
      checkoutModal.style.display = 'none';
    }

    function retryPayment() {
      paymentError.style.display = 'none';
      cardDetailsSection.style.display = 'none';
      paypalDetailsSection.style.display = 'none';
      bankTransferSection.style.display = 'none';
      paymentSelection.style.display = 'block';
      window.cardValidated = false;
      window.paypalAuthorized = false;
      window.bankTransferConfirmed = false;
      bankTransferReference = '';
    }

    function backToPaymentSelection() {
      cardDetailsSection.style.display = 'none';
      paypalDetailsSection.style.display = 'none';
      bankTransferSection.style.display = 'none';
      paymentSelection.style.display = 'block';

      window.cardValidated = false;
      window.paypalAuthorized = false;
      window.bankTransferConfirmed = false;
      bankTransferReference = '';
    }

    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;

      cardDetailsSection.style.display = 'none';
      paypalDetailsSection.style.display = 'none';
      bankTransferSection.style.display = 'none';

      window.cardValidated = false;
      window.paypalAuthorized = false;
      window.bankTransferConfirmed = false;
      bankTransferReference = '';

      document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
      document.querySelector(`.payment-option[data-method="${method}"]`)?.classList.add('selected');

      confirmPaymentBtn.disabled = false;
    }

    function collectAndValidateShipping() {
      const data = {
        name: shipName.value.trim(),
        phone: shipPhone.value.trim(),
        email: shipEmail.value.trim(),
        country: shipCountry.value.trim(),
        address1: shipAddress1.value.trim(),
        address2: shipAddress2.value.trim(),
        city: shipCity.value.trim(),
        state: shipState.value.trim(),
        postcode: shipPostcode.value.trim(),
        notes: shipNotes.value.trim(),
      };

      const required = [
        ['Full Name', data.name],
        ['Phone', data.phone],
        ['Email', data.email],
        ['Country', data.country],
        ['Address Line 1', data.address1],
        ['City', data.city],
        ['State', data.state],
        ['Postcode', data.postcode],
      ];

      for (const [label, value] of required) {
        if (!value) {
          showToast(`Please fill in: ${label}`, 'error');
          return null;
        }
      }

      if (!data.email.includes('@')) {
        showToast('Please enter a valid email', 'error');
        return null;
      }

      return data;
    }

    function generateBankTransferReference() {
      // Simple reference for demo: BT-YYYYMMDD-<random>
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const rand = Math.floor(100000 + Math.random() * 900000);
      return `BT-${yyyy}${mm}${dd}-${rand}`;
    }

    function confirmBankTransfer() {
      // User confirms they completed transfer
      window.bankTransferConfirmed = true;
      bankTransferSection.style.display = 'none';
      confirmPayment(); // continue to order create
    }

    async function confirmPayment() {
      if (!selectedPaymentMethod) {
        showToast('Please select a payment method', 'error');
        return;
      }

      // Always validate shipping first
      const shipping = collectAndValidateShipping();
      if (!shipping) return;
      currentShipping = shipping;

      // Card methods
      if ((selectedPaymentMethod === 'credit_card' || selectedPaymentMethod === 'debit_card') && !window.cardValidated) {
        paymentSelection.style.display = 'none';
        cardDetailsSection.style.display = 'block';
        return;
      }

      // PayPal (safe simulation)
      if (selectedPaymentMethod === 'paypal' && !window.paypalAuthorized) {
        paymentSelection.style.display = 'none';
        paypalDetailsSection.style.display = 'block';
        return;
      }

      // Bank transfer instructions step
      if (selectedPaymentMethod === 'bank_transfer' && !window.bankTransferConfirmed) {
        paymentSelection.style.display = 'none';
        bankTransferSection.style.display = 'block';

        if (!bankTransferReference) bankTransferReference = generateBankTransferReference();
        bankTransferRefEl.textContent = bankTransferReference;

        // Show amount
        bankTransferAmountText.textContent = totalElement.textContent || 'RM 0.00';
        return;
      }

      // Create order
      try {
        modalLoading.style.display = 'block';
        paymentSelection.style.display = 'none';
        cardDetailsSection.style.display = 'none';
        paypalDetailsSection.style.display = 'none';
        bankTransferSection.style.display = 'none';
        orderConfirmation.style.display = 'none';
        paymentError.style.display = 'none';

        const payload = {
          cart_ids: Array.from(selectedItems),
          customer_id: (currentUser && (currentUser.user_id || currentUser.auto_id)) ? (currentUser.user_id || currentUser.auto_id) : 1,
          payment_method: selectedPaymentMethod,
          total_amount: parseFloat((totalElement.textContent || 'RM 0.00').replace('RM ', '')),

          shipping_address: formatShippingAddress(currentShipping),
          contact_phone: currentShipping.phone,
          contact_email: currentShipping.email,

          shipping_name: currentShipping.name,
          shipping_notes: currentShipping.notes || '',

          paypal_email: selectedPaymentMethod === 'paypal' ? (paypalEmail.value.trim() || '') : '',
          paypal_approval_code: selectedPaymentMethod === 'paypal' ? (paypalApprovalCode.value.trim() || '') : '',

          bank_transfer_reference: selectedPaymentMethod === 'bank_transfer' ? (bankTransferReference || '') : ''
        };

        const orderResponse = await fetch(CREATE_ORDER_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        const rawText = await orderResponse.text();
        let orderData;
        try {
          orderData = JSON.parse(rawText);
        } catch (e) {
          console.error('Invalid JSON from create_order.php:', rawText);
          throw new Error('Server returned invalid JSON (create_order.php). Check PHP output/errors.');
        }

        if (!orderData.success) throw new Error(orderData.error || 'Failed to create order');

        modalLoading.style.display = 'none';
        orderConfirmation.style.display = 'block';

        document.getElementById('confirmedOrderId').textContent = orderData.order_id ?? '';
        document.getElementById('confirmedPaymentId').textContent = orderData.payment_id ?? '';
        document.getElementById('confirmedAmount').textContent = 'RM ' + parseFloat(orderData.total_amount ?? 0).toFixed(2);

        // Better messaging by payment type
        let extraMsg = '';
        if (selectedPaymentMethod === 'bank_transfer') {
          extraMsg =
            `\nBank Transfer Reference: ${bankTransferReference}` +
            `\nStatus: Pending Verification (we will verify your transfer).`;
        } else if (selectedPaymentMethod === 'cash_on_delivery') {
          extraMsg = `\nStatus: Pay on Delivery (COD).`;
        } else {
          extraMsg = `\nStatus: Payment Processed.`;
        }

        document.getElementById('confirmationMessage').textContent =
          `Thank you for your order!` +
          `\nPayment Method: ${selectedPaymentMethod}` +
          extraMsg +
          `\nShipping To: ${currentShipping.name}, ${currentShipping.city}` +
          (orderData.transaction_id ? `\nTransaction ID: ${orderData.transaction_id}` : '');

        // Clear selection + reload cart
        selectedItems.clear();
        selectedItemsData.clear();
        selectAllCheckbox.checked = false;
        await loadCart();

      } catch (error) {
        console.error('Checkout Error:', error);
        modalLoading.style.display = 'none';
        paymentSelection.style.display = 'none';
        cardDetailsSection.style.display = 'none';
        paypalDetailsSection.style.display = 'none';
        bankTransferSection.style.display = 'none';
        paymentError.style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message || 'Checkout failed';
      }
    }

    function formatShippingAddress(s) {
      const parts = [
        s.name,
        s.phone,
        s.address1,
        s.address2,
        `${s.postcode} ${s.city}`,
        s.state,
        s.country
      ].filter(Boolean);
      return parts.join(', ');
    }

    function submitCardDetails() {
      const number = (cardNumber.value || '').trim();
      const expiry = (cardExpiry.value || '').trim();
      const cvv = (cardCVV.value || '').trim();
      const name = (cardName.value || '').trim();

      if (!number || !expiry || !cvv || !name) {
        showToast('Please fill in all card details', 'error');
        return;
      }

      if (number.replace(/\s/g, '').length < 16) {
        showToast('Invalid card number', 'error');
        return;
      }

      if (!/^\d{2}\/\d{2}$/.test(expiry)) {
        showToast('Invalid expiry date (MM/YY)', 'error');
        return;
      }

      if (cvv.length < 3) {
        showToast('Invalid CVV', 'error');
        return;
      }

      window.cardValidated = true;
      cardDetailsSection.style.display = 'none';
      confirmPayment();
    }

    function submitPaypalAuthorization() {
      const email = (paypalEmail.value || '').trim();
      const code = (paypalApprovalCode.value || '').trim();

      if (!email || !code) {
        showToast('Please enter PayPal email and approval code', 'error');
        return;
      }

      if (!email.includes('@')) {
        showToast('Invalid PayPal email', 'error');
        return;
      }

      if (code.length < 6) {
        showToast('Approval code is too short', 'error');
        return;
      }

      window.paypalAuthorized = true;
      paypalDetailsSection.style.display = 'none';
      confirmPayment();
    }

    function viewOrderHistory() {
      closeCheckoutModal();
      window.location.href = 'order_history.html';
    }

    function continueShopping() {
      closeCheckoutModal();
      window.location.href = 'customer_view.html';
    }

    function viewBookDetail(bookId) {
      window.open(`get_book_detail.html?book_id=${bookId}`, '_blank');
    }

    function redirectToLogin() {
      setTimeout(() => {
        window.location.href = '../Login/Login.html?redirect=cart';
      }, 1200);
    }

    function showToast(message, type = 'success') {
      toastMessage.textContent = message;

      if (type === 'success') toastIcon.className = 'fas fa-check-circle';
      else if (type === 'error') toastIcon.className = 'fas fa-exclamation-circle';
      else toastIcon.className = 'fas fa-exclamation-triangle';

      toast.className = `toast ${type}`;
      toast.classList.add('show');

      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
