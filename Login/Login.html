<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Login & Registration - Virtual BookStore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }
        
        .form-container {
            padding: 40px;
        }
        
        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus {
            border-color: #2575fc;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 117, 252, 0.1);
        }
        
        .password-container {
            position: relative;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #777;
            font-size: 18px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggle-password:hover {
            color: #2575fc;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 117, 252, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .switch-form {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .switch-form a {
            color: #2575fc;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .switch-form a:hover {
            color: #6a11cb;
            text-decoration: underline;
        }
        
        .hidden {
            display: none !important;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .back-button {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #2575fc;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .back-button:hover {
            color: #6a11cb;
            text-decoration: underline;
        }
        
        .validation-message {
            margin-top: 5px;
            font-size: 13px;
            display: none;
        }
        
        .validation-message.show {
            display: block;
        }
        
        .valid {
            color: #28a745;
        }
        
        .invalid {
            color: #dc3545;
        }
        
        .password-strength {
            margin-top: 10px;
            height: 5px;
            border-radius: 3px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .password-strength-meter {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        
        .password-strength-text {
            font-size: 12px;
            margin-top: 5px;
            text-align: right;
        }
        
        .username-status {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        
        .loading {
            color: #6c757d;
        }
        
        .available {
            color: #28a745;
        }
        
        .taken {
            color: #dc3545;
        }
        
        input.valid-border {
            border-color: #28a745;
        }
        
        input.invalid-border {
            border-color: #dc3545;
        }
        
        .validation-list {
            margin-top: 5px;
            font-size: 13px;
            list-style: none;
            padding-left: 0;
        }
        
        .validation-list li {
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .validation-list .valid::before {
            content: '‚úì';
            color: #28a745;
        }
        
        .validation-list .invalid::before {
            content: '‚úó';
            color: #dc3545;
        }
        
        .login-options {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .forgot-password {
            color: #2575fc;
            text-decoration: none;
        }
        
        .forgot-password:hover {
            text-decoration: underline;
        }
        
        .form-note {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .required {
            color: #dc3545;
        }
        
        .resend-timer {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        
        .resend-timer a {
            color: #2575fc;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }
        
        .resend-timer a:hover {
            text-decoration: underline;
        }
        
        .resend-timer .disabled {
            color: #999;
            cursor: not-allowed;
            text-decoration: none;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e9ecef;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 5px;
            border: 2px solid #e9ecef;
        }
        
        .step.active .step-number {
            background-color: #2575fc;
            color: white;
            border-color: #2575fc;
        }
        
        .step.completed .step-number {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .step-label {
            font-size: 12px;
            color: #666;
        }
        
        .step.active .step-label {
            color: #2575fc;
            font-weight: 600;
        }
        
        .verification-inputs {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .verification-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            border: 2px solid #ddd;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .verification-input:focus {
            border-color: #2575fc;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 117, 252, 0.1);
        }
        
        .verification-input.filled {
            border-color: #28a745;
        }
        
        .verification-instruction {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }
        
        .modal-header h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .modal-header .close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-header .close-btn:hover {
            background-color: #f8f9fa;
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .verification-code-display {
            background-color: #f8f9fa;
            border: 2px dashed #2575fc;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .verification-code-display .code {
            font-size: 32px;
            font-weight: bold;
            color: #2575fc;
            letter-spacing: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .modal-instruction {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-instruction code {
            background-color: #f8f9fa;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            color: #2575fc;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .modal-btn.primary {
            background-color: #2575fc;
            color: white;
        }
        
        .modal-btn.primary:hover {
            background-color: #1c6ae4;
        }
        
        .modal-btn.secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .modal-btn.secondary:hover {
            background-color: #5a6268;
        }
        
        .auto-verify-notice {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4fd;
            border: 1px solid #b6d4fe;
            border-radius: 5px;
            font-size: 14px;
            color: #084298;
            text-align: center;
            display: none;
        }
        
        .auto-verify-notice.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .form-container {
                padding: 30px 20px;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .container {
                max-width: 100%;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
        }
        
        @media (max-width: 480px) {
            .login-options {
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
            }
            
            .password-container .username-status {
                right: 50px;
            }
            
            .verification-inputs {
                gap: 5px;
            }
            
            .verification-input {
                width: 40px;
                height: 50px;
                font-size: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .step-label {
                font-size: 11px;
            }
        }
        
        .verification-success {
            animation: successPulse 2s infinite;
        }
        
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        .code-copied-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .code-copied-message.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <!-- Login Form -->
            <div id="login-form">
                <h2>User Login</h2>
                <div id="login-message" class="message hidden"></div>
                <form id="loginForm" action="Login.php" method="POST" onsubmit="return handleLoginSubmit(event)">
                    <div class="form-group">
                        <label for="login-username">Username <span class="required">*</span></label>
                        <input type="text" id="login-username" name="username" required 
                               placeholder="Enter your username" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password <span class="required">*</span></label>
                        <div class="password-container">
                            <input type="password" id="login-password" name="password" required 
                                   placeholder="Enter your password" autocomplete="current-password">
                            <button type="button" class="toggle-password" id="toggle-login-password" onclick="togglePassword('login-password', this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="login-options">
                        <a href="#" class="forgot-password" id="show-forgot-password">Forgot Password?</a>
                    </div>
                    
                    <button type="submit" class="btn" id="login-btn">Login</button>
                </form>
                <div class="switch-form">
                    Don't have an account? <a id="show-register">Register Now</a>
                </div>
                <a href="../System/Main.html" class="back-button">‚Üê Back to Main Page</a>
            </div>
            
            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <h2>User Registration</h2>
                <div id="register-message" class="message hidden"></div>
                <form id="registerForm" action="Register.php" method="POST" onsubmit="return handleRegisterSubmit(event)">
                    <div class="form-group">
                        <label for="register-username">Username <span class="required">*</span></label>
                        <div class="password-container">
                            <input type="text" id="register-username" name="username" required 
                                   placeholder="Enter username (3-50 characters)" autocomplete="off"
                                   oninput="checkUsernameAvailability(this.value)">
                            <span id="username-status" class="username-status"></span>
                            <button type="button" class="toggle-password" style="display: none;"></button>
                        </div>
                        <div id="username-validation" class="validation-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-email">Email <span class="required">*</span></label>
                        <input type="email" id="register-email" name="email" required 
                               placeholder="Enter your email" autocomplete="email"
                               oninput="checkEmailFormat()">
                        <div id="email-validation" class="validation-message"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password">Password <span class="required">*</span></label>
                        <div class="password-container">
                            <input type="password" id="register-password" name="password" required 
                                   placeholder="Enter password" autocomplete="new-password"
                                   oninput="checkPasswordStrength()">
                            <button type="button" class="toggle-password" id="toggle-register-password" onclick="togglePassword('register-password', this)">üëÅÔ∏è</button>
                        </div>
                        <div class="password-strength">
                            <div id="password-strength-meter" class="password-strength-meter"></div>
                        </div>
                        <div id="password-strength-text" class="password-strength-text"></div>
                        <div id="password-validation" class="validation-message"></div>
                        <ul id="password-rules" class="validation-list">
                            <li id="rule-length" class="invalid">At least 8 characters</li>
                            <li id="rule-uppercase" class="invalid">Contains uppercase letter</li>
                            <li id="rule-lowercase" class="invalid">Contains lowercase letter</li>
                            <li id="rule-number" class="invalid">Contains number</li>
                            <li id="rule-special" class="invalid">Contains special character (@#$%&!)</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">Confirm Password <span class="required">*</span></label>
                        <div class="password-container">
                            <input type="password" id="register-confirm-password" name="confirm_password" required 
                                   placeholder="Confirm password" autocomplete="new-password"
                                   oninput="checkConfirmPassword()">
                            <button type="button" class="toggle-password" id="toggle-confirm-password" onclick="togglePassword('register-confirm-password', this)">üëÅÔ∏è</button>
                        </div>
                        <div id="confirm-validation" class="validation-message"></div>
                    </div>
                    
                    <div class="form-note">
                        By registering, you agree to our Terms of Service and Privacy Policy.
                    </div>
                    
                    <button type="submit" class="btn" id="register-btn" disabled>Create Account</button>
                </form>
                <div class="switch-form">
                    Already have an account? <a id="show-login">Login Now</a>
                </div>
                <a href="../System/Main.html" class="back-button">‚Üê Back to Main Page</a>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgot-password-form" class="hidden">
                <h2>Reset Password</h2>
                <div id="forgot-message" class="message hidden"></div>
                
                <!-- Step 1: Enter Email -->
                <div id="step-1">
                    <div class="step-indicator">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <div class="step-label">Enter Email</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-label">Verify Code</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-label">New Password</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="forgot-email">Email Address <span class="required">*</span></label>
                        <input type="email" id="forgot-email" name="email" required 
                               placeholder="Enter your registered email" autocomplete="email">
                    </div>
                    
                    <button type="button" class="btn" id="send-code-btn" onclick="sendVerificationCode()">Send Verification Code</button>
                    <div class="resend-timer hidden" id="resend-timer">
                        Didn't receive the code? <a id="resend-code" class="disabled">Resend in <span id="countdown">60</span>s</a>
                    </div>
                </div>
                
                <!-- Step 2: Verify Code -->
                <div id="step-2" class="hidden">
                    <div class="step-indicator">
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div class="step-label">Enter Email</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">2</div>
                            <div class="step-label">Verify Code</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-label">New Password</div>
                        </div>
                    </div>
                    
                    <div class="verification-instruction">
                        Enter the 6-digit verification code sent to <span id="user-email" style="font-weight: bold; color: #2575fc;"></span>
                    </div>
                    
                    <div class="verification-inputs">
                        <input type="text" class="verification-input" maxlength="1" oninput="moveToNext(this, 1)" data-index="0" autocomplete="off">
                        <input type="text" class="verification-input" maxlength="1" oninput="moveToNext(this, 2)" data-index="1" autocomplete="off">
                        <input type="text" class="verification-input" maxlength="1" oninput="moveToNext(this, 3)" data-index="2" autocomplete="off">
                        <input type="text" class="verification-input" maxlength="1" oninput="moveToNext(this, 4)" data-index="3" autocomplete="off">
                        <input type="text" class="verification-input" maxlength="1" oninput="moveToNext(this, 5)" data-index="4" autocomplete="off">
                        <input type="text" class="verification-input" maxlength="1" oninput="moveToNext(this, 6)" data-index="5" autocomplete="off">
                    </div>
                    
                    <div id="auto-verify-notice" class="auto-verify-notice">
                        <div id="auto-verify-timer">Auto-verifying in <span id="auto-verify-countdown">5</span>s</div>
                        <div id="auto-verify-message" style="margin-top: 5px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn" id="verify-code-btn" onclick="verifyCode()" disabled>Verify Code</button>
                    </div>
                    
                    <div class="resend-timer" id="verification-resend-timer">
                        Didn't receive the code? <a id="resend-verification-code" onclick="resendVerificationCode()">Resend Code</a>
                    </div>
                </div>
                
                <!-- Step 3: New Password -->
                <div id="step-3" class="hidden">
                    <div class="step-indicator">
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div class="step-label">Enter Email</div>
                        </div>
                        <div class="step completed">
                            <div class="step-number">‚úì</div>
                            <div class="step-label">Verify Code</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">3</div>
                            <div class="step-label">New Password</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">New Password <span class="required">*</span></label>
                        <div class="password-container">
                            <input type="password" id="new-password" name="new_password" required 
                                   placeholder="Enter new password" autocomplete="new-password"
                                   oninput="checkNewPasswordStrength()">
                            <button type="button" class="toggle-password" id="toggle-new-password" onclick="togglePassword('new-password', this)">üëÅÔ∏è</button>
                        </div>
                        <div class="password-strength">
                            <div id="new-password-strength-meter" class="password-strength-meter"></div>
                        </div>
                        <div id="new-password-strength-text" class="password-strength-text"></div>
                        <div id="new-password-validation" class="validation-message"></div>
                        <ul id="new-password-rules" class="validation-list">
                            <li id="new-rule-length" class="invalid">At least 8 characters</li>
                            <li id="new-rule-uppercase" class="invalid">Contains uppercase letter</li>
                            <li id="new-rule-lowercase" class="invalid">Contains lowercase letter</li>
                            <li id="new-rule-number" class="invalid">Contains number</li>
                            <li id="new-rule-special" class="invalid">Contains special character (@#$%&!)</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password <span class="required">*</span></label>
                        <div class="password-container">
                            <input type="password" id="confirm-new-password" name="confirm_new_password" required 
                                   placeholder="Confirm new password" autocomplete="new-password"
                                   oninput="checkNewConfirmPassword()">
                            <button type="button" class="toggle-password" id="toggle-confirm-new-password" onclick="togglePassword('confirm-new-password', this)">üëÅÔ∏è</button>
                        </div>
                        <div id="new-confirm-validation" class="validation-message"></div>
                    </div>
                    
                    <button type="button" class="btn" id="reset-password-btn" onclick="resetPassword()" disabled>Reset Password</button>
                </div>
                
                <div class="switch-form">
                    Remember your password? <a id="show-login-from-forgot">Login Now</a>
                </div>
                <a href="../System/Main.html" class="back-button">‚Üê Back to Main Page</a>
            </div>
        </div>
    </div>

    <!-- Verification Code Modal -->
    <div id="verification-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Email Verification Code</h3>
                <button type="button" class="close-btn" onclick="closeVerificationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="verification-code-display">
                    <div>Verification code for:</div>
                    <div style="font-weight: bold; margin: 10px 0; color: #2575fc;" id="modal-email"></div>
                    <div class="code" id="verification-code-display">000000</div>
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">Code expires in: <span id="code-expiry">15:00</span></div>
                </div>
                <div id="code-copied-message" class="code-copied-message"></div>
                <div class="modal-instruction">
                    Click <code>Copy Code</code> then paste it into the verification form.<br>
                    The code will be auto-filled in 2 seconds after copying.
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn primary" onclick="copyVerificationCode()">Copy Code</button>
                <button type="button" class="modal-btn secondary" onclick="closeVerificationModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let usernameAvailable = false;
        let passwordValid = false;
        let confirmPasswordValid = false;
        let newPasswordValid = false;
        let newConfirmPasswordValid = false;
        let emailValid = false;
        let usernameCheckTimeout = null;
        let resendTimer = null;
        let codeExpiryTimer = null;
        let autoVerifyTimer = null;
        let countdown = 60;
        let codeExpiry = 900; // 15 minutes in seconds
        let userEmail = '';
        let currentVerificationCode = '';
        let resetToken = null;
        let autoVerifyCountdown = 5;
        let isAutoVerifying = false;

        // Â§ÑÁêÜÁôªÂΩïË°®ÂçïÊèê‰∫§
        function handleLoginSubmit(event) {
            event.preventDefault();
            
            // Ëé∑ÂèñÂΩìÂâçURLÂèÇÊï∞‰∏≠ÁöÑredirectÂèÇÊï∞
            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect');
            
            console.log('Redirect parameter:', redirect);
            
            // ÂàõÂª∫ÈöêËóèÁöÑredirectÂ≠óÊÆµ
            if (redirect) {
                const redirectInput = document.createElement('input');
                redirectInput.type = 'hidden';
                redirectInput.name = 'redirect';
                redirectInput.value = decodeURIComponent(redirect);
                event.target.appendChild(redirectInput);
            }
            
            // È™åËØÅË°®Âçï
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showMessage('login-message', 'Please fill in all fields', 'error');
                return false;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = 'Logging in...';
            
            // Êèê‰∫§Ë°®Âçï
            event.target.submit();
            return true;
        }

        // Â§ÑÁêÜÊ≥®ÂÜåË°®ÂçïÊèê‰∫§
        function handleRegisterSubmit(event) {
            event.preventDefault();
            
            // È™åËØÅÊâÄÊúâÂ≠óÊÆµ
            if (!usernameAvailable || !emailValid || !passwordValid || !confirmPasswordValid) {
                showMessage('register-message', 'Please fix the validation errors above', 'error');
                return false;
            }
            
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            // ÊúÄÁªàÈ™åËØÅ
            if (!username || !email || !password || !confirmPassword) {
                showMessage('register-message', 'Please fill in all fields', 'error');
                return false;
            }
            
            if (password !== confirmPassword) {
                showMessage('register-message', 'Passwords do not match', 'error');
                return false;
            }
            
            if (password.length < 8) {
                showMessage('register-message', 'Password must be at least 8 characters', 'error');
                return false;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const registerBtn = document.getElementById('register-btn');
            registerBtn.disabled = true;
            registerBtn.innerHTML = 'Creating Account...';
            
            // Êèê‰∫§Ë°®Âçï
            event.target.submit();
            return true;
        }

        // Toggle password visibility
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            button.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        }
        
        // Switch between forms
        document.getElementById('show-register').addEventListener('click', function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
            resetValidation();
            closeVerificationModal();
        });
        
        document.getElementById('show-login').addEventListener('click', function() {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
            resetValidation();
            closeVerificationModal();
        });
        
        document.getElementById('show-forgot-password').addEventListener('click', function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
            clearMessages();
            resetForgotPassword();
            closeVerificationModal();
        });
        
        document.getElementById('show-login-from-forgot').addEventListener('click', function() {
            document.getElementById('forgot-password-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            clearMessages();
            resetForgotPassword();
            closeVerificationModal();
        });
        
        // Ê£ÄÊü•Áî®Êà∑ÂêçÂèØÁî®ÊÄß
        function checkUsernameAvailability(username) {
            const usernameInput = document.getElementById('register-username');
            const statusElement = document.getElementById('username-status');
            const validationElement = document.getElementById('username-validation');
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (usernameCheckTimeout) {
                clearTimeout(usernameCheckTimeout);
            }
            
            if (username.length < 3) {
                usernameInput.classList.remove('valid-border');
                usernameInput.classList.add('invalid-border');
                statusElement.textContent = '';
                validationElement.textContent = 'Username must be at least 3 characters';
                validationElement.className = 'validation-message invalid show';
                usernameAvailable = false;
                updateRegisterButton();
                return;
            }
            
            if (username.length > 50) {
                usernameInput.classList.remove('valid-border');
                usernameInput.classList.add('invalid-border');
                statusElement.textContent = '';
                validationElement.textContent = 'Username must be less than 50 characters';
                validationElement.className = 'validation-message invalid show';
                usernameAvailable = false;
                updateRegisterButton();
                return;
            }
            
            // Ê£ÄÊü•Áî®Êà∑ÂêçÊ†ºÂºè
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                usernameInput.classList.remove('valid-border');
                usernameInput.classList.add('invalid-border');
                statusElement.textContent = '';
                validationElement.textContent = 'Username can only contain letters, numbers and underscores';
                validationElement.className = 'validation-message invalid show';
                usernameAvailable = false;
                updateRegisterButton();
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            statusElement.textContent = 'Checking...';
            statusElement.className = 'username-status loading';
            
            // ‰ΩøÁî®Èò≤ÊäñÔºåÈÅøÂÖçÈ¢ëÁπÅËØ∑Ê±Ç
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const response = await fetch('check_username.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `username=${encodeURIComponent(username)}`
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.text();
                    
                    if (data === 'available') {
                        usernameInput.classList.remove('invalid-border');
                        usernameInput.classList.add('valid-border');
                        statusElement.textContent = '‚úì Available';
                        statusElement.className = 'username-status available';
                        validationElement.textContent = 'Username is available';
                        validationElement.className = 'validation-message valid show';
                        usernameAvailable = true;
                    } else if (data === 'taken') {
                        usernameInput.classList.remove('valid-border');
                        usernameInput.classList.add('invalid-border');
                        statusElement.textContent = '‚úó Taken';
                        statusElement.className = 'username-status taken';
                        validationElement.textContent = 'Username is already taken';
                        validationElement.className = 'validation-message invalid show';
                        usernameAvailable = false;
                    } else if (data === 'invalid') {
                        usernameInput.classList.remove('valid-border');
                        usernameInput.classList.add('invalid-border');
                        statusElement.textContent = '‚úó Invalid';
                        statusElement.className = 'username-status taken';
                        validationElement.textContent = 'Invalid username format';
                        validationElement.className = 'validation-message invalid show';
                        usernameAvailable = false;
                    } else {
                        validationElement.textContent = 'Error checking username';
                        validationElement.className = 'validation-message invalid show';
                        usernameAvailable = false;
                    }
                } catch (error) {
                    console.error('Error checking username:', error);
                    validationElement.textContent = 'Error checking username availability';
                    validationElement.className = 'validation-message invalid show';
                    usernameAvailable = false;
                }
                
                updateRegisterButton();
            }, 500); // 500msÈò≤Êäñ
        }
        
        // Ê£ÄÊü•ÈÇÆÁÆ±Ê†ºÂºèÂíåÊ≥®ÂÜåÁä∂ÊÄÅ
        async function checkEmailFormat() {
            const email = document.getElementById('register-email').value;
            const validationElement = document.getElementById('email-validation');
            const emailInput = document.getElementById('register-email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email.length === 0) {
                validationElement.textContent = '';
                validationElement.className = 'validation-message';
                emailInput.classList.remove('valid-border', 'invalid-border');
                emailValid = false;
                updateRegisterButton();
                return;
            }
            
            if (!emailRegex.test(email)) {
                validationElement.textContent = 'Invalid email format';
                validationElement.className = 'validation-message invalid show';
                emailInput.classList.remove('valid-border');
                emailInput.classList.add('invalid-border');
                emailValid = false;
                updateRegisterButton();
                return;
            }
            
            // ÊòæÁ§∫Ê£ÄÊü•Áä∂ÊÄÅ
            validationElement.textContent = 'Checking email...';
            validationElement.className = 'validation-message show';
            
            try {
                const response = await fetch('check_email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `email=${encodeURIComponent(email)}`
                });
                
                const data = await response.json();
                
                if (data.exists) {
                    validationElement.textContent = 'Email already registered';
                    validationElement.className = 'validation-message invalid show';
                    emailInput.classList.remove('valid-border');
                    emailInput.classList.add('invalid-border');
                    emailValid = false;
                } else {
                    validationElement.textContent = 'Email is available';
                    validationElement.className = 'validation-message valid show';
                    emailInput.classList.remove('invalid-border');
                    emailInput.classList.add('valid-border');
                    emailValid = true;
                }
            } catch (error) {
                console.error('Error checking email:', error);
                validationElement.textContent = 'Error checking email';
                validationElement.className = 'validation-message invalid show';
                emailInput.classList.remove('valid-border');
                emailInput.classList.add('invalid-border');
                emailValid = false;
            }
            
            updateRegisterButton();
        }
        
        // Ê£ÄÊü•ÂØÜÁ†ÅÂº∫Â∫¶
        function checkPasswordStrength() {
            const password = document.getElementById('register-password').value;
            const strengthMeter = document.getElementById('password-strength-meter');
            const strengthText = document.getElementById('password-strength-text');
            const validationElement = document.getElementById('password-validation');
            const passwordInput = document.getElementById('register-password');
            
            let score = 0;
            
            // Ê£ÄÊü•ÂØÜÁ†ÅËßÑÂàô
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[@#$%&!]/.test(password);
            
            // Êõ¥Êñ∞ËßÑÂàôÊòæÁ§∫
            updateRule('rule-length', hasLength);
            updateRule('rule-uppercase', hasUppercase);
            updateRule('rule-lowercase', hasLowercase);
            updateRule('rule-number', hasNumber);
            updateRule('rule-special', hasSpecial);
            
            // ËÆ°ÁÆóÂàÜÊï∞
            if (hasLength) score += 1;
            if (hasUppercase) score += 1;
            if (hasLowercase) score += 1;
            if (hasNumber) score += 1;
            if (hasSpecial) score += 1;
            
            // Á°ÆÂÆöÂº∫Â∫¶Á≠âÁ∫ß
            let strength = 'Very Weak';
            let color = '#dc3545';
            let width = '20%';
            
            if (score >= 4) {
                strength = 'Strong';
                color = '#28a745';
                width = '80%';
                passwordValid = true;
            } else if (score >= 3) {
                strength = 'Good';
                color = '#17a2b8';
                width = '60%';
                passwordValid = true;
            } else if (score >= 2) {
                strength = 'Fair';
                color = '#ffc107';
                width = '40%';
                passwordValid = false;
            } else if (score >= 1) {
                strength = 'Weak';
                color = '#fd7e14';
                width = '20%';
                passwordValid = false;
            } else {
                passwordValid = false;
            }
            
            // Êõ¥Êñ∞UI
            strengthMeter.style.width = width;
            strengthMeter.style.backgroundColor = color;
            strengthText.textContent = `Strength: ${strength}`;
            strengthText.style.color = color;
            
            if (password.length === 0) {
                validationElement.textContent = '';
                validationElement.className = 'validation-message';
                passwordInput.classList.remove('valid-border', 'invalid-border');
            } else if (passwordValid) {
                validationElement.textContent = 'Password strength is good';
                validationElement.className = 'validation-message valid show';
                passwordInput.classList.remove('invalid-border');
                passwordInput.classList.add('valid-border');
            } else {
                validationElement.textContent = 'Password is too weak. Please follow the rules above.';
                validationElement.className = 'validation-message invalid show';
                passwordInput.classList.remove('valid-border');
                passwordInput.classList.add('invalid-border');
            }
            
            // ÂêåÊó∂Ê£ÄÊü•Á°ÆËÆ§ÂØÜÁ†Å
            checkConfirmPassword();
            updateRegisterButton();
        }
        
        // Ê£ÄÊü•Êñ∞ÂØÜÁ†ÅÂº∫Â∫¶
        function checkNewPasswordStrength() {
            const password = document.getElementById('new-password').value;
            const strengthMeter = document.getElementById('new-password-strength-meter');
            const strengthText = document.getElementById('new-password-strength-text');
            const validationElement = document.getElementById('new-password-validation');
            const passwordInput = document.getElementById('new-password');
            
            let score = 0;
            
            // Ê£ÄÊü•ÂØÜÁ†ÅËßÑÂàô
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[@#$%&!]/.test(password);
            
            // Êõ¥Êñ∞ËßÑÂàôÊòæÁ§∫
            updateNewRule('new-rule-length', hasLength);
            updateNewRule('new-rule-uppercase', hasUppercase);
            updateNewRule('new-rule-lowercase', hasLowercase);
            updateNewRule('new-rule-number', hasNumber);
            updateNewRule('new-rule-special', hasSpecial);
            
            // ËÆ°ÁÆóÂàÜÊï∞
            if (hasLength) score += 1;
            if (hasUppercase) score += 1;
            if (hasLowercase) score += 1;
            if (hasNumber) score += 1;
            if (hasSpecial) score += 1;
            
            // Á°ÆÂÆöÂº∫Â∫¶Á≠âÁ∫ß
            let strength = 'Very Weak';
            let color = '#dc3545';
            let width = '20%';
            
            if (score >= 4) {
                strength = 'Strong';
                color = '#28a745';
                width = '80%';
                newPasswordValid = true;
            } else if (score >= 3) {
                strength = 'Good';
                color = '#17a2b8';
                width = '60%';
                newPasswordValid = true;
            } else if (score >= 2) {
                strength = 'Fair';
                color = '#ffc107';
                width = '40%';
                newPasswordValid = false;
            } else if (score >= 1) {
                strength = 'Weak';
                color = '#fd7e14';
                width = '20%';
                newPasswordValid = false;
            } else {
                newPasswordValid = false;
            }
            
            // Êõ¥Êñ∞UI
            strengthMeter.style.width = width;
            strengthMeter.style.backgroundColor = color;
            strengthText.textContent = `Strength: ${strength}`;
            strengthText.style.color = color;
            
            if (password.length === 0) {
                validationElement.textContent = '';
                validationElement.className = 'validation-message';
                passwordInput.classList.remove('valid-border', 'invalid-border');
            } else if (newPasswordValid) {
                validationElement.textContent = 'Password strength is good';
                validationElement.className = 'validation-message valid show';
                passwordInput.classList.remove('invalid-border');
                passwordInput.classList.add('valid-border');
            } else {
                validationElement.textContent = 'Password is too weak. Please follow the rules above.';
                validationElement.className = 'validation-message invalid show';
                passwordInput.classList.remove('valid-border');
                passwordInput.classList.add('invalid-border');
            }
            
            // ÂêåÊó∂Ê£ÄÊü•Á°ÆËÆ§ÂØÜÁ†Å
            checkNewConfirmPassword();
            updateResetPasswordButton();
        }
        
        // Êõ¥Êñ∞ËßÑÂàôÊòæÁ§∫
        function updateRule(elementId, isValid) {
            const element = document.getElementById(elementId);
            element.className = isValid ? 'valid' : 'invalid';
        }
        
        // Êõ¥Êñ∞Êñ∞ÂØÜÁ†ÅËßÑÂàôÊòæÁ§∫
        function updateNewRule(elementId, isValid) {
            const element = document.getElementById(elementId);
            element.className = isValid ? 'valid' : 'invalid';
        }
        
        // Ê£ÄÊü•Á°ÆËÆ§ÂØÜÁ†Å
        function checkConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const validationElement = document.getElementById('confirm-validation');
            const confirmInput = document.getElementById('register-confirm-password');
            
            if (confirmPassword.length === 0) {
                validationElement.textContent = '';
                validationElement.className = 'validation-message';
                confirmInput.classList.remove('valid-border', 'invalid-border');
                confirmPasswordValid = false;
            } else if (password === confirmPassword) {
                validationElement.textContent = 'Passwords match';
                validationElement.className = 'validation-message valid show';
                confirmInput.classList.remove('invalid-border');
                confirmInput.classList.add('valid-border');
                confirmPasswordValid = true;
            } else {
                validationElement.textContent = 'Passwords do not match';
                validationElement.className = 'validation-message invalid show';
                confirmInput.classList.remove('valid-border');
                confirmInput.classList.add('invalid-border');
                confirmPasswordValid = false;
            }
            
            updateRegisterButton();
        }
        
        // Ê£ÄÊü•Êñ∞Á°ÆËÆ§ÂØÜÁ†Å
        function checkNewConfirmPassword() {
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const validationElement = document.getElementById('new-confirm-validation');
            const confirmInput = document.getElementById('confirm-new-password');
            
            if (confirmPassword.length === 0) {
                validationElement.textContent = '';
                validationElement.className = 'validation-message';
                confirmInput.classList.remove('valid-border', 'invalid-border');
                newConfirmPasswordValid = false;
            } else if (password === confirmPassword) {
                validationElement.textContent = 'Passwords match';
                validationElement.className = 'validation-message valid show';
                confirmInput.classList.remove('invalid-border');
                confirmInput.classList.add('valid-border');
                newConfirmPasswordValid = true;
            } else {
                validationElement.textContent = 'Passwords do not match';
                validationElement.className = 'validation-message invalid show';
                confirmInput.classList.remove('valid-border');
                confirmInput.classList.add('invalid-border');
                newConfirmPasswordValid = false;
            }
            
            updateResetPasswordButton();
        }
        
        // Êõ¥Êñ∞Ê≥®ÂÜåÊåâÈíÆÁä∂ÊÄÅ
        function updateRegisterButton() {
            const registerBtn = document.getElementById('register-btn');
            if (usernameAvailable && emailValid && passwordValid && confirmPasswordValid) {
                registerBtn.disabled = false;
                registerBtn.style.opacity = '1';
            } else {
                registerBtn.disabled = true;
                registerBtn.style.opacity = '0.6';
            }
        }
        
        // Êõ¥Êñ∞ÈáçÁΩÆÂØÜÁ†ÅÊåâÈíÆÁä∂ÊÄÅ
        function updateResetPasswordButton() {
            const resetBtn = document.getElementById('reset-password-btn');
            if (newPasswordValid && newConfirmPasswordValid) {
                resetBtn.disabled = false;
                resetBtn.style.opacity = '1';
            } else {
                resetBtn.disabled = true;
                resetBtn.style.opacity = '0.6';
            }
        }
        
        // ÈáçÁΩÆÈ™åËØÅÁä∂ÊÄÅ
        function resetValidation() {
            usernameAvailable = false;
            passwordValid = false;
            confirmPasswordValid = false;
            emailValid = false;
            
            document.getElementById('register-username').classList.remove('valid-border', 'invalid-border');
            document.getElementById('register-email').classList.remove('valid-border', 'invalid-border');
            document.getElementById('register-password').classList.remove('valid-border', 'invalid-border');
            document.getElementById('register-confirm-password').classList.remove('valid-border', 'invalid-border');
            
            document.getElementById('username-status').textContent = '';
            document.getElementById('password-strength-meter').style.width = '0%';
            document.getElementById('password-strength-text').textContent = '';
            
            document.querySelectorAll('.validation-message').forEach(el => {
                el.className = 'validation-message';
                el.textContent = '';
            });
            
            document.querySelectorAll('#password-rules li').forEach(el => {
                el.className = 'invalid';
            });
            
            updateRegisterButton();
        }
        
        // ÈáçÁΩÆÂøòËÆ∞ÂØÜÁ†ÅË°®Âçï
        function resetForgotPassword() {
            // ÈáçÁΩÆÊ≠•È™§
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            
            // ÈáçÁΩÆËæìÂÖ•
            document.getElementById('forgot-email').value = '';
            document.querySelectorAll('.verification-input').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            // ÈáçÁΩÆÈ™åËØÅÁä∂ÊÄÅ
            newPasswordValid = false;
            newConfirmPasswordValid = false;
            
            // ÈáçÁΩÆUI
            document.getElementById('new-password-strength-meter').style.width = '0%';
            document.getElementById('new-password-strength-text').textContent = '';
            document.getElementById('new-password-validation').textContent = '';
            document.getElementById('new-password-validation').className = 'validation-message';
            document.getElementById('new-confirm-validation').textContent = '';
            document.getElementById('new-confirm-validation').className = 'validation-message';
            
            document.querySelectorAll('#new-password-rules li').forEach(el => {
                el.className = 'invalid';
            });
            
            // Ê∏ÖÈô§ÂÆöÊó∂Âô®
            if (resendTimer) {
                clearInterval(resendTimer);
                resendTimer = null;
            }
            
            // Ê∏ÖÈô§È™åËØÅÁ†ÅËøáÊúüÂÆöÊó∂Âô®
            if (codeExpiryTimer) {
                clearInterval(codeExpiryTimer);
                codeExpiryTimer = null;
            }
            
            // Ê∏ÖÈô§Ëá™Âä®È™åËØÅÂÆöÊó∂Âô®
            if (autoVerifyTimer) {
                clearInterval(autoVerifyTimer);
                autoVerifyTimer = null;
            }
            
            // ÈáçÁΩÆÈáçÂèëÊåâÈíÆ
            document.getElementById('resend-timer').classList.add('hidden');
            document.getElementById('resend-code').classList.add('disabled');
            document.getElementById('countdown').textContent = '60';
            countdown = 60;
            
            // ÈáçÁΩÆÈ™åËØÅÊåâÈíÆ
            document.getElementById('verify-code-btn').disabled = true;
            
            // ÈáçÁΩÆËá™Âä®È™åËØÅÈÄöÁü•
            document.getElementById('auto-verify-notice').classList.remove('show');
            document.getElementById('auto-verify-countdown').textContent = '5';
            autoVerifyCountdown = 5;
            isAutoVerifying = false;
            
            // ÈáçÁΩÆÂÖ®Â±ÄÂèòÈáè
            userEmail = '';
            resetToken = null;
            currentVerificationCode = '';
        }
        
        // ÂèëÈÄÅÈ™åËØÅÁ†ÅÔºàÂÆåÂÖ®‰øÆÂ§çÁâàÔºâ
        async function sendVerificationCode() {
            const email = document.getElementById('forgot-email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email || !emailRegex.test(email)) {
                showMessage('forgot-message', 'Please enter a valid email address', 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const sendBtn = document.getElementById('send-code-btn');
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'Sending...';
            
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÊ£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â≠òÂú®
                const formData = new FormData();
                formData.append('action', 'send_code');
                formData.append('email', email);
                
                const response = await fetch('ForgotPassword.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑÈ™åËØÅÁ†Å
                    currentVerificationCode = result.code;
                    userEmail = email;
                    
                    console.log('Verification code received from backend:', currentVerificationCode);
                    
                    // ÊòæÁ§∫ÂºπÁ™óÊòæÁ§∫È™åËØÅÁ†Å
                    showVerificationModal();
                    
                    // ÊòæÁ§∫Ê≠•È™§2
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');
                    document.getElementById('user-email').textContent = email;
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    showMessage('forgot-message', result.message, 'success');
                    
                    // ÂêØÂä®ÈáçÂèëËÆ°Êó∂Âô®
                    startResendTimer();
                    
                    // ÂêØÂä®È™åËØÅÁ†ÅËøáÊúüËÆ°Êó∂Âô®
                    startCodeExpiryTimer();
                    
                    // ËÆæÁΩÆÂ¢ûÂº∫ÁöÑÁ≤òË¥¥ÂäüËÉΩ
                    setupEnhancedPaste();
                    
                    // ÂêØÁî®È™åËØÅÊåâÈíÆ
                    document.getElementById('verify-code-btn').disabled = false;
                } else {
                    showMessage('forgot-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('forgot-message', 'Failed to send verification code', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        }
        
        // ÊòæÁ§∫È™åËØÅÁ†ÅÂºπÁ™ó
        function showVerificationModal() {
            document.getElementById('verification-code-display').textContent = currentVerificationCode;
            document.getElementById('modal-email').textContent = userEmail;
            document.getElementById('verification-modal').classList.remove('hidden');
            
            // ÈáçÁΩÆËøáÊúüÊó∂Èó¥ÊòæÁ§∫
            codeExpiry = 900; // 15ÂàÜÈíü
            updateExpiryDisplay();
            
            // ÈöêËóèÂ§çÂà∂ÊàêÂäüÊ∂àÊÅØ
            document.getElementById('code-copied-message').classList.remove('show');
        }
        
        // Êõ¥Êñ∞ËøáÊúüÊó∂Èó¥ÊòæÁ§∫
        function updateExpiryDisplay() {
            const minutes = Math.floor(codeExpiry / 60);
            const seconds = codeExpiry % 60;
            document.getElementById('code-expiry').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ÂêØÂä®È™åËØÅÁ†ÅËøáÊúüËÆ°Êó∂Âô®
        function startCodeExpiryTimer() {
            if (codeExpiryTimer) {
                clearInterval(codeExpiryTimer);
            }
            
            codeExpiryTimer = setInterval(() => {
                codeExpiry--;
                updateExpiryDisplay();
                
                if (codeExpiry <= 0) {
                    clearInterval(codeExpiryTimer);
                    showMessage('forgot-message', 'Verification code has expired. Please request a new one.', 'error');
                    // Ê∏ÖÈô§ÂΩìÂâçÈ™åËØÅÁ†Å
                    currentVerificationCode = '';
                    // Á¶ÅÁî®È™åËØÅÊåâÈíÆ
                    document.getElementById('verify-code-btn').disabled = true;
                }
            }, 1000);
        }
        
        // ÂÖ≥Èó≠È™åËØÅÁ†ÅÂºπÁ™ó
        function closeVerificationModal() {
            const modal = document.getElementById('verification-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Â§çÂà∂È™åËØÅÁ†ÅÂπ∂Ëá™Âä®Â°´ÂÖÖ
        async function copyVerificationCode() {
            if (!currentVerificationCode) {
                alert('No verification code available');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(currentVerificationCode);
                
                // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÊ∂àÊÅØ
                const copySuccess = document.getElementById('code-copied-message');
                copySuccess.textContent = '‚úì Code copied! Auto-filling in 2 seconds...';
                copySuccess.classList.remove('error');
                copySuccess.classList.add('success');
                copySuccess.classList.add('show');
                
                // 2ÁßíÂêéËá™Âä®Â°´ÂÖÖÈ™åËØÅÁ†Å
                setTimeout(() => {
                    // Ëá™Âä®Â°´ÂÖÖÈ™åËØÅÁ†ÅËæìÂÖ•Ê°Ü
                    const inputs = document.querySelectorAll('.verification-input');
                    const codeDigits = currentVerificationCode.split('');
                    
                    inputs.forEach((input, index) => {
                        if (codeDigits[index]) {
                            input.value = codeDigits[index];
                            input.classList.add('filled');
                            // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂
                            input.dispatchEvent(new Event('input'));
                        }
                    });
                    
                    // ÂÖ≥Èó≠ÂºπÁ™ó
                    closeVerificationModal();
                    
                    // ÂêØÁî®È™åËØÅÊåâÈíÆ
                    document.getElementById('verify-code-btn').disabled = false;
                    
                    // ÊòæÁ§∫Ëá™Âä®È™åËØÅÈÄöÁü•
                    const autoVerifyNotice = document.getElementById('auto-verify-notice');
                    const autoVerifyMessage = document.getElementById('auto-verify-message');
                    
                    autoVerifyNotice.classList.add('show');
                    autoVerifyNotice.style.display = 'block';
                    autoVerifyMessage.textContent = 'Code auto-filled! Click "Verify Code" or wait 3 seconds for auto-verification...';
                    autoVerifyMessage.style.color = '#084298';
                    
                    // 3ÁßíÂêéËá™Âä®È™åËØÅ
                    autoVerifyCountdown = 3;
                    document.getElementById('auto-verify-countdown').textContent = autoVerifyCountdown;
                    
                    if (autoVerifyTimer) {
                        clearInterval(autoVerifyTimer);
                    }
                    
                    autoVerifyTimer = setInterval(() => {
                        autoVerifyCountdown--;
                        document.getElementById('auto-verify-countdown').textContent = autoVerifyCountdown;
                        
                        if (autoVerifyCountdown <= 0) {
                            clearInterval(autoVerifyTimer);
                            isAutoVerifying = true;
                            verifyCode();
                        }
                    }, 1000);
                    
                }, 2000); // Á≠âÂæÖ2Áßí
                
            } catch (err) {
                console.error('Failed to copy: ', err);
                // ÈôçÁ∫ßÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = currentVerificationCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                const copySuccess = document.getElementById('code-copied-message');
                copySuccess.textContent = '‚úì Code copied! Auto-filling now...';
                copySuccess.classList.add('show');
                
                // Á´ãÂç≥Ëá™Âä®Â°´ÂÖÖ
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.verification-input');
                    const codeDigits = currentVerificationCode.split('');
                    
                    inputs.forEach((input, index) => {
                        if (codeDigits[index]) {
                            input.value = codeDigits[index];
                            input.classList.add('filled');
                            input.dispatchEvent(new Event('input'));
                        }
                    });
                    
                    closeVerificationModal();
                    document.getElementById('verify-code-btn').disabled = false;
                }, 500);
            }
        }
        
        // ÂêØÂä®ÈáçÂèëËÆ°Êó∂Âô®
        function startResendTimer() {
            countdown = 60;
            document.getElementById('countdown').textContent = countdown;
            document.getElementById('resend-timer').classList.remove('hidden');
            document.getElementById('resend-code').classList.add('disabled');
            
            if (resendTimer) {
                clearInterval(resendTimer);
            }
            
            resendTimer = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(resendTimer);
                    document.getElementById('resend-code').classList.remove('disabled');
                    document.getElementById('resend-code').textContent = 'Resend Now';
                }
            }, 1000);
        }
        
        // ÈáçÊñ∞ÂèëÈÄÅÈ™åËØÅÁ†ÅÔºàÂÆåÂÖ®‰øÆÂ§çÁâàÔºâ
        async function resendVerificationCode() {
            if (countdown > 0) {
                showMessage('forgot-message', `Please wait ${countdown} seconds before resending`, 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const resendLink = document.getElementById('resend-verification-code');
            const originalText = resendLink.innerHTML;
            resendLink.innerHTML = 'Resending...';
            
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÈáçÊñ∞ÂèëÈÄÅÈ™åËØÅÁ†Å
                const formData = new FormData();
                formData.append('action', 'send_code');
                formData.append('email', userEmail);
                
                const response = await fetch('ForgotPassword.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑÊñ∞È™åËØÅÁ†Å
                    currentVerificationCode = result.code;
                    
                    console.log('New verification code received from backend:', currentVerificationCode);
                    
                    // Êõ¥Êñ∞ÂºπÁ™óÊòæÁ§∫
                    document.getElementById('verification-code-display').textContent = currentVerificationCode;
                    
                    // ÈáçÁΩÆËÆ°Êó∂Âô®
                    startResendTimer();
                    document.getElementById('resend-code').classList.add('disabled');
                    
                    // ÈáçÁΩÆÈ™åËØÅÁ†ÅËøáÊúüËÆ°Êó∂Âô®
                    if (codeExpiryTimer) {
                        clearInterval(codeExpiryTimer);
                    }
                    codeExpiry = 900;
                    startCodeExpiryTimer();
                    
                    // Ê∏ÖÈô§È™åËØÅÁ†ÅËæìÂÖ•
                    document.querySelectorAll('.verification-input').forEach(input => {
                        input.value = '';
                        input.classList.remove('filled');
                    });
                    
                    // Á¶ÅÁî®È™åËØÅÊåâÈíÆÔºàÁ≠âÂæÖÁî®Êà∑ËæìÂÖ•Ôºâ
                    document.getElementById('verify-code-btn').disabled = true;
                    
                    // Ê∏ÖÈô§Ëá™Âä®È™åËØÅ
                    if (autoVerifyTimer) {
                        clearInterval(autoVerifyTimer);
                        autoVerifyTimer = null;
                    }
                    document.getElementById('auto-verify-notice').classList.remove('show');
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    showMessage('forgot-message', 'New verification code sent!', 'success');
                    
                    // ÈáçÊñ∞ÊòæÁ§∫ÂºπÁ™ó
                    showVerificationModal();
                } else {
                    showMessage('forgot-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('forgot-message', 'Failed to resend verification code', 'error');
            } finally {
                resendLink.innerHTML = originalText;
            }
        }
        
        // Âú®È™åËØÅÁ†ÅËæìÂÖ•Ê°Ü‰πãÈó¥ÁßªÂä®ÁÑ¶ÁÇπ
        function moveToNext(input, nextIndex) {
            // Âè™ÂÖÅËÆ∏Êï∞Â≠ó
            input.value = input.value.replace(/\D/g, '');
            
            // Â¶ÇÊûúËæìÂÖ•‰∫ÜÂÜÖÂÆπÔºåÊ∑ªÂä†filledÁ±ª
            if (input.value) {
                input.classList.add('filled');
            } else {
                input.classList.remove('filled');
            }
            
            // Ëá™Âä®Ë∑≥ËΩ¨Âà∞‰∏ã‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
            if (input.value && nextIndex <= 6) {
                const nextInput = document.querySelector(`.verification-input[data-index="${nextIndex}"]`);
                if (nextInput) {
                    nextInput.focus();
                }
            }
            
            // Â§ÑÁêÜÈÄÄÊ†ºÈîÆÔºàËá™Âä®Ë∑≥ËΩ¨Âà∞‰∏ä‰∏Ä‰∏™ËæìÂÖ•Ê°ÜÔºâ
            if (input.value === '' && nextIndex > 1) {
                const prevInput = document.querySelector(`.verification-input[data-index="${nextIndex - 2}"]`);
                if (prevInput) {
                    prevInput.focus();
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâËæìÂÖ•Ê°ÜÈÉΩÊúâÂÄº
            checkVerificationCode();
        }
        
        // Ê£ÄÊü•È™åËØÅÁ†Å
        function checkVerificationCode() {
            const inputs = document.querySelectorAll('.verification-input');
            let code = '';
            let allFilled = true;
            
            inputs.forEach(input => {
                code += input.value;
                if (!input.value) allFilled = false;
            });
            
            // Â¶ÇÊûúÊâÄÊúâËæìÂÖ•Ê°ÜÈÉΩÊúâÂÄºÔºåÂêØÁî®È™åËØÅÊåâÈíÆ
            document.getElementById('verify-code-btn').disabled = !allFilled;
            
            // Â¶ÇÊûúÂ°´Êª°‰∫Ü6‰Ωç‰∏î‰∏çÊòØËá™Âä®È™åËØÅ‰∏≠ÔºåÂºÄÂßãËá™Âä®È™åËØÅÂÄíËÆ°Êó∂
            if (allFilled && code.length === 6 && !isAutoVerifying) {
                startAutoVerifyCountdown();
            }
        }
        
        // ÂºÄÂßãËá™Âä®È™åËØÅÂÄíËÆ°Êó∂
        function startAutoVerifyCountdown() {
            // Ê∏ÖÈô§Ëá™Âä®È™åËØÅÈÄöÁü•
            document.getElementById('auto-verify-notice').classList.remove('show');
            
            // ÊòæÁ§∫Ëá™Âä®È™åËØÅÈÄöÁü•
            const autoVerifyNotice = document.getElementById('auto-verify-notice');
            const autoVerifyMessage = document.getElementById('auto-verify-message');
            
            autoVerifyNotice.classList.add('show');
            autoVerifyNotice.style.display = 'block';
            autoVerifyMessage.textContent = 'Code entered. Click "Verify Code" or wait 3 seconds for auto-verification...';
            autoVerifyMessage.style.color = '#084298';
            
            autoVerifyCountdown = 3;
            document.getElementById('auto-verify-countdown').textContent = autoVerifyCountdown;
            
            if (autoVerifyTimer) {
                clearInterval(autoVerifyTimer);
            }
            
            autoVerifyTimer = setInterval(() => {
                autoVerifyCountdown--;
                document.getElementById('auto-verify-countdown').textContent = autoVerifyCountdown;
                
                if (autoVerifyCountdown <= 0) {
                    clearInterval(autoVerifyTimer);
                    isAutoVerifying = true;
                    verifyCode();
                }
            }, 1000);
        }
        
        // ËÆæÁΩÆÂ¢ûÂº∫ÁöÑÁ≤òË¥¥ÂäüËÉΩ
        function setupEnhancedPaste() {
            const verificationInputs = document.querySelectorAll('.verification-input');
            
            verificationInputs.forEach(input => {
                // Ê∏ÖÈô§ÊóßÁöÑÁõëÂê¨Âô®
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
                newInput.addEventListener('paste', handlePaste);
                newInput.addEventListener('input', function(e) {
                    moveToNext(this, parseInt(this.dataset.index) + 2);
                });
            });
            
            function handlePaste(e) {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text');
                const numbers = pasteData.replace(/\D/g, '');
                
                if (numbers.length === 6) {
                    // Â¶ÇÊûúÁ≤òË¥¥ÁöÑÊòØ6‰ΩçÊï∞Â≠óÔºåËá™Âä®Â°´ÂÖÖ
                    const inputs = document.querySelectorAll('.verification-input');
                    inputs.forEach((inputEl, index) => {
                        if (numbers[index]) {
                            inputEl.value = numbers[index];
                            inputEl.classList.add('filled');
                            // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂‰ª•Êõ¥Êñ∞UI
                            inputEl.dispatchEvent(new Event('input'));
                        }
                    });
                    
                    // Ê∏ÖÈô§Ëá™Âä®È™åËØÅÈÄöÁü•
                    document.getElementById('auto-verify-notice').classList.remove('show');
                    
                    // ÂêØÁî®È™åËØÅÊåâÈíÆ
                    document.getElementById('verify-code-btn').disabled = false;
                    
                    // ÊòæÁ§∫Ëá™Âä®È™åËØÅÈÄöÁü•
                    const autoVerifyNotice = document.getElementById('auto-verify-notice');
                    const autoVerifyMessage = document.getElementById('auto-verify-message');
                    
                    autoVerifyNotice.classList.add('show');
                    autoVerifyNotice.style.display = 'block';
                    autoVerifyMessage.textContent = 'Code pasted! Click "Verify Code" or wait 3 seconds for auto-verification...';
                    autoVerifyMessage.style.color = '#084298';
                    
                    // 3ÁßíÂêéËá™Âä®È™åËØÅ
                    autoVerifyCountdown = 3;
                    document.getElementById('auto-verify-countdown').textContent = autoVerifyCountdown;
                    
                    if (autoVerifyTimer) {
                        clearInterval(autoVerifyTimer);
                    }
                    
                    autoVerifyTimer = setInterval(() => {
                        autoVerifyCountdown--;
                        document.getElementById('auto-verify-countdown').textContent = autoVerifyCountdown;
                        
                        if (autoVerifyCountdown <= 0) {
                            clearInterval(autoVerifyTimer);
                            isAutoVerifying = true;
                            verifyCode();
                        }
                    }, 1000);
                    
                    // ËÅöÁÑ¶Âà∞ÊúÄÂêé‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
                    inputs[5].focus();
                } else if (numbers.length > 0 && numbers.length < 6) {
                    // Â¶ÇÊûúÁ≤òË¥¥ÁöÑÊï∞Â≠ó‰∏çË∂≥6‰ΩçÔºåÂè™Â°´ÂÖÖÂâçÂá†‰∏™
                    const inputs = document.querySelectorAll('.verification-input');
                    numbers.split('').forEach((num, index) => {
                        if (inputs[index]) {
                            inputs[index].value = num;
                            inputs[index].classList.add('filled');
                            inputs[index].dispatchEvent(new Event('input'));
                        }
                    });
                    
                    // ËÅöÁÑ¶Âà∞‰∏ã‰∏Ä‰∏™ÂèØÁî®ÁöÑËæìÂÖ•Ê°Ü
                    const nextIndex = Math.min(numbers.length, 5);
                    inputs[nextIndex].focus();
                }
            }
        }
        
        // È™åËØÅÈ™åËØÅÁ†ÅÔºàÂÆåÂÖ®‰øÆÂ§çÁâà - ‰ΩøÁî®ÂêéÁ´ØÈ™åËØÅÔºâ
        async function verifyCode() {
            const inputs = document.querySelectorAll('.verification-input');
            let enteredCode = '';
            
            inputs.forEach(input => {
                enteredCode += input.value;
            });
            
            // Ê£ÄÊü•È™åËØÅÁ†ÅÊòØÂê¶ËøáÊúü
            if (codeExpiry <= 0) {
                showMessage('forgot-message', 'Verification code has expired. Please request a new one.', 'error');
                return;
            }
            
            if (enteredCode.length !== 6) {
                showMessage('forgot-message', 'Please enter all 6 digits', 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const verifyBtn = document.getElementById('verify-code-btn');
            const originalText = verifyBtn.innerHTML;
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = 'Verifying...';
            
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÈ™åËØÅÈ™åËØÅÁ†Å
                const formData = new FormData();
                formData.append('action', 'verify_code');
                formData.append('email', userEmail);
                formData.append('code', enteredCode);
                
                const response = await fetch('ForgotPassword.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // È™åËØÅÊàêÂäüÔºåÊòæÁ§∫Ê≠•È™§3
                    document.getElementById('step-2').classList.add('hidden');
                    document.getElementById('step-3').classList.remove('hidden');
                    showMessage('forgot-message', result.message, 'success');
                    
                    // Â≠òÂÇ®ÈáçÁΩÆ‰ª§Áâå
                    resetToken = result.token;
                    
                    // Ê∏ÖÈô§È™åËØÅÁ†ÅËøáÊúüÂÆöÊó∂Âô®
                    if (codeExpiryTimer) {
                        clearInterval(codeExpiryTimer);
                        codeExpiryTimer = null;
                    }
                    
                    // Ê∏ÖÈô§Ëá™Âä®È™åËØÅÂÆöÊó∂Âô®
                    if (autoVerifyTimer) {
                        clearInterval(autoVerifyTimer);
                        autoVerifyTimer = null;
                    }
                    
                    // ÂÖ≥Èó≠ÂºπÁ™ó
                    closeVerificationModal();
                    
                    // Ê∏ÖÈô§Ëá™Âä®È™åËØÅÈÄöÁü•
                    document.getElementById('auto-verify-notice').classList.remove('show');
                } else {
                    showMessage('forgot-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('forgot-message', 'Failed to verify code. Please try again.', 'error');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = originalText;
                isAutoVerifying = false;
            }
        }
        
        // ÈáçÁΩÆÂØÜÁ†ÅÔºàÂÆåÂÖ®‰øÆÂ§çÁâàÔºâ
        async function resetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!newPasswordValid || !newConfirmPasswordValid) {
                showMessage('forgot-message', 'Please fix the validation errors above', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('forgot-message', 'Passwords do not match', 'error');
                return;
            }
            
            if (!resetToken) {
                showMessage('forgot-message', 'Reset session expired. Please start over.', 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const resetBtn = document.getElementById('reset-password-btn');
            const originalText = resetBtn.innerHTML;
            resetBtn.disabled = true;
            resetBtn.innerHTML = 'Resetting...';
            
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÈáçÁΩÆÂØÜÁ†Å
                const formData = new FormData();
                formData.append('action', 'reset_password');
                formData.append('email', userEmail);
                formData.append('token', resetToken);
                formData.append('new_password', newPassword);
                
                const response = await fetch('ForgotPassword.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('forgot-message', 'Password reset successful! You can now login with your new password.', 'success');
                    
                    // ÈáçÁΩÆË°®ÂçïÂπ∂ÊòæÁ§∫ÁôªÂΩïË°®Âçï
                    setTimeout(() => {
                        resetForgotPassword();
                        document.getElementById('forgot-password-form').classList.add('hidden');
                        document.getElementById('login-form').classList.remove('hidden');
                        clearMessages();
                    }, 3000);
                } else {
                    showMessage('forgot-message', result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('forgot-message', 'An error occurred. Please try again.', 'error');
            } finally {
                resetBtn.disabled = false;
                resetBtn.innerHTML = originalText;
            }
        }
        
        // Show message
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.classList.remove('hidden');
            
            // Ëá™Âä®ÈöêËóèÈîôËØØÊ∂àÊÅØ
            if (type === 'error') {
                setTimeout(() => {
                    messageElement.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Clear messages
        function clearMessages() {
            document.getElementById('login-message').classList.add('hidden');
            document.getElementById('register-message').classList.add('hidden');
            document.getElementById('forgot-message').classList.add('hidden');
        }

        // Check for URL parameters to show messages
        window.addEventListener('load', function() {
            console.log('Login page loaded');
            const urlParams = new URLSearchParams(window.location.search);
            const loginError = urlParams.get('login_error');
            const registerError = urlParams.get('register_error');
            const registerSuccess = urlParams.get('register_success');
            
            console.log('URL Parameters:', { loginError, registerError, registerSuccess });
            
            if (loginError) {
                showMessage('login-message', decodeURIComponent(loginError), 'error');
                // Á°Æ‰øùÊòæÁ§∫ÁôªÂΩïË°®Âçï
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('forgot-password-form').classList.add('hidden');
                closeVerificationModal();
            }
            if (registerError) {
                // ÊòæÁ§∫Ê≥®ÂÜåË°®ÂçïÂπ∂ÊòæÁ§∫ÈîôËØØ
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
                document.getElementById('forgot-password-form').classList.add('hidden');
                showMessage('register-message', decodeURIComponent(registerError), 'error');
                closeVerificationModal();
            }
            if (registerSuccess) {
                // ÊòæÁ§∫ÁôªÂΩïË°®ÂçïÂπ∂ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('forgot-password-form').classList.add('hidden');
                showMessage('login-message', decodeURIComponent(registerSuccess), 'success');
                closeVerificationModal();
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂÆöÂêëÂèÇÊï∞
            const redirect = urlParams.get('redirect');
            if (redirect) {
                console.log('Redirect parameter found:', redirect);
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁôªÂΩïÊàêÂäüÁöÑÂèÇÊï∞Ôºà‰ªéÂÖ∂‰ªñÈ°µÈù¢ÈáçÂÆöÂêëÂõûÊù•Ôºâ
            const loginSuccess = urlParams.get('login_success');
            const username = urlParams.get('username');
            const role = urlParams.get('role');
            
            if (loginSuccess === '1' && username) {
                console.log('User just logged in from redirect:', username, role);
                // Ê∏ÖÈô§URLÂèÇÊï∞
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                // Â¶ÇÊûúÊòØÈáçÂÆöÂêëÂõûÊù•ÁöÑÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÈáçÂÆöÂêëÈ°µÈù¢
                if (redirect) {
                    window.location.href = decodeURIComponent(redirect);
                }
            }
            
            // ÊÅ¢Â§çÁôªÂΩïÊåâÈíÆÁä∂ÊÄÅ
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Login';
            }
            
            // ÊÅ¢Â§çÊ≥®ÂÜåÊåâÈíÆÁä∂ÊÄÅ
            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) {
                registerBtn.disabled = true;
                registerBtn.innerHTML = 'Create Account';
            }
            
            // ÁõëÂê¨È™åËØÅÁ†ÅËæìÂÖ•Ê°ÜÁöÑÈîÆÁõò‰∫ã‰ª∂
            const verificationInputs = document.querySelectorAll('.verification-input');
            verificationInputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    // ÂÖÅËÆ∏ÈÄÄÊ†ºÈîÆ„ÄÅÂà†Èô§ÈîÆ„ÄÅÁÆ≠Â§¥ÈîÆ„ÄÅTabÈîÆ
                    if ([8, 9, 37, 38, 39, 40, 46].includes(e.keyCode)) {
                        return;
                    }
                    
                    // Âè™ÂÖÅËÆ∏Êï∞Â≠ó
                    if (e.keyCode < 48 || e.keyCode > 57) {
                        if (e.keyCode < 96 || e.keyCode > 105) {
                            e.preventDefault();
                        }
                    }
                });
            });
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            document.getElementById('verification-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVerificationModal();
                }
            });
            
            // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeVerificationModal();
                }
            });
            
            // ËÆæÁΩÆÂ¢ûÂº∫ÁöÑÁ≤òË¥¥ÂäüËÉΩ
            setupEnhancedPaste();
            
            // ‰∏∫ÈáçÊñ∞ÂèëÈÄÅÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('resend-code').addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.classList.contains('disabled')) {
                    resendVerificationCode();
                }
            });
            
            // ÂàùÂßãÊó∂Á°Æ‰øùÂºπÁ™óÂÖ≥Èó≠
            closeVerificationModal();
        });
    </script>
</body>
</html>