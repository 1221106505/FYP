<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History - Virtual BookStore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6d28d9;
            --primary-dark: #5b21b6;
            --secondary: #f1f5f9;
            --accent: #10b981;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --card-bg: #ffffff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #e74c3c;
            --pre-order: #3b82f6;
            --pre-order-dark: #1d4ed8;
            --pending: #f59e0b;
            --processing: #3b82f6;
            --shipped: #8b5cf6;
            --delivered: #10b981;
            --cancelled: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .order-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .order-nav {
            display: flex;
            gap: 25px;
        }

        .order-nav a {
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: color 0.3s;
            padding: 8px 0;
            position: relative;
        }

        .order-nav a:hover, .order-nav a.active {
            color: var(--primary);
        }

        .order-nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }

        .user-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-welcome {
            color: var(--text-light);
            font-weight: 500;
        }

        .username {
            color: var(--primary);
            font-weight: 600;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(109, 40, 217, 0.15);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card:nth-child(2) {
            border-left-color: var(--success);
        }

        .stat-card:nth-child(3) {
            border-left-color: var(--pre-order);
        }

        .stat-card:nth-child(4) {
            border-left-color: var(--warning);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
            opacity: 0.8;
        }

        .stat-card:nth-child(2) .stat-icon {
            color: var(--success);
        }

        .stat-card:nth-child(3) .stat-icon {
            color: var(--pre-order);
        }

        .stat-card:nth-child(4) .stat-icon {
            color: var(--warning);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text);
        }

        .stat-label {
            font-size: 0.95rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Filter Section */
        .filter-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: white;
            min-width: 180px;
            font-size: 0.95rem;
            color: var(--text);
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.1);
        }

        /* Orders Section */
        .orders-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .orders-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Order Card */
        .order-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .order-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .order-meta {
            flex: 1;
        }

        .order-id {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-id::before {
            content: '#';
            color: var(--primary);
            font-weight: 900;
        }

        .order-date {
            color: var(--text-light);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-date::before {
            content: 'üìÖ';
            font-size: 0.9rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--pending);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-confirmed {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--processing);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-shipped {
            background-color: rgba(139, 92, 246, 0.15);
            color: var(--shipped);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .status-delivered {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--delivered);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--cancelled);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Payment Status */
        .payment-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin: 5px 0;
        }

        .payment-pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--pending);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .payment-completed {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .payment-failed {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .payment-refunded {
            background-color: rgba(148, 163, 184, 0.15);
            color: var(--text-light);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        /* Order Details */
        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .detail-item {
            padding: 10px;
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text);
        }

        /* Order Items */
        .order-items {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .order-items h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item-card {
            display: flex;
            gap: 15px;
            padding: 15px;
            background-color: var(--secondary);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            transition: background-color 0.3s;
        }

        .item-card:hover {
            background-color: #e2e8f0;
        }

        .item-image {
            width: 60px;
            height: 80px;
            background: linear-gradient(135deg, var(--secondary), #e2e8f0);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .item-author {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .item-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .item-quantity {
            color: var(--text);
        }

        .item-price {
            color: var(--primary);
            font-weight: 600;
        }

        .item-total {
            color: var(--success);
            font-weight: 600;
        }

        /* Order Total */
        .order-total {
            padding: 20px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
        }

        .total-label {
            font-size: 1.1rem;
            color: var(--text-light);
        }

        .total-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Payment History */
        .payment-history {
            padding: 20px;
            background-color: var(--secondary);
            border-radius: 0 0 12px 12px;
        }

        .payment-history h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
        }

        .payment-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--info);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .payment-card.completed {
            border-left-color: var(--success);
        }

        .payment-card.failed {
            border-left-color: var(--danger);
        }

        .payment-card.refunded {
            border-left-color: var(--text-light);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .payment-method {
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }

        .payment-date {
            color: var(--text-light);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .payment-date::before {
            content: 'üïí';
            font-size: 0.8rem;
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-amount {
            font-weight: 700;
            color: var(--success);
            font-size: 1.2rem;
        }

        .transaction-id {
            font-size: 0.85rem;
            color: var(--text-light);
            font-family: 'Courier New', monospace;
            background-color: var(--secondary);
            padding: 5px 10px;
            border-radius: 4px;
        }

        /* Login Prompt */
        .login-prompt {
            text-align: center;
            padding: 80px 40px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .login-prompt h2 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 2rem;
            font-weight: 700;
        }

        .login-prompt p {
            color: var(--text-light);
            margin-bottom: 30px;
            font-size: 1.1rem;
            max-width: 500px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-light);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
        }

        /* Empty State */
        .no-orders {
            text-align: center;
            padding: 80px 40px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .no-orders i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--text-light);
            opacity: 0.5;
        }

        .no-orders h3 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .no-orders p {
            color: var(--text-light);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 60px 40px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--danger);
        }

        .error-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--danger);
        }

        .error-state h3 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .error-state p {
            color: var(--text-light);
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background-color: var(--success);
        }

        .toast.error {
            background-color: var(--danger);
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .order-header {
                flex-direction: column;
                gap: 20px;
            }

            .order-nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }

            .filter-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .filter-controls {
                flex-direction: column;
                width: 100%;
            }

            .filter-select {
                width: 100%;
            }

            .order-details {
                grid-template-columns: 1fr;
            }

            .item-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-meta {
                flex-direction: column;
                gap: 5px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .order-container {
                padding: 15px;
            }

            .order-header h1 {
                font-size: 1.5rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .order-id {
                font-size: 1.1rem;
            }

            .status-badge {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="order-container">
        <!-- Header -->
        <header class="order-header">
            <div class="logo">
                <i class="fas fa-book"></i>
                <h1>Virtual BookStore</h1>
            </div>
            <nav class="order-nav">
                <a href="Main.html">Home</a>
                <a href="customer_view.html">Books</a>
                <a href="../System/cart/cart.html">Cart</a>
                <a href="order_history.html" class="active">Order History</a>
                <a href="user_profile.html">Profile</a>
            </nav>
            <div class="user-actions">
                <div class="user-welcome">
                    Welcome, <span class="username" id="welcomeUser">Guest</span>
                </div>
            </div>
        </header>

        <!-- Statistics Cards -->
        <div id="orderStats" class="stats-grid hidden">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-value" id="totalSpent">RM 0.00</div>
                <div class="stat-label">Total Spent</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value" id="completedPayments">0</div>
                <div class="stat-label">Paid Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="pendingPayments">0</div>
                <div class="stat-label">Pending Payments</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div id="filterControls" class="filter-section hidden">
            <div class="filter-header">
                <h2>Filter Orders</h2>
                <div class="filter-controls">
                    <select id="statusFilter" class="filter-select" onchange="filterOrders()">
                        <option value="all">All Status</option>
                        <option value="pending">‚è≥ Pending</option>
                        <option value="confirmed">‚úÖ Confirmed</option>
                        <option value="shipped">üöö Shipped</option>
                        <option value="delivered">üì¶ Delivered</option>
                        <option value="cancelled">‚ùå Cancelled</option>
                    </select>
                    <select id="dateFilter" class="filter-select" onchange="filterOrders()">
                        <option value="all">All Time</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                    <button class="btn btn-primary" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="orderContent">
            <!-- Login Prompt -->
            <div class="login-prompt" id="loginPrompt">
                <h2>Please Login</h2>
                <p>You need to be logged in to view your order history and track your purchases.</p>
                <a href="../Login/Login.html" class="btn btn-primary">Go to Login</a>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="loading hidden">
                <i class="fas fa-spinner"></i>
                <p>Loading your orders...</p>
            </div>
            
            <!-- Orders Section -->
            <div id="ordersList" class="orders-section hidden">
                <div id="ordersContainer">
                    <!-- Orders will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle" id="toast-icon"></i>
        <span id="toast-message">Notification message</span>
    </div>

    <script>
        // ============================================
        // ORIGINAL JAVASCRIPT FUNCTIONALITY (‰øùÊåÅÂéüÊúâÂäüËÉΩ‰∏çÂèò)
        // ============================================

        // API endpoints
        const API_ENDPOINTS = {
            orders: 'get_customer_orders.php',
            checkLogin: 'check_login.php'
        };

        // Global variables
        let allOrders = [];
        let currentCustomerId = null;
        let filteredOrders = [];

        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂπ∂Âä†ËΩΩËÆ¢Âçï
        async function loadOrderHistory() {
            console.log('Starting order history load...');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('loginPrompt').classList.add('hidden');
            document.getElementById('ordersList').classList.add('hidden');
            
            try {
                const response = await fetch(API_ENDPOINTS.checkLogin, {
                    credentials: 'include',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                console.log('Login check response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Login check result:', data);
                
                const loginPrompt = document.getElementById('loginPrompt');
                const ordersList = document.getElementById('ordersList');
                const filterControls = document.getElementById('filterControls');
                const orderStats = document.getElementById('orderStats');
                const loadingState = document.getElementById('loadingState');
                
                if (data.logged_in && (data.user_id || data.auto_id)) {
                    console.log('User is logged in');
                    
                    // ÊòæÁ§∫Áî®Êà∑Ê¨¢Ëøé‰ø°ÊÅØ
                    const username = data.username || data.first_name || 'User';
                    document.getElementById('welcomeUser').textContent = username;
                    
                    currentCustomerId = data.user_id || data.auto_id;
                    
                    // ÊòæÁ§∫ËÆ¢ÂçïÂÜÖÂÆπ
                    loginPrompt.classList.add('hidden');
                    ordersList.classList.remove('hidden');
                    filterControls.classList.remove('hidden');
                    orderStats.classList.remove('hidden');
                    loadingState.classList.add('hidden');
                    
                    // Âä†ËΩΩÁî®Êà∑ËÆ¢Âçï
                    await loadCustomerOrders();
                } else {
                    console.log('User is not logged in');
                    // Áî®Êà∑Êú™ÁôªÂΩïÔºåÊòæÁ§∫ÁôªÂΩïÊèêÁ§∫
                    loginPrompt.classList.remove('hidden');
                    ordersList.classList.add('hidden');
                    filterControls.classList.add('hidden');
                    orderStats.classList.add('hidden');
                    loadingState.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading order history:', error);
                showError('Error loading orders. Please try again later.');
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        // Âä†ËΩΩÈ°æÂÆ¢ËÆ¢Âçï
        async function loadCustomerOrders() {
            if (!currentCustomerId) {
                showError('Customer ID not found');
                return;
            }
            
            console.log('Loading orders for customer:', currentCustomerId);
            
            try {
                const response = await fetch(`${API_ENDPOINTS.orders}?customer_id=${currentCustomerId}`, {
                    credentials: 'include',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                console.log('Orders response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch orders: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Orders data received:', data);
                
                if (data.success && data.orders && data.orders.length > 0) {
                    console.log(`Found ${data.orders.length} orders`);
                    allOrders = data.orders;
                    
                    // ÊòæÁ§∫ËÆ¢Âçï
                    filterOrders();
                    
                    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                    if (data.payment_stats) {
                        updatePaymentStats(data);
                    } else {
                        updateStats();
                    }
                    
                    document.getElementById('loadingState').classList.add('hidden');
                } else {
                    console.log('No orders found or API returned error');
                    showNoOrders();
                }
            } catch (error) {
                console.error('Error loading customer orders:', error);
                showError('Error loading orders. Please try again later.');
            }
        }

        // ËøáÊª§ËÆ¢Âçï
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            filteredOrders = allOrders.filter(order => {
                // Áä∂ÊÄÅËøáÊª§
                if (statusFilter !== 'all' && order.status !== statusFilter) {
                    return false;
                }
                
                // Êó•ÊúüËøáÊª§
                if (dateFilter !== 'all') {
                    const days = parseInt(dateFilter);
                    const orderDate = new Date(order.order_date);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    
                    if (orderDate < cutoffDate) {
                        return false;
                    }
                }
                
                return true;
            });
            
            displayOrders(filteredOrders);
        }

        // ÊòæÁ§∫ËÆ¢Âçï
        function displayOrders(orders) {
            const ordersContainer = document.getElementById('ordersContainer');
            
            if (orders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-box-open"></i>
                        <h3>No Orders Found</h3>
                        <p>No orders match your current filters.</p>
                        <button class="btn btn-primary" onclick="resetFilters()" style="margin-top: 15px;">
                            Reset Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            ordersContainer.innerHTML = orders.map(order => {
                const orderDate = new Date(order.order_date);
                const orderItems = order.items || [];
                
                // ËÆ¢ÂçïÂïÜÂìÅÂàóË°®HTML
                const orderItemsHTML = orderItems.length > 0 ? orderItems.map(item => {
                    const bookTitle = item.book_title || item.title || 'Unknown Book';
                    const author = item.author || 'Unknown Author';
                    const quantity = item.quantity || 0;
                    const unitPrice = parseFloat(item.unit_price || item.price || 0).toFixed(2);
                    const subtotal = parseFloat(item.subtotal || (quantity * parseFloat(unitPrice))).toFixed(2);
                    
                    return `
                    <div class="item-card">
                        <div class="item-image">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="item-info">
                            <div class="item-title">${escapeHtml(bookTitle)}</div>
                            <div class="item-author">by ${escapeHtml(author)}</div>
                            <div class="item-meta">
                                <span class="item-quantity">Qty: ${quantity}</span>
                                <span class="item-price">RM ${unitPrice}</span>
                                <span class="item-total">RM ${subtotal}</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('') : '<div class="no-orders"><p>No items found for this order</p></div>';
                
                // ÊîØ‰ªò‰ø°ÊÅØHTML
                const paymentInfoHTML = order.transaction_id ? `
                    <div class="transaction-id">${escapeHtml(order.transaction_id)}</div>
                ` : '';
                
                const notesHTML = order.notes ? `
                    <div style="margin-top: 10px;">
                        <strong>Notes:</strong>
                        <div style="margin-top: 5px;">${escapeHtml(order.notes)}</div>
                    </div>
                ` : '';
                
                return `
                <div class="order-card">
                    <!-- Order Header -->
                    <div class="order-header">
                        <div class="order-meta">
                            <div class="order-id">Order #${order.order_id}</div>
                            <div class="order-date">${orderDate.toLocaleDateString()} at ${orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="status-badge ${getStatusClass(order.status)}">
                            ${getStatusText(order.status)}
                        </div>
                    </div>
                    
                    <!-- Order Details -->
                    <div class="order-details">
                        <div class="detail-item">
                            <div class="detail-label">Shipping Address</div>
                            <div class="detail-value">${escapeHtml(order.shipping_address || 'No address provided')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contact</div>
                            <div class="detail-value">${escapeHtml(order.contact_phone || 'N/A')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Payment Method</div>
                            <div class="detail-value">
                                ${escapeHtml(order.payment_method_display || getPaymentMethodText(order.payment_method) || 'Not Specified')}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Payment Status</div>
                            <div class="payment-badge ${getPaymentStatusClass(order.payment_status)}">
                                ${escapeHtml(order.payment_status_display || order.payment_status || 'Pending')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Items -->
                    <div class="order-items">
                        <h4>Order Items (${orderItems.length})</h4>
                        <div class="item-list">
                            ${orderItemsHTML}
                        </div>
                    </div>
                    
                    <!-- Order Total -->
                    <div class="order-total">
                        <span class="total-label">Total Amount:</span>
                        <span class="total-value">RM ${parseFloat(order.total_amount || 0).toFixed(2)}</span>
                    </div>
                    
                    <!-- Payment History -->
                    <div class="payment-history">
                        <h4>Payment Details</h4>
                        <div class="payment-card ${order.payment_status || 'pending'}">
                            <div class="payment-header">
                                <div class="payment-method">
                                    ${escapeHtml(order.payment_method_display || getPaymentMethodText(order.payment_method) || 'Payment Method')}
                                </div>
                                <div class="payment-date">
                                    ${order.payment_date ? new Date(order.payment_date).toLocaleDateString() : 'Not Paid Yet'}
                                </div>
                            </div>
                            <div class="payment-details">
                                <div class="payment-amount">
                                    RM ${parseFloat(order.payment_amount || order.total_amount || 0).toFixed(2)}
                                </div>
                                ${paymentInfoHTML}
                            </div>
                            ${notesHTML}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats() {
            if (allOrders.length === 0) {
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('totalSpent').textContent = 'RM 0.00';
                document.getElementById('completedPayments').textContent = '0';
                document.getElementById('pendingPayments').textContent = '0';
                return;
            }
            
            // ËÆ°ÁÆóÁªüËÆ°
            const totalSpent = allOrders.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);
            const completedPayments = allOrders.filter(order => order.payment_status === 'completed').length;
            const pendingPayments = allOrders.filter(order => order.payment_status === 'pending').length;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('totalOrders').textContent = allOrders.length;
            document.getElementById('totalSpent').textContent = `RM ${totalSpent.toFixed(2)}`;
            document.getElementById('completedPayments').textContent = completedPayments;
            document.getElementById('pendingPayments').textContent = pendingPayments;
        }

        // Êõ¥Êñ∞ÊîØ‰ªòÁªüËÆ°‰ø°ÊÅØ
        function updatePaymentStats(data) {
            const stats = data.payment_stats || {};
            
            // ÊÄªËÆ¢ÂçïÊï∞
            document.getElementById('totalOrders').textContent = data.order_count || allOrders.length;
            
            // ÊÄªÊ∂àË¥πÈ¢ù
            const totalSpent = stats.total_spent || 
                allOrders.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);
            document.getElementById('totalSpent').textContent = `RM ${totalSpent.toFixed(2)}`;
            
            // ÂÆåÊàêÊîØ‰ªòÊï∞
            document.getElementById('completedPayments').textContent = 
                stats.completed_payments || 
                allOrders.filter(order => order.payment_status === 'completed').length;
            
            // ÂæÖÊîØ‰ªòÊï∞
            document.getElementById('pendingPayments').textContent = 
                stats.pending_payments || 
                allOrders.filter(order => order.payment_status === 'pending').length;
        }

        // ÊòæÁ§∫Êó†ËÆ¢Âçï
        function showNoOrders() {
            const ordersContainer = document.getElementById('ordersContainer');
            ordersContainer.innerHTML = `
                <div class="no-orders">
                    <i class="fas fa-box-open"></i>
                    <h3>No Orders Found</h3>
                    <p>You haven't placed any orders yet.</p>
<<<<<<< HEAD
                    <a href="customer_view.html" class="btn btn-primary" style="margin-top: 15px;">
                        <i class="fas fa-shopping-cart"></i> Start Shopping
=======
                     <a href="customer_view.html" class="btn primary">üõí Start Shopping</a>
>>>>>>> origin/main
                    </a>
                </div>
            `;
        }

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            const ordersContainer = document.getElementById('ordersContainer');
            ordersContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error</h3>
                    <p>${escapeHtml(message)}</p>
                    <button class="btn btn-primary" onclick="loadOrderHistory()" style="margin-top: 15px;">
                        <i class="fas fa-sync-alt"></i> Retry
                    </button>
                </div>
            `;
        }

        // ÈáçÁΩÆËøáÊª§Âô®
        function resetFilters() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('dateFilter').value = 'all';
            filterOrders();
        }

        // Âà∑Êñ∞ËÆ¢Âçï
        function refreshOrders() {
            const ordersContainer = document.getElementById('ordersContainer');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            ordersContainer.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Refreshing orders...</p>
                </div>
            `;
            
            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            loadCustomerOrders();
        }

        // ËæÖÂä©ÂáΩÊï∞
        function getStatusClass(status) {
            const statusMap = {
                'pending': 'status-pending',
                'confirmed': 'status-confirmed',
                'shipped': 'status-shipped',
                'delivered': 'status-delivered',
                'cancelled': 'status-cancelled'
            };
            return statusMap[status] || 'status-pending';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'shipped': 'Shipped',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status;
        }

        function getPaymentStatusClass(status) {
            const statusMap = {
                'pending': 'payment-pending',
                'completed': 'payment-completed',
                'failed': 'payment-failed',
                'refunded': 'payment-refunded'
            };
            return statusMap[status] || 'payment-pending';
        }

        function getPaymentMethodText(method) {
            const methodMap = {
                'credit_card': 'Credit Card',
                'debit_card': 'Debit Card',
                'paypal': 'PayPal',
                'bank_transfer': 'Bank Transfer',
                'cash_on_delivery': 'Cash on Delivery'
            };
            return methodMap[method] || (method ? method.replace('_', ' ').toUpperCase() : 'Not Specified');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÊòæÁ§∫ToastÈÄöÁü•
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÊâßË°å
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Order History Page Loaded');
            loadOrderHistory();
        });
    </script>
</body>
</html>
