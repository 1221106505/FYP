<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Virtual BookStore</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--primary);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo {
            padding: 0 25px 25px;
            border-bottom: 1px solid var(--secondary);
            margin-bottom: 25px;
        }

        .logo h2 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 8px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-links a:hover, .nav-links a.active {
            background: var(--secondary);
            color: white;
            border-left-color: var(--accent);
            transform: translateX(5px);
        }

        .nav-links i {
            width: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 25px;
            background: #f8f9fa;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-weight: 500;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .back-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .back-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        /* ËßíËâ≤ÂæΩÁ´†Ê†∑Âºè */
        .role-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .superadmin-badge {
            background: #1565c0;
            color: white;
            border: 1px solid #0d47a1;
        }

        .admin-badge {
            background: #7b1fa2;
            color: white;
            border: 1px solid #6a1b9a;
        }

        .time-info {
            color: #666;
            font-size: 0.9em;
            margin-left: 8px;
        }

        /* Á°Æ‰øùÊ¨¢ËøéÊ∂àÊÅØÊ≠£Á°ÆÊòæÁ§∫ */
        #adminWelcome {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .section-header h2 {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid var(--accent);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .chart-placeholder {
            height: 320px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            color: #6c757d;
            overflow: hidden;
        }

        /* Analytics Styles */
        .analytics-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .analytics-select {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
        }

        .analytics-metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            margin-bottom: 15px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: white;
            transition: color 0.3s;
        }

        .close:hover {
            color: #bdc3c7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1em;
        }

        .error {
            color: var(--danger);
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
        }

        .success {
            color: var(--success);
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
        }

        /* ‰øÆÂ§çÂ∫ìÂ≠òÁä∂ÊÄÅÊ†∑Âºè */
        .out-of-stock {
            color: var(--danger);
            font-weight: bold;
            background: #ffcccc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .in-stock {
            color: var(--success);
            font-weight: 500;
            background: #ccffcc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .low-stock {
            color: var(--warning);
            font-weight: bold;
            background: #ffeaa7;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Order Status Styles */
        .order-status, .payment-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-shipped {
            background: #cce7ff;
            color: #004085;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Admin Status Styles */
        .admin-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .admin-role {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .role-superadmin {
            background: #e3f2fd;
            color: #1565c0;
        }

        .role-admin {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Êñ∞Ê∑ªÂä†ÁöÑÊ†∑Âºè */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-control:read-only {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        #bookISBN {
            font-family: 'Courier New', monospace;
        }

        /* ÈÄöÁü•Ê†∑Âºè */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        .custom-notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .custom-notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .custom-notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .custom-notification.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ISBNÁîüÊàêÊ†∑Âºè */
        .isbn-generator {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .isbn-generator .form-control {
            flex: 1;
        }

        .isbn-generated {
            background-color: #e8f5e8 !important;
            border-color: #27ae60 !important;
            color: #155724 !important;
        }

        .auto-gen-label {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* Permissions Checkbox Grid */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .permission-category {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .permission-category h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1em;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }

        .permission-item label {
            font-size: 0.9em;
            color: #495057;
            cursor: pointer;
        }

        /* Access Denied Styles */
        .access-denied {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .access-denied i {
            font-size: 4rem;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .access-denied h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .access-denied p {
            color: #666;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .isbn-generator {
                flex-direction: column;
            }
            
            #adminWelcome {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .role-badge {
                margin-left: 0;
            }
            
            .time-info {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>üéØ Admin Panel</h2>
                <p style="color: #bdc3c7; font-size: 0.9em; margin-top: 5px;">Virtual BookStore</p>
            </div>
            <ul class="nav-links" id="mainNav">
                <li><a href="#" class="nav-link active" data-section="dashboard"><i>üìä</i> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="book-inventory"><i>üìö</i> Book & Inventory Management</a></li>
                <li><a href="#" class="nav-link" data-section="orders"><i>üì¶</i> Order Management</a></li>
                <li><a href="#" class="nav-link" data-section="categories"><i>üè∑Ô∏è</i> Categories</a></li>
                <li><a href="#" class="nav-link" data-section="analytics"><i>üìà</i> Sales Report</a></li>
                <li id="adminManagementLink" style="display: none;"><a href="#" class="nav-link" data-section="admin-management"><i>üë•</i> Admin Management</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 id="sectionTitle">Admin Dashboard</h1>
                <div class="user-info">
                    <a href="Main.html" class="back-btn">üè† Back to Main</a>
                    <span id="adminWelcome">Welcome, Administrator</span>
                    <a href="logout.php" class="logout-btn">üö™ Logout</a>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid" id="dashboardStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalBooks">0</div>
                        <div class="stat-label">Total Books</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowStockCount">0</div>
                        <div class="stat-label">Low Stock Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="outOfStock">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayRevenue">RM 0</div>
                        <div class="stat-label">Today's Revenue</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìà Sales Overview</h3>
                    <div class="chart-placeholder" id="salesOverviewChart">
                        Loading sales overview...
                    </div>
                </div>

                <div class="section-header">
                    <h3>üöÄ Quick Actions</h3>
                </div>
                <div id="quickActionsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Dynamic quick actions will be loaded here -->
                </div>
            </section>

            <!-- Combined Book & Inventory Management Section -->
            <section id="book-inventory" class="content-section">
                <div class="section-header">
                    <h2>üìö Book & Inventory Management</h2>
                    <button class="btn btn-primary" id="addBookBtn" onclick="openAddBookModal()">
                        <i>‚ûï</i> Add New Book
                    </button>
                </div>

                <!-- Inventory Summary Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 25px;">
                    <div class="stat-card" style="border-top-color: var(--success);">
                        <div class="stat-number" id="inStockCount">0</div>
                        <div class="stat-label">In Stock</div>
                    </div>
                    <div class="stat-card" style="border-top-color: var(--warning);">
                        <div class="stat-number" id="inventoryLowStock">0</div>
                        <div class="stat-label">Low Stock</div>
                    </div>
                    <div class="stat-card" style="border-top-color: var(--danger);">
                        <div class="stat-number" id="inventoryOutOfStock">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                    <div class="stat-card" style="border-top-color: var(--accent);">
                        <div class="stat-number" id="totalBookCount">0</div>
                        <div class="stat-label">Total Books</div>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="search-box">
                    <input type="text" id="bookSearch" class="search-input" placeholder="üîç Search books by title, author, or ISBN..." onkeyup="searchBooks()">
                    <select id="categoryFilter" class="form-control" style="width: 200px;" onchange="filterBooks()">
                        <option value="all">All Categories</option>
                    </select>
                    <select id="stockFilter" class="form-control" style="width: 200px;" onchange="filterByStock()">
                        <option value="all">All Stock Status</option>
                        <option value="in_stock">In Stock</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="loadAllBooks()">
                        <i>üìö</i> Show All Books
                    </button>
                    <button class="btn btn-warning" onclick="showLowStockBooks()">
                        <i>‚ö†Ô∏è</i> Low Stock Alert
                    </button>
                    <button class="btn btn-danger" onclick="showOutOfStockBooks()">
                        <i>‚ùå</i> Out of Stock
                    </button>
                </div>

                <!-- Books Table -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>ISBN</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="booksInventoryTable">
                            <tr><td colspan="10" class="loading">Loading books and inventory data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Order Management Section -->
            <section id="orders" class="content-section">
                <div class="section-header">
                    <h2>üì¶ Order Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="orderStatusFilter" class="form-control" style="width: 200px;" onchange="filterOrders()">
                            <option value="all">All Status</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshOrders()">
                            <i>üîÑ</i> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="stat-card" style="border-top-color: var(--accent);">
                        <div class="stat-number" id="confirmedOrders">0</div>
                        <div class="stat-label">Confirmed</div>
                    </div>
                    <div class="stat-card" style="border-top-color: var(--info);">
                        <div class="stat-number" id="shippedOrders">0</div>
                        <div class="stat-label">Shipped</div>
                    </div>
                    <div class="stat-card" style="border-top-color: var(--success);">
                        <div class="stat-number" id="deliveredOrders">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                    <div class="stat-card" style="border-top-color: var(--danger);">
                        <div class="stat-number" id="cancelledOrders">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="orderSearch" class="search-input" placeholder="üîç Search orders by ID, customer name, or email..." onkeyup="searchOrders()">
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Order Date</th>
                                <th>Items</th>
                                <th>Total Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr><td colspan="7" class="loading">Loading orders data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Categories Section -->
            <section id="categories" class="content-section">
                <div class="section-header">
                    <h2>üè∑Ô∏è Category Management</h2>
                    <button class="btn btn-primary" id="addCategoryBtn" onclick="openAddCategoryModal()">
                        <i>‚ûï</i> Add Category
                    </button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category Name</th>
                                <th>Book Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTable">
                            <tr><td colspan="4" class="loading">Loading categories...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics Section -->
            <!-- Âú® sales report ÈÉ®ÂàÜÁöÑ section-header ‰∏≠Ê∑ªÂä†ÊåâÈíÆ -->
<!-- Âú® Sales Report ÈÉ®ÂàÜÊ∑ªÂä†Áî®Êà∑ÈÄâÊã©Âô® -->
<section id="analytics" class="content-section">
    <div class="section-header">
        <h2>üìà Sales Report</h2>
        <div class="analytics-controls">
            <!-- Áî®Êà∑ÈÄâÊã©Âô® -->
            <select id="customerFilter" class="analytics-select" onchange="loadCustomerSalesReport()">
                <option value="all">All Customers</option>
                <!-- Âä®ÊÄÅÂä†ËΩΩÂÆ¢Êà∑ÂàóË°® -->
            </select>
            
            <!-- Êó∂Èó¥Âë®ÊúüÈÄâÊã© -->
            <select id="analyticsPeriod" class="analytics-select" onchange="loadCustomerSalesReport()">
                <option value="7days">Last 7 Days</option>
                <option value="30days" selected>Last 30 Days</option>
                <option value="90days">Last 90 Days</option>
                <option value="year">Last Year</option>
                <option value="custom">Custom Range</option>
            </select>
            
            <!-- Ëá™ÂÆö‰πâÊó•ÊúüËåÉÂõ¥ÔºàÈªòËÆ§ÈöêËóèÔºâ -->
            <div id="customDateRange" style="display: none;">
                <input type="date" id="startDate" class="analytics-select">
                <span style="margin: 0 5px;">to</span>
                <input type="date" id="endDate" class="analytics-select">
                <button class="btn btn-sm btn-primary" onclick="applyCustomDateRange()">Apply</button>
            </div>
            
            <!-- PDF Êä•ÂëäÈÄâÈ°π -->
            <select id="pdfReportType" class="analytics-select">
                <option value="full_report">Full Report</option>
                <option value="summary">Executive Summary</option>
                <option value="sales_trend">Sales Trend</option>
                <option value="top_products">Top Products</option>
                <option value="customer_analysis">Customer Analysis</option>
            </select>
            
            <!-- Âä®‰ΩúÊåâÈíÆ -->
            <button class="btn btn-success" onclick="generatePDFReport()">
                <i>üìÑ</i> Generate PDF Report
            </button>
            <button class="btn btn-primary" onclick="refreshSalesReport()">
                <i>üîÑ</i> Refresh
            </button>
        </div>
    </div>
    
    <!-- ÂÆ¢Êà∑‰ø°ÊÅØÊòæÁ§∫ -->
    <div id="customerInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3 id="customerName"></h3>
        <div id="customerDetails"></div>
    </div>
    
    <!-- Summary Stats -->
    <div class="stats-grid" id="analyticsSummary">
        <!-- Dynamic content -->
    </div>
    
    <!-- Charts Container -->
    <div class="chart-container">
        <h3>üìä Sales Trend</h3>
        <div class="chart-placeholder" id="salesTrendChart">
            Loading sales trend...
        </div>
    </div>
    
    <div class="chart-container">
        <h3>üî• Top Selling Books</h3>
        <div class="chart-placeholder" id="topBooksChart">
            Loading top books...
        </div>
    </div>
    
    <div class="chart-container">
        <h3>üè∑Ô∏è Revenue by Category</h3>
        <div class="chart-placeholder" id="categoryRevenueChart">
            Loading category revenue...
        </div>
    </div>
    
    <!-- Customer Details Table -->
    <div class="table-container" id="customerOrdersTableContainer" style="display: none;">
        <h3>üìã Customer Orders</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Items</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="customerOrdersTable">
                <!-- Dynamic content -->
            </tbody>
        </table>
    </div>
</section>
                
                <!-- Summary Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 25px;" id="analyticsSummary">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <div class="chart-container">
                    <h3>üìä Sales Trend</h3>
                    <div class="chart-placeholder" id="salesTrendChart">
                        Loading sales trend...
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üî• Top Selling Books</h3>
                    <div class="chart-placeholder" id="topBooksChart">
                        Loading top books...
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üè∑Ô∏è Revenue by Category</h3>
                    <div class="chart-placeholder" id="categoryRevenueChart">
                        Loading category revenue...
                    </div>
                </div>
            </section>

            <!-- Admin Management Section -->
            <section id="admin-management" class="content-section">
                <div class="section-header">
                    <h2>üë• Admin Management</h2>
                    <button id="addAdminBtn" class="btn btn-primary" style="display: none;" onclick="openAddAdminModal()">
                        <i>‚ûï</i> Add Admin
                    </button>
                </div>

                <!-- Admin Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 25px;" id="adminStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAdmins">0</div>
                        <div class="stat-label">Total Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="superadminCount">0</div>
                        <div class="stat-label">Super Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminCount">0</div>
                        <div class="stat-label">Regular Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeAdmins">0</div>
                        <div class="stat-label">Active Admins</div>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="search-box">
                    <input type="text" id="adminSearch" class="search-input" placeholder="üîç Search admins by username or email..." onkeyup="searchAdmins()">
                    <select id="adminRoleFilter" class="form-control" style="width: 200px;" onchange="filterAdmins()">
                        <option value="all">All Roles</option>
                        <option value="superadmin">Super Admin</option>
                        <option value="admin">Admin</option>
                    </select>
                    <select id="adminStatusFilter" class="form-control" style="width: 200px;" onchange="filterAdmins()">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <!-- Admins Table -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTable">
                            <tr><td colspan="8" class="loading">Loading admin data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- ÊâÄÊúâÊ®°ÊÄÅÁ™óÂè£ -->
    <!-- Add/Edit Book Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Book</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookTitle">üìñ Title *</label>
                            <input type="text" id="bookTitle" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="bookAuthor">‚úçÔ∏è Author *</label>
                            <input type="text" id="bookAuthor" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookCategory">üè∑Ô∏è Category *</label>
                            <select id="bookCategory" class="form-control" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bookPrice">üí∞ Price (RM) *</label>
                            <input type="number" id="bookPrice" class="form-control" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookStock">üì¶ Stock Quantity *</label>
                            <input type="number" id="bookStock" class="form-control" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="bookISBN">üî¢ ISBN 
                                <span class="auto-gen-label" id="isbnStatusLabel">Auto-generated</span>
                            </label>
                            <div class="isbn-generator">
                                <input type="text" id="bookISBN" class="form-control" readonly>
                                <button type="button" class="btn btn-sm btn-info" onclick="regenerateISBN()" style="white-space: nowrap;">
                                    <i>üîÑ</i> Regenerate
                                </button>
                            </div>
                            <small style="color: #666; font-size: 0.85em; display: block; margin-top: 4px;">
                                ISBN is automatically generated. Click "Regenerate" to get a new one.
                            </small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookPublisher">üè¢ Publisher</label>
                            <input type="text" id="bookPublisher" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="bookPublishDate">üìÖ Publish Date</label>
                            <input type="date" id="bookPublishDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bookDescription">üìù Description</label>
                        <textarea id="bookDescription" class="form-control" rows="4" placeholder="Enter book description..."></textarea>
                    </div>
                    <div class="form-group" id="duplicateTitleWarning" style="display: none;">
                        <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <strong>‚ö†Ô∏è Duplicate Title Detected:</strong> 
                            <span id="duplicateWarningText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">‚ùå Cancel</button>
                <button class="btn btn-primary" id="saveBookBtn" onclick="saveBook()">üíæ Save Book</button>
            </div>
        </div>
    </div>

    <!-- Stock Update Modal -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Update Stock</h3>
                <button class="close" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <input type="hidden" id="stockBookId">
                    <div class="form-group">
                        <label>üìñ Book Title</label>
                        <input type="text" id="stockBookTitle" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="newStockQuantity">üîÑ New Stock Quantity *</label>
                        <input type="number" id="newStockQuantity" class="form-control" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeStockModal()">‚ùå Cancel</button>
                <button class="btn btn-primary" onclick="updateStock()">üíæ Update Stock</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="orderModalTitle">Order Details</h3>
                <button class="close" onclick="closeOrderDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="orderModalFooter">
                <!-- Dynamic buttons -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Admin Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="adminModalTitle">Add New Admin</h3>
                <button class="close" onclick="closeAdminModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adminForm">
                    <input type="hidden" id="adminId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="adminUsername">üë§ Username *</label>
                            <input type="text" id="adminUsername" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="adminEmail">üìß Email</label>
                            <input type="email" id="adminEmail" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="adminRole">üëë Role *</label>
                            <select id="adminRole" class="form-control" required onchange="togglePermissions()">
                                <option value="admin">Admin</option>
                                <option value="superadmin">Super Admin</option>
                            </select>
                        </div>
                       
                    </div>
                    
                    <!-- Permissions Section (only for admin role) -->
                    <div id="permissionsSection" style="display: block;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--primary); margin: 0;">üîë Permissions</h4>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn btn-sm btn-primary" onclick="selectAllPermissions()">
                                    <i>‚úì</i> Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-warning" onclick="deselectAllPermissions()">
                                    <i>‚úó</i> Deselect All
                                </button>
                            </div>
                        </div>
                        <div class="permissions-grid" id="permissionsGrid">
                            Loading permissions...
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAdminModal()">‚ùå Cancel</button>
                <button class="btn btn-primary" onclick="saveAdmin()">üíæ Save Admin</button>
            </div>
        </div>
    </div>

    <!-- Admin Details Modal -->
    <div class="modal" id="adminDetailsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="adminDetailsTitle">Admin Details</h3>
                <button class="close" onclick="closeAdminDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="adminDetailsBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAdminDetailsModal()">Close</button>
                <button class="btn btn-warning" id="editAdminBtn" onclick="editAdmin()">‚úèÔ∏è Edit</button>
                <button class="btn btn-danger" id="deleteAdminBtn" onclick="deleteAdmin()">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <!-- Send Password Modal -->
    <div class="modal" id="sendPasswordModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üìß Send Password Email</h3>
                <button class="close" onclick="closeSendPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sendPasswordForm">
                    <input type="hidden" id="passwordAdminId">
                    <div class="form-group">
                        <label for="passwordAdminName">Admin Username</label>
                        <input type="text" id="passwordAdminName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="passwordEmail">üìß Email Address *</label>
                        <input type="email" id="passwordEmail" class="form-control" required>
                    </div>
                    <div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 6px; margin-top: 15px;">
                        <strong>‚ö†Ô∏è Note:</strong> This will generate a new random password and send it to the specified email address.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeSendPasswordModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendPasswordEmail()">üìß Send Password</button>
            </div>
        </div>
    </div>

    <script>
    // ============ GLOBAL VARIABLES ============
    // API endpoints
    const API_ENDPOINTS = {
        books: 'get_book.php',
        bookDetail: 'get_book_detail.php',
        categories: 'get_categories.php',
        stock: 'get_stock_data.php',
        saveBook: 'add_new_book.php',
        deleteBook: 'delete_book.php',
        updateStock: 'update_book_stock.php',
        searchBook: 'search_book.php',
        checkDuplicate: 'check_duplicate_book.php',
        orders: 'getorder.php',
        orderDetail: 'get_single_order.php',
        updateOrder: 'update_order.php',
        salesOverview: 'sales_overview.php',
        salesAnalytics: 'sales_analytics.php',
        addCategory: 'add_category.php',
        updateCategory: 'update_category.php',
        deleteCategory: 'delete_category.php',
        // New Admin Management APIs
        getCurrentAdmin: 'get_current_admin.php',
        getAdmins: 'get_admins.php',
        getAdminDetail: 'get_admin_detail.php',
        saveAdmin: 'save_admin.php',
        updateAdmin: 'edit_admin.php',
        deleteAdmin: 'delete_admin.php',
        sendPasswordEmail: 'send_password_email.php',
        getPermissions: 'get_permissions.php'
    };

    // Current state
    let currentBooks = [];
    let currentCategories = [];
    let currentOrders = [];
    let currentAdmins = [];
    let currentPermissions = [];
    let currentInventoryFilter = 'all';
    let currentOrderId = null;
    let currentGeneratedISBN = '';
    let lastSearchTimeout = null;
    let currentAdminInfo = null;
    let isSuperAdmin = false;
    
    // Permission system
    let currentAdminPermissions = [];
    let accessibleSections = [];

    // Order status mapping
    const ORDER_STATUS_MAP = {
        'confirmed': { text: '‚úÖ Confirmed', class: 'status-confirmed' },
        'shipped': { text: 'üöö Shipped', class: 'status-shipped' },
        'delivered': { text: 'üì¶ Delivered', class: 'status-delivered' },
        'cancelled': { text: '‚ùå Cancelled', class: 'status-cancelled' }
    };

    // Admin role mapping
    const ADMIN_ROLE_MAP = {
        'superadmin': { text: 'üëë Super Admin', class: 'role-superadmin' },
        'admin': { text: 'üë§ Admin', class: 'role-admin' }
    };

    // Admin status mapping
    const ADMIN_STATUS_MAP = {
        'active': { text: '‚úÖ Active', class: 'status-active' },
        'inactive': { text: '‚ùå Inactive', class: 'status-inactive' }
    };

    // ============ PERMISSION SYSTEM ============
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÂÆöÊùÉÈôê
    function hasPermission(permissionKey) {
        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊã•ÊúâÊâÄÊúâÊùÉÈôê
        if (isSuperAdmin) {
            return true;
        }
        
        // Ê£ÄÊü•ÊùÉÈôêÂàóË°®
        return currentAdminPermissions.some(perm => perm.permission_key === permissionKey);
    }
    
    // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªªÊÑèÊåáÂÆöÊùÉÈôê
    function hasAnyPermission(permissionKeys) {
        if (isSuperAdmin) return true;
        return permissionKeys.some(key => hasPermission(key));
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊâÄÊúâÊåáÂÆöÊùÉÈôê
    function hasAllPermissions(permissionKeys) {
        if (isSuperAdmin) return true;
        return permissionKeys.every(key => hasPermission(key));
    }

    // Ê†πÊçÆÊùÉÈôêÊéßÂà∂ÂØºËà™ËèúÂçïÊòæÁ§∫
    function updateNavigationBasedOnPermissions() {
    console.log('Updating navigation for:', {
        sections: accessibleSections,
        isSuperAdmin: isSuperAdmin
    });
    
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        const section = link.getAttribute('data-section');
        const parentLi = link.parentElement;
        
        // ‰ª™Ë°®ÊùøÈªòËÆ§ÊòæÁ§∫ÁªôÊâÄÊúâ‰∫∫
        if (section === 'dashboard') {
            parentLi.style.display = 'list-item';
            return;
        }
        
        // ÁÆ°ÁêÜÂëòÁÆ°ÁêÜÂè™ÂØπË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊòæÁ§∫
        if (section === 'admin-management') {
            parentLi.style.display = isSuperAdmin ? 'list-item' : 'none';
            return;
        }
        
        // ÂÖ∂‰ªñÈ°µÈù¢Ê†πÊçÆÂèØËÆøÈóÆÈ°µÈù¢Êï∞ÁªÑÂÜ≥ÂÆö
        if (accessibleSections.includes(section)) {
            parentLi.style.display = 'list-item';
        } else {
            parentLi.style.display = 'none';
        }
    });
}

    // Ê†πÊçÆÊùÉÈôêÊéßÂà∂‰ª™Ë°®ÊùøÂø´ÈÄüÊìç‰ΩúÊåâÈíÆ
    function updateDashboardQuickActions() {
        const actionsContainer = document.getElementById('quickActionsContainer');
        if (!actionsContainer) return;
        
        // ÈáçÊñ∞ÊûÑÂª∫Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ
        const quickActions = [];
        
        // ‰π¶Á±çÁÆ°ÁêÜÁõ∏ÂÖ≥
        if (hasAnyPermission(['view_books', 'manage_books'])) {
            quickActions.push(`
                <button class="btn btn-primary" onclick="loadSectionData('book-inventory')">
                    <i>üìö</i> Manage Books & Inventory
                </button>
            `);
        }
        
        if (hasPermission('manage_books')) {
            quickActions.push(`
                <button class="btn btn-success" onclick="openAddBookModal()">
                    <i>‚ûï</i> Add New Book
                </button>
            `);
        }
        
        // ËÆ¢ÂçïÁÆ°ÁêÜ
        if (hasPermission('manage_orders')) {
            quickActions.push(`
                <button class="btn btn-info" onclick="loadSectionData('orders')">
                    <i>üì¶</i> View Orders
                </button>
            `);
        }
        
        // ÈîÄÂîÆÊä•Âëä
        if (hasPermission('view_analytics')) {
            quickActions.push(`
                <button class="btn btn-primary" onclick="loadSectionData('analytics')">
                    <i>üìà</i> View Sales Report 
                </button>
            `);
        }
        
        // ÁÆ°ÁêÜÂëòÁÆ°ÁêÜÔºà‰ªÖË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºâ
        if (isSuperAdmin) {
            quickActions.push(`
                <button id="adminManagementBtn" class="btn btn-warning" onclick="loadSectionData('admin-management')">
                    <i>üë•</i> Manage Admins
                </button>
            `);
        }
        
        // Â¶ÇÊûúÊ≤°ÊúâÊùÉÈôêÔºåÊòæÁ§∫Ê∂àÊÅØ
        if (quickActions.length === 0) {
            actionsContainer.innerHTML = `
                <div class="access-denied">
                    <i>üîí</i>
                    <h3>No Access Permissions</h3>
                    <p>You don't have permission to perform any actions.</p>
                    <p>Please contact your super administrator.</p>
                </div>
            `;
        } else {
            actionsContainer.innerHTML = quickActions.join('');
        }
    }

    // Ê†πÊçÆÊùÉÈôêÊéßÂà∂‰π¶Á±çÁÆ°ÁêÜÈÉ®ÂàÜ
    function updateBookManagementSection() {
        // ÊéßÂà∂Ê∑ªÂä†ÊåâÈíÆ
        const addBookBtn = document.getElementById('addBookBtn');
        if (addBookBtn) {
            addBookBtn.style.display = hasPermission('manage_books') ? 'inline-flex' : 'none';
        }
        
        // ÊéßÂà∂Ë°®Ê†ºÊìç‰ΩúÊåâÈíÆ
        setTimeout(() => {
            document.querySelectorAll('#booksInventoryTable .action-buttons').forEach(actionsCell => {
                const editBtn = actionsCell.querySelector('.btn-primary');
                const stockBtn = actionsCell.querySelector('.btn-warning');
                const deleteBtn = actionsCell.querySelector('.btn-danger');
                
                if (editBtn) {
                    editBtn.style.display = hasPermission('manage_books') ? 'inline-flex' : 'none';
                }
                
                if (stockBtn) {
                    stockBtn.style.display = hasPermission('manage_inventory') ? 'inline-flex' : 'none';
                }
                
                if (deleteBtn) {
                    deleteBtn.style.display = hasPermission('manage_books') ? 'inline-flex' : 'none';
                }
                
                // Â¶ÇÊûúÊâÄÊúâÊåâÈíÆÈÉΩÈöêËóè‰∫ÜÔºåÈöêËóèÊï¥‰∏™ÂçïÂÖÉÊ†º
                const visibleButtons = actionsCell.querySelectorAll('.btn[style*="inline-flex"], .btn:not([style*="none"])');
                if (visibleButtons.length === 0) {
                    actionsCell.style.display = 'none';
                }
            });
        }, 500);
    }

    // Ê†πÊçÆÊùÉÈôêÊéßÂà∂ËÆ¢ÂçïÁÆ°ÁêÜÈÉ®ÂàÜ
    function updateOrderManagementSection() {
        // ÊéßÂà∂Ë°®Ê†ºÊìç‰ΩúÊåâÈíÆ
        setTimeout(() => {
            document.querySelectorAll('#ordersTable .action-buttons').forEach(actionsCell => {
                const viewBtn = actionsCell.querySelector('.btn-primary');
                const updateBtn = actionsCell.querySelector('.btn-warning');
                
                if (viewBtn) {
                    viewBtn.style.display = hasPermission('manage_orders') ? 'inline-flex' : 'none';
                }
                
                if (updateBtn) {
                    updateBtn.style.display = hasPermission('manage_orders') ? 'inline-flex' : 'none';
                }
                
                // Â¶ÇÊûúÊâÄÊúâÊåâÈíÆÈÉΩÈöêËóè‰∫ÜÔºåÈöêËóèÊï¥‰∏™ÂçïÂÖÉÊ†º
                const visibleButtons = actionsCell.querySelectorAll('.btn[style*="inline-flex"], .btn:not([style*="none"])');
                if (visibleButtons.length === 0) {
                    actionsCell.style.display = 'none';
                }
            });
        }, 500);
    }

    // Ê†πÊçÆÊùÉÈôêÊéßÂà∂ÂàÜÁ±ªÁÆ°ÁêÜÈÉ®ÂàÜ
    function updateCategoryManagementSection() {
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        if (addCategoryBtn) {
            addCategoryBtn.style.display = hasPermission('manage_categories') ? 'inline-flex' : 'none';
        }
        
        // ÊéßÂà∂Ë°®Ê†ºÊìç‰ΩúÊåâÈíÆ
        setTimeout(() => {
            document.querySelectorAll('#categoriesTable .action-buttons').forEach(actionsCell => {
                const editBtn = actionsCell.querySelector('.btn-warning');
                const deleteBtn = actionsCell.querySelector('.btn-danger');
                
                if (editBtn) {
                    editBtn.style.display = hasPermission('manage_categories') ? 'inline-flex' : 'none';
                }
                
                if (deleteBtn) {
                    deleteBtn.style.display = hasPermission('manage_categories') ? 'inline-flex' : 'none';
                }
                
                // Â¶ÇÊûúÊâÄÊúâÊåâÈíÆÈÉΩÈöêËóè‰∫ÜÔºåÈöêËóèÊï¥‰∏™ÂçïÂÖÉÊ†º
                const visibleButtons = actionsCell.querySelectorAll('.btn[style*="inline-flex"], .btn:not([style*="none"])');
                if (visibleButtons.length === 0) {
                    actionsCell.style.display = 'none';
                }
            });
        }, 500);
    }

    // Â∫îÁî®ÁâπÂÆöÈ°µÈù¢ÁöÑÊùÉÈôêÊéßÂà∂
    function applySectionPermissions(sectionId) {
        switch(sectionId) {
            case 'dashboard':
                // ‰ª™Ë°®ÊùøÊùÉÈôêÂ∑≤Áî±updateDashboardQuickActionsÂ§ÑÁêÜ
                break;
            case 'book-inventory':
                updateBookManagementSection();
                break;
            case 'orders':
                updateOrderManagementSection();
                break;
            case 'categories':
                updateCategoryManagementSection();
                break;
            case 'analytics':
                // Â¶ÇÊûúÊ≤°ÊúâÊü•ÁúãÊä•ÂëäÁöÑÊùÉÈôêÔºåÊòæÁ§∫ÊèêÁ§∫
                if (!hasPermission('view_analytics') && !isSuperAdmin) {
                    document.querySelector('#analytics').innerHTML = `
                        <div class="access-denied">
                            <i>üîí</i>
                            <h3>Access Denied</h3>
                            <p>You don't have permission to view analytics reports.</p>
                            <p>Please contact your super administrator for access.</p>
                        </div>
                    `;
                }
                break;
            case 'admin-management':
                // ÁÆ°ÁêÜÂëòÁÆ°ÁêÜÈÉ®ÂàÜÂè™ÂØπË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂºÄÊîæ
                if (!isSuperAdmin) {
                    document.querySelector('#admin-management').innerHTML = `
                        <div class="access-denied">
                            <i>üîí</i>
                            <h3>Access Denied</h3>
                            <p>Admin management is only available for super administrators.</p>
                        </div>
                    `;
                }
                break;
        }
    }
function hasPermission(permissionKey) {
    console.log('Checking permission:', permissionKey, {
        isSuperAdmin: isSuperAdmin,
        currentPermissions: currentAdminPermissions
    });
    
    // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊã•ÊúâÊâÄÊúâÊùÉÈôê
    if (isSuperAdmin) {
        console.log('Super admin has all permissions');
        return true;
    }
    
    // Â¶ÇÊûúÊùÉÈôêÊï∞ÊçÆ‰∏∫Á©∫Ôºå‰ΩøÁî®fallback
    if (!currentAdminPermissions || currentAdminPermissions.length === 0) {
        console.warn('No permissions loaded, using fallback');
        return hasFallbackPermission(permissionKey);
    }
    
    // Ê£ÄÊü•ÊùÉÈôêÂàóË°®
    const hasPerm = currentAdminPermissions.some(perm => {
        const match = perm.permission_key === permissionKey;
        if (match) console.log('Permission found:', perm);
        return match;
    });
    
    console.log('Permission result:', hasPerm);
    return hasPerm;
}

// Ê∑ªÂä†fallbackÊùÉÈôêÊ£ÄÊü•ÔºàÂΩìÊùÉÈôêÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•Êó∂‰ΩøÁî®Ôºâ
function hasFallbackPermission(permissionKey) {
    // ÈªòËÆ§ÊâÄÊúâÁÆ°ÁêÜÂëòÈÉΩÊúâËøô‰∫õÂü∫Êú¨ÊùÉÈôê
    const basicPermissions = ['view_dashboard', 'view_books', 'view_orders', 'view_analytics'];
    return basicPermissions.includes(permissionKey);
}

// ÂàùÂßãÂåñÊùÉÈôêÁ≥ªÁªü
// ‰øÆÂ§çÊùÉÈôêÁ≥ªÁªüÂàùÂßãÂåñ
async function initializePermissionSystem() {
    try {
        const response = await fetch(API_ENDPOINTS.getCurrentAdmin);
        const data = await response.json();
        
        if (data.success) {
            currentAdminInfo = data;
            isSuperAdmin = data.role === 'superadmin';
            
            console.log('Admin info loaded:', {
                username: data.username,
                role: data.role,
                isSuperAdmin: isSuperAdmin
            });
            
            updateAdminDisplay();
            
            // Âä†ËΩΩÊùÉÈôêÊï∞ÊçÆÔºàÈùûË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊâçÈúÄË¶ÅÔºâ
            if (!isSuperAdmin) {
                await loadAdminPermissions();
            } else {
                currentAdminPermissions = [];
                accessibleSections = ['dashboard', 'book-inventory', 'orders', 'categories', 'analytics', 'admin-management'];
            }
            
            // Êõ¥Êñ∞ÁïåÈù¢
            updateNavigationBasedOnPermissions();
            updateDashboardQuickActions();
            
            // Â∫îÁî®ÂΩìÂâçÈ°µÈù¢ÁöÑÊùÉÈôêÊéßÂà∂
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const sectionId = activeSection.id;
                applySectionPermissions(sectionId);
            }
            
        } else {
            console.error('Failed to load admin info:', data.error);
            fallbackToDefault('Failed to load admin info');
        }
    } catch (error) {
        console.error('Error initializing permission system:', error);
        fallbackToDefault('Network error: ' + error.message);
    }
}

// Ê∑ªÂä†ÊùÉÈôêÂä†ËΩΩÂáΩÊï∞
async function loadAdminPermissions() {
    try {
        // ÂÅáËÆæ‰Ω†ÊúâËé∑ÂèñÊùÉÈôêÁöÑAPIÔºåÊàñËÄÖ‰øÆÊîπ get_current_admin.php ËøîÂõûÊùÉÈôê
        const response = await fetch('get_admin_permissions.php');
        const data = await response.json();
        
        if (data.success) {
            currentAdminPermissions = data.permissions || [];
            accessibleSections = data.accessible_sections || [];
            
            console.log('Admin permissions loaded:', {
                permissions: currentAdminPermissions,
                accessibleSections: accessibleSections
            });
        } else {
            console.warn('Could not load permissions:', data.error);
            currentAdminPermissions = [];
            accessibleSections = ['dashboard']; // ÈªòËÆ§Âè™Êúâ‰ª™Ë°®Êùø
        }
    } catch (error) {
        console.error('Error loading permissions:', error);
        currentAdminPermissions = [];
        accessibleSections = ['dashboard'];
    }
}

    // ============ INITIALIZATION ============
    
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('Admin panel initialized');
        
        // Check current admin role
        await checkAdminRole();
        
        // ÂàùÂßãÂåñÊùÉÈôêÁ≥ªÁªü
        await initializePermissionSystem();
        
        // Load initial data
        loadDashboardData();
        
        // Update clock
        updateClock();
        setInterval(updateClock, 60000);
        
        // Set up navigation
        setupNavigation();
        
        // Set up permissions listeners
        setupPermissionsListeners();
    });

    async function checkAdminRole() {
        console.log('=== CHECKING ADMIN ROLE ===');
        
        try {
            console.log('Making API request to:', API_ENDPOINTS.getCurrentAdmin);
            const response = await fetch(API_ENDPOINTS.getCurrentAdmin);
            console.log('Response status:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Parsed JSON data:', data);
            
            if (data.success) {
                console.log('‚úÖ API returned success');
                console.log('Admin data received:', {
                    username: data.username,
                    role: data.role,
                    admin_id: data.admin_id
                });
                
                currentAdminInfo = data;
                isSuperAdmin = data.role === 'superadmin';
                
                console.log('isSuperAdmin determined:', isSuperAdmin, 'based on role:', data.role);
                
                updateAdminDisplay();
                
                // Â¶ÇÊûúAPIËøîÂõû‰∫ÜÊ¨¢ËøéÊ∂àÊÅØÔºå‰πüÊòæÁ§∫
                if (data.welcome_message) {
                    showNotification(data.welcome_message, 'info');
                }
            } else {
                console.error('‚ùå API returned error:', data.error);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊú™ÁôªÂΩïÈîôËØØ
                if (data.error && data.error.includes('Not logged in')) {
                    console.warn('User not logged in via session');
                    // ÊòæÁ§∫ÁôªÂΩïÊèêÁ§∫
                    showNotification('Please login first', 'warning');
                    // ÂèØ‰ª•ÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                    // setTimeout(() => window.location.href = 'admin_login.html', 2000);
                }
                
                // ‰ΩøÁî®ÈªòËÆ§ÂÄºÁªßÁª≠
                fallbackToDefault('API error: ' + data.error);
            }
        } catch (error) {
            console.error('‚ùå Network/fetch error:', error);
            console.error('Error details:', error.message);
            fallbackToDefault('Network error: ' + error.message);
        }
    }

    function fallbackToDefault(reason) {
        console.log('Using fallback admin info. Reason:', reason);
        currentAdminInfo = { 
            username: 'Administrator', 
            role: 'admin' 
        };
        isSuperAdmin = false;
        updateAdminDisplay();
    }

    function updateAdminDisplay() {
        // Êõ¥Êñ∞Ê¨¢ËøéÊ∂àÊÅØ
        updateWelcomeMessage();
        
        // ÊéßÂà∂ÁÆ°ÁêÜÂëòÁÆ°ÁêÜÂäüËÉΩÁöÑÊòæÁ§∫
        toggleAdminManagement();
    }

    function updateWelcomeMessage() {
        const welcomeElement = document.getElementById('adminWelcome');
        
        if (!currentAdminInfo) {
            welcomeElement.innerHTML = 'Welcome, <strong>Admin</strong>';
            return;
        }
        
        // Ê†πÊçÆËßíËâ≤ÂàõÂª∫ÂæΩÁ´†
        let roleBadge = '';
        if (currentAdminInfo.role === 'superadmin') {
            roleBadge = '<span class="role-badge superadmin-badge">üëë Super Admin</span>';
        } else {
            roleBadge = '<span class="role-badge admin-badge">üë§ Admin</span>';
        }
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit'
        });
        const dateString = now.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        });
        
        welcomeElement.innerHTML = `
            Welcome, <strong>${currentAdminInfo.username}</strong>
            ${roleBadge}
            <span class="time-info">‚Ä¢ ${dateString} ${timeString}</span>
        `;
    }

    function toggleAdminManagement() {
        const superAdminElements = [
            'adminManagementLink',
            'adminManagementBtn',
            'addAdminBtn'
        ];
        
        superAdminElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (isSuperAdmin) {
                    element.style.display = 'inline-flex';
                } else {
                    element.style.display = 'none';
                }
            }
        });
        
        // ÁâπÂà´Â§ÑÁêÜÂØºËà™ÈìæÊé•ÁöÑÊòæÁ§∫ÊñπÂºè
        const adminManagementLink = document.getElementById('adminManagementLink');
        if (adminManagementLink) {
            adminManagementLink.style.display = isSuperAdmin ? 'list-item' : 'none';
        }
    }

    function updateClock() {
        if (!currentAdminInfo) return;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit'
            
        });
        const dateString = now.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        });
        
        const welcomeElement = document.getElementById('adminWelcome');
        
        let roleBadge = '';
        if (currentAdminInfo.role === 'superadmin') {
            roleBadge = '<span class="role-badge superadmin-badge">üëë Super Admin</span>';
        } else {
            roleBadge = '<span class="role-badge admin-badge">üë§ Admin</span>';
        }
        
        welcomeElement.innerHTML = `
            Welcome, <strong>${currentAdminInfo.username}</strong>
            ${roleBadge}
            <span class="time-info">‚Ä¢ ${dateString} ${timeString}</span>
        `;
    }

    function setupNavigation() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÁÆ°ÁêÜÂëòÁÆ°ÁêÜÔºå‰ΩÜ‰∏çÊòØË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºåÈòªÊ≠¢ËÆøÈóÆ
                if (this.getAttribute('data-section') === 'admin-management' && !isSuperAdmin) {
                    showNotification('Access denied. Super Admin only.', 'error');
                    return;
                }
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                const sectionId = this.getAttribute('data-section');
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                
                const sectionTitles = {
                    'dashboard': 'Dashboard',
                    'book-inventory': 'Book & Inventory Management',
                    'orders': 'Order Management',
                    'categories': 'Category Management',
                    'analytics': 'Sales Report Section',
                    'admin-management': 'Admin Management',
                    'settings': 'System Settings'
                };
                document.getElementById('sectionTitle').textContent = sectionTitles[sectionId];
                
                loadSectionData(sectionId);
            });
        });
    }

    function loadSectionData(sectionId) {
        switch(sectionId) {
            case 'dashboard':
                loadDashboardData();
                loadSalesOverview();
                break;
            case 'book-inventory':
                loadBookInventoryData();
                break;
            case 'orders':
                loadOrdersData();
                break;
            case 'analytics':
                loadSalesAnalytics();
                break;
            case 'categories':
                loadCategoriesData();
                break;
            case 'admin-management':
                if (isSuperAdmin) {
                    loadAdminManagementData();
                } else {
                    showNotification('Access denied. Super Admin only.', 'error');
                    document.querySelector('.nav-link[data-section="dashboard"]').click();
                }
                break;
        }
    }

    // ============ DASHBOARD FUNCTIONS ============
    
    async function loadDashboardData() {
        try {
            const [booksResponse, categoriesResponse, ordersResponse] = await Promise.all([
                fetch(API_ENDPOINTS.books),
                fetch(API_ENDPOINTS.categories),
                fetch(API_ENDPOINTS.orders)
            ]);

            const booksData = await booksResponse.json();
            const categoriesData = await categoriesResponse.json();
            const ordersData = await ordersResponse.json();
            
            if (booksData.success) {
                const books = booksData.books || booksData.data || [];
                document.getElementById('totalBooks').textContent = books.length;
                
                const lowStockCount = books.filter(book => {
                    const stock = parseInt(book.stock_quantity);
                    return stock >= 1 && stock <= 10;
                }).length;
                
                const outOfStockCount = books.filter(book => {
                    const stock = parseInt(book.stock_quantity);
                    return stock === 0;
                }).length;
                
                document.getElementById('lowStockCount').textContent = lowStockCount;
                document.getElementById('outOfStock').textContent = outOfStockCount;
            } else {
                console.error('Error loading books:', booksData.error);
            }

            if (categoriesData.success) {
                const categories = categoriesData.categories || categoriesData.data || [];
                document.getElementById('totalCategories').textContent = categories.length;
            } else {
                console.error('Error loading categories:', categoriesData.error);
            }

            if (ordersData.success) {
                const orders = ordersData.orders || [];
                document.getElementById('totalOrders').textContent = orders.length;
            } else {
                console.error('Error loading orders:', ordersData.error);
            }

        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showNotification('Error loading dashboard data', 'error');
        }
    }

    // ============ ORDER FUNCTIONS ============
    
    async function loadOrdersData() {
        try {
            const response = await fetch(API_ENDPOINTS.orders);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                currentOrders = data.orders || data.data || [];
                updateOrderStats(currentOrders);
                displayOrders(currentOrders);
                updateOrderManagementSection();
            } else {
                console.error('Error loading orders:', data.error);
                document.getElementById('ordersTable').innerHTML = 
                    '<tr><td colspan="7" class="error">Error loading orders: ' + (data.error || 'Unknown error') + '</td></tr>';
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('ordersTable').innerHTML = 
                '<tr><td colspan="7" class="error">Error loading orders. Please check the console.</td></tr>';
        }
    }

    function updateOrderStats(orders) {
        const confirmed = orders.filter(order => order.status === 'confirmed').length;
        const shipped = orders.filter(order => order.status === 'shipped').length;
        const delivered = orders.filter(order => order.status === 'delivered').length;
        const cancelled = orders.filter(order => order.status === 'cancelled').length;
        
        document.getElementById('confirmedOrders').textContent = confirmed;
        document.getElementById('shippedOrders').textContent = shipped;
        document.getElementById('deliveredOrders').textContent = delivered;
        document.getElementById('cancelledOrders').textContent = cancelled;
    }

    function displayOrders(orders) {
        const ordersTable = document.getElementById('ordersTable');
        
        if (!orders || orders.length === 0) {
            ordersTable.innerHTML = '<tr><td colspan="7" class="loading">No orders found</td></tr>';
            return;
        }

        ordersTable.innerHTML = orders.map(order => {
            let status = order.status;
            if (status === 'pending') {
                status = 'confirmed';
            }
            
            const statusInfo = ORDER_STATUS_MAP[status] || { text: status, class: 'status-confirmed' };
            const customerName = order.customer_name || order.customer_name || `Customer ${order.customer_id || 'N/A'}`;
            const contactEmail = order.contact_email || order.email || 'No email';
            
            return `
            <tr>
                <td><strong>#${order.order_id || order.id || 'N/A'}</strong></td>
                <td>
                    <div><strong>${customerName}</strong></div>
                    <div style="font-size: 0.8em; color: #666;">${contactEmail}</div>
                </td>
                <td>${order.order_date ? new Date(order.order_date).toLocaleDateString() : 'N/A'}</td>
                <td>
                    <div>${order.item_count || order.total_items || 0} items</div>
                    <div style="font-size: 0.8em; color: #666;">${order.total_quantity || 0} total</div>
                </td>
                <td><strong>RM ${parseFloat(order.total_amount || order.total_price || 0).toFixed(2)}</strong></td>
                <td>
                    <span class="order-status ${statusInfo.class}">
                        ${statusInfo.text}
                    </span>
                </td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-primary" onclick="viewOrderDetails(${order.order_id || order.id})">
                        üëÅÔ∏è View
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="openUpdateOrderStatusModal(${order.order_id || order.id}, '${status}')">
                        ‚úèÔ∏è Update
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }

    function filterOrders() {
        const statusFilter = document.getElementById('orderStatusFilter').value;
        
        let filteredOrders = currentOrders || [];
        
        if (statusFilter !== 'all') {
            filteredOrders = filteredOrders.filter(order => {
                let status = order.status;
                if (status === 'pending') {
                    status = 'confirmed';
                }
                return status === statusFilter;
            });
        }
        
        displayOrders(filteredOrders);
        updateOrderManagementSection();
    }

    function searchOrders() {
        if (lastSearchTimeout) {
            clearTimeout(lastSearchTimeout);
        }
        
        lastSearchTimeout = setTimeout(function() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            
            if (searchTerm.length < 2) {
                displayOrders(currentOrders);
                updateOrderManagementSection();
                return;
            }
            
            const filteredOrders = (currentOrders || []).filter(order => {
                const orderId = (order.order_id || order.id || '').toString();
                const customerName = (order.customer_name || order.customer_name || '').toLowerCase();
                const contactEmail = (order.contact_email || order.email || '').toLowerCase();
                
                return orderId.includes(searchTerm) ||
                       customerName.includes(searchTerm) ||
                       contactEmail.includes(searchTerm);
            });
            
            displayOrders(filteredOrders);
            updateOrderManagementSection();
        }, 300);
    }

    function refreshOrders() {
        loadOrdersData();
    }

    async function viewOrderDetails(orderId) {
        try {
            const response = await fetch(`${API_ENDPOINTS.orderDetail}?order_id=${orderId}`);
            const data = await response.json();
            
            if (data.success) {
                showOrderDetailsModal(data.order || data.data);
            } else {
                showNotification('Error loading order details: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error loading order details:', error);
            showNotification('Error loading order details', 'error');
        }
    }

    function showOrderDetailsModal(order) {
        if (!order) {
            showNotification('No order data available', 'error');
            return;
        }
        
        currentOrderId = order.order_id || order.id;
        
        document.getElementById('orderModalTitle').textContent = `Order #${currentOrderId} Details`;
        
        const itemsHtml = order.items && order.items.length > 0 ? order.items.map(item => `
            <div class="order-item" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                <div style="font-weight: 600; margin-bottom: 5px;">${item.title || item.name || 'Unknown Book'}</div>
                <div style="display: flex; gap: 15px; font-size: 0.9em; color: #666;">
                    <span>Qty: ${item.quantity || 0}</span>
                    <span>Price: RM ${parseFloat(item.unit_price || item.price || 0).toFixed(2)}</span>
                    <span>Subtotal: RM ${parseFloat(item.subtotal || (item.quantity * (item.unit_price || item.price) || 0)).toFixed(2)}</span>
                </div>
            </div>
        `).join('') : '<div style="color: #666; font-style: italic;">No items found</div>';
        
        let displayStatus = order.status;
        if (displayStatus === 'pending') {
            displayStatus = 'confirmed';
        }
        
        document.getElementById('orderModalBody').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Customer Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div style="margin-bottom: 8px;"><strong>Customer ID:</strong> ${order.customer_id || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Name:</strong> ${order.customer_name || order.customer_name || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Email:</strong> ${order.contact_email || order.email || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Phone:</strong> ${order.contact_phone || order.phone || 'N/A'}</div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Order Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div style="margin-bottom: 8px;"><strong>Order Date:</strong> ${order.order_date ? new Date(order.order_date).toLocaleString() : 'N/A'}</div>
                        <div style="margin-bottom: 8px;">
                            <strong>Status:</strong> 
                            <span class="order-status ${ORDER_STATUS_MAP[displayStatus]?.class || 'status-confirmed'}">
                                ${ORDER_STATUS_MAP[displayStatus]?.text || displayStatus || 'Confirmed'}
                            </span>
                        </div>
                        <div style="margin-bottom: 8px;"><strong>Total Amount:</strong> RM ${parseFloat(order.total_amount || order.total_price || 0).toFixed(2)}</div>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Shipping Address</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-line;">
                        ${order.shipping_address || order.address || 'No shipping address provided'}
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Order Items (${order.items ? order.items.length : 0})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${itemsHtml}
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('orderModalFooter').innerHTML = `
            <button class="btn" onclick="closeOrderDetailsModal()">Close</button>
            <button class="btn btn-warning" onclick="openUpdateOrderStatusModal(${currentOrderId}, '${displayStatus}')">Update Status</button>
        `;
        
        document.getElementById('orderDetailsModal').style.display = 'flex';
    }

    function closeOrderDetailsModal() {
        document.getElementById('orderDetailsModal').style.display = 'none';
        currentOrderId = null;
    }

    function openUpdateOrderStatusModal(orderId, currentStatus) {
        currentOrderId = orderId;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'updateStatusModal';
        modal.style.display = 'flex';
        
        let displayStatus = currentStatus;
        if (displayStatus === 'pending') {
            displayStatus = 'confirmed';
        }
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>Update Order Status</h3>
                    <button class="close" onclick="closeUpdateStatusModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newOrderStatus">Select New Status:</label>
                        <select id="newOrderStatus" class="form-control">
                            <option value="confirmed" ${displayStatus === 'confirmed' ? 'selected' : ''}>‚úÖ Confirmed</option>
                            <option value="shipped" ${displayStatus === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
                            <option value="delivered" ${displayStatus === 'delivered' ? 'selected' : ''}>üì¶ Delivered</option>
                            <option value="cancelled" ${displayStatus === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeUpdateStatusModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function closeUpdateStatusModal() {
        const modal = document.getElementById('updateStatusModal');
        if (modal) modal.remove();
        currentOrderId = null;
    }

    async function updateOrderStatus() {
        if (!currentOrderId) return;
        
        const newStatus = document.getElementById('newOrderStatus').value;
        
        if (!newStatus) {
            showNotification('Please select a status', 'warning');
            return;
        }
        
        try {
            const response = await fetch(API_ENDPOINTS.updateOrder, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_id: currentOrderId,
                    status: newStatus
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Order status updated successfully!', 'success');
                closeUpdateStatusModal();
                closeOrderDetailsModal();
                loadOrdersData();
            } else {
                showNotification('Error updating order status: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error updating order status:', error);
            showNotification('Error updating order status', 'error');
        }
    }

    // ============ BOOK FUNCTIONS ============
    
    async function loadBookInventoryData() {
        try {
            const [booksResponse, categoriesResponse] = await Promise.all([
                fetch(API_ENDPOINTS.books),
                fetch(API_ENDPOINTS.categories)
            ]);

            const booksData = await booksResponse.json();
            const categoriesData = await categoriesResponse.json();

            if (booksData.success) {
                currentBooks = booksData.books || booksData.data || [];
                updateBookInventoryStats(currentBooks);
                displayBookInventory(currentBooks);
                document.getElementById('totalBookCount').textContent = currentBooks.length;
                updateBookManagementSection();
            }

            if (categoriesData.success) {
                currentCategories = categoriesData.categories || categoriesData.data || [];
                loadCategoryFilter();
            }
        } catch (error) {
            console.error('Error loading book inventory:', error);
            document.getElementById('booksInventoryTable').innerHTML = '<tr><td colspan="10" class="error">Error loading data</td></tr>';
        }
    }

    function updateBookInventoryStats(books) {
        const inStockCount = books.filter(book => {
            const stock = parseInt(book.stock_quantity);
            return stock > 10;
        }).length;
        
        const lowStockCount = books.filter(book => {
            const stock = parseInt(book.stock_quantity);
            return stock >= 1 && stock <= 10;
        }).length;
        
        const outOfStockCount = books.filter(book => {
            const stock = parseInt(book.stock_quantity);
            return stock === 0;
        }).length;
        
        document.getElementById('inStockCount').textContent = inStockCount;
        document.getElementById('inventoryLowStock').textContent = lowStockCount;
        document.getElementById('inventoryOutOfStock').textContent = outOfStockCount;
    }

    function displayBookInventory(books) {
        const tableBody = document.getElementById('booksInventoryTable');
        
        if (books.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" class="loading">No books found</td></tr>';
            return;
        }

        tableBody.innerHTML = books.map(book => {
            const stockStatusClass = getStockStatusClass(book.stock_quantity);
            const stockStatusText = getStockStatusText(book.stock_quantity);
            
            return `
            <tr>
                <td>${book.book_id}</td>
                <td><strong>${book.title}</strong></td>
                <td>${book.author}</td>
                <td>${book.category_name || 'N/A'}</td>
                <td>RM ${parseFloat(book.price).toFixed(2)}</td>
                <td>${book.stock_quantity}</td>
                <td style="font-family: 'Courier New', monospace;">
                    ${book.isbn || '<span style="color:#999;font-style:italic">Auto-generated</span>'}
                </td>
                <td>
                    <span class="${stockStatusClass}">
                        ${stockStatusText}
                    </span>
                </td>
                <td>${book.updated_at || 'N/A'}</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-primary" onclick="openEditBookModal(${book.book_id})">‚úèÔ∏è Edit</button>
                    <button class="btn btn-sm btn-warning" onclick="openStockModal(${book.book_id}, '${book.title.replace(/'/g, "\\'")}', ${book.stock_quantity})">üì¶ Stock</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.book_id})">üóëÔ∏è Delete</button>
                </td>
            </tr>
            `;
        }).join('');
    }

    function getStockStatusClass(stock) {
        const stockNum = parseInt(stock);
        
        if (stockNum === 0) {
            return 'out-of-stock';
        }
        if (stockNum >= 1 && stockNum <= 10) {
            return 'low-stock';
        }
        return 'in-stock';
    }

    function getStockStatusText(stock) {
        const stockNum = parseInt(stock);
        
        if (stockNum === 0) {
            return 'Out of Stock';
        }
        if (stockNum >= 1 && stockNum <= 10) {
            return 'Low Stock';
        }
        return 'In Stock';
    }

    async function loadCategoryFilter() {
        try {
            const response = await fetch(API_ENDPOINTS.categories);
            const data = await response.json();
            
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            
            if (data.success) {
                currentCategories = data.categories || data.data || [];
                currentCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_id;
                    option.textContent = category.category_name;
                    categoryFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    function searchBooks() {
        if (lastSearchTimeout) {
            clearTimeout(lastSearchTimeout);
        }
        
        lastSearchTimeout = setTimeout(async function() {
            const searchTerm = document.getElementById('bookSearch').value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                displayBookInventory(currentBooks);
                updateBookManagementSection();
                return;
            }
            
            try {
                const response = await fetch(`${API_ENDPOINTS.searchBook}?search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const searchResults = data.books || data.data || [];
                    displayBookInventory(searchResults);
                    updateBookManagementSection();
                } else {
                    localSearchBooks(searchTerm);
                }
            } catch (error) {
                console.error('Error searching books via API:', error);
                localSearchBooks(searchTerm);
            }
        }, 300);
    }

    function localSearchBooks(searchTerm) {
        const filteredBooks = currentBooks.filter(book => {
            const titleMatch = book.title && book.title.toLowerCase().includes(searchTerm);
            const authorMatch = book.author && book.author.toLowerCase().includes(searchTerm);
            const isbnMatch = book.isbn && book.isbn.toLowerCase().includes(searchTerm);
            const categoryMatch = book.category_name && book.category_name.toLowerCase().includes(searchTerm);
            
            return titleMatch || authorMatch || isbnMatch || categoryMatch;
        });
        
        displayBookInventory(filteredBooks);
        updateBookManagementSection();
    }

    function filterBooks() {
        const categoryId = document.getElementById('categoryFilter').value;
        if (categoryId === 'all') {
            displayBookInventory(currentBooks);
            updateBookManagementSection();
        } else {
            const filteredBooks = currentBooks.filter(book => book.category_id == categoryId);
            displayBookInventory(filteredBooks);
            updateBookManagementSection();
        }
    }

    function filterByStock() {
        const stockFilter = document.getElementById('stockFilter').value;
        
        let filteredBooks = currentBooks || [];
        
        switch(stockFilter) {
            case 'in_stock':
                filteredBooks = filteredBooks.filter(book => {
                    const stock = parseInt(book.stock_quantity);
                    return stock > 10;
                });
                break;
            case 'low_stock':
                filteredBooks = filteredBooks.filter(book => {
                    const stock = parseInt(book.stock_quantity);
                    return stock >= 1 && stock <= 10;
                });
                break;
            case 'out_of_stock':
                filteredBooks = filteredBooks.filter(book => {
                    const stock = parseInt(book.stock_quantity);
                    return stock === 0;
                });
                break;
            case 'all':
            default:
                break;
        }
        
        displayBookInventory(filteredBooks);
        updateBookManagementSection();
    }

    function loadAllBooks() {
        document.getElementById('stockFilter').value = 'all';
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('bookSearch').value = '';
        displayBookInventory(currentBooks);
        updateBookManagementSection();
    }

    function showLowStockBooks() {
        document.getElementById('stockFilter').value = 'low_stock';
        filterByStock();
    }

    function showOutOfStockBooks() {
        document.getElementById('stockFilter').value = 'out_of_stock';
        filterByStock();
    }

    // ============ BOOK MODAL FUNCTIONS ============
    
    function openAddBookModal() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_books') && !isSuperAdmin) {
            showNotification('You do not have permission to add books', 'error');
            return;
        }
        
        document.getElementById('modalTitle').textContent = 'Add New Book';
        document.getElementById('bookForm').reset();
        document.getElementById('bookId').value = '';
        
        const isbnInput = document.getElementById('bookISBN');
        isbnInput.readOnly = true;
        isbnInput.classList.remove('isbn-generated');
        
        const newISBN = generateRandomISBN();
        setGeneratedISBN(newISBN);
        
        document.getElementById('duplicateTitleWarning').style.display = 'none';
        
        const titleInput = document.getElementById('bookTitle');
        titleInput.removeEventListener('input', checkDuplicateTitle);
        titleInput.addEventListener('input', checkDuplicateTitle);
        
        loadCategoriesForModal();
        document.getElementById('bookModal').style.display = 'flex';
    }

    async function openEditBookModal(bookId) {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_books') && !isSuperAdmin) {
            showNotification('You do not have permission to edit books', 'error');
            return;
        }
        
        try {
            const response = await fetch(`${API_ENDPOINTS.bookDetail}?book_id=${bookId}`);
            const data = await response.json();
            
            if (data.success) {
                const book = data.book || data.data;
                document.getElementById('modalTitle').textContent = 'Edit Book';
                document.getElementById('bookId').value = book.book_id;
                document.getElementById('bookTitle').value = book.title;
                document.getElementById('bookAuthor').value = book.author;
                document.getElementById('bookPrice').value = book.price;
                document.getElementById('bookStock').value = book.stock_quantity;
                
                const isbnInput = document.getElementById('bookISBN');
                if (book.isbn && book.isbn.trim() !== '') {
                    isbnInput.value = book.isbn;
                    isbnInput.readOnly = false;
                    isbnInput.classList.remove('isbn-generated');
                    
                    const statusLabel = document.getElementById('isbnStatusLabel');
                    statusLabel.textContent = 'Manual';
                    statusLabel.style.background = '#f39c12';
                } else {
                    const newISBN = generateRandomISBN();
                    isbnInput.value = newISBN;
                    isbnInput.readOnly = true;
                    isbnInput.classList.add('isbn-generated');
                    
                    const statusLabel = document.getElementById('isbnStatusLabel');
                    statusLabel.textContent = 'Auto-generated';
                    statusLabel.style.background = '#3498db';
                }
                
                document.getElementById('bookDescription').value = book.description || '';
                document.getElementById('bookPublisher').value = book.publisher || '';
                document.getElementById('bookPublishDate').value = book.publish_date || '';
                
                await loadCategoriesForModal();
                document.getElementById('bookCategory').value = book.category_id;
                
                document.getElementById('duplicateTitleWarning').style.display = 'none';
                
                document.getElementById('bookModal').style.display = 'flex';
            }
        } catch (error) {
            console.error('Error loading book:', error);
            showNotification('Error loading book data', 'error');
        }
    }

    function closeModal() {
        document.getElementById('bookModal').style.display = 'none';
        const isbnInput = document.getElementById('bookISBN');
        isbnInput.readOnly = true;
        isbnInput.classList.remove('isbn-generated');
        
        const titleInput = document.getElementById('bookTitle');
        titleInput.removeEventListener('input', checkDuplicateTitle);
    }

    function openStockModal(bookId, bookTitle, currentStock) {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_inventory') && !isSuperAdmin) {
            showNotification('You do not have permission to update stock', 'error');
            return;
        }
        
        document.getElementById('stockBookId').value = bookId;
        document.getElementById('stockBookTitle').value = bookTitle;
        document.getElementById('newStockQuantity').value = currentStock;
        document.getElementById('stockModal').style.display = 'flex';
    }

    function closeStockModal() {
        document.getElementById('stockModal').style.display = 'none';
    }

    // ============ DUPLICATE TITLE CHECK FUNCTION ============
    
    async function checkDuplicateTitle() {
        const title = document.getElementById('bookTitle').value.trim();
        const bookId = document.getElementById('bookId').value;
        
        if (!title || title.length < 2) {
            document.getElementById('duplicateTitleWarning').style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch(`${API_ENDPOINTS.checkDuplicate}?title=${encodeURIComponent(title)}&book_id=${bookId || ''}`);
            const data = await response.json();
            
            const warningDiv = document.getElementById('duplicateTitleWarning');
            const warningText = document.getElementById('duplicateWarningText');
            const saveButton = document.getElementById('saveBookBtn');
            
            if (data.success && data.duplicate) {
                if (data.book_id == bookId) {
                    warningDiv.style.display = 'none';
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'üíæ Save Book';
                } else {
                    warningDiv.style.display = 'block';
                    warningText.textContent = `A book titled "${title}" already exists in the database.`;
                    saveButton.disabled = true;
                    saveButton.innerHTML = '‚ö†Ô∏è Duplicate Title';
                }
            } else {
                warningDiv.style.display = 'none';
                saveButton.disabled = false;
                saveButton.innerHTML = 'üíæ Save Book';
            }
        } catch (error) {
            console.error('Error checking duplicate title:', error);
            const warningDiv = document.getElementById('duplicateTitleWarning');
            warningDiv.style.display = 'block';
            document.getElementById('duplicateWarningText').textContent = 
                'Unable to verify title uniqueness. Please check manually.';
        }
    }

    // ============ SAVE BOOK FUNCTION ============
    
    async function saveBook() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_books') && !isSuperAdmin) {
            showNotification('You do not have permission to save books', 'error');
            return;
        }
        
        const bookId = document.getElementById('bookId').value;
        const isEditing = !!bookId;
        
        const bookData = {
            title: document.getElementById('bookTitle').value.trim(),
            author: document.getElementById('bookAuthor').value.trim(),
            category_id: document.getElementById('bookCategory').value,
            price: document.getElementById('bookPrice').value,
            stock_quantity: document.getElementById('bookStock').value,
            isbn: document.getElementById('bookISBN').value.trim(),
            description: document.getElementById('bookDescription').value.trim(),
            publisher: document.getElementById('bookPublisher').value.trim(),
            publish_date: document.getElementById('bookPublishDate').value
        };

        if (!isEditing && (!bookData.isbn || bookData.isbn === '')) {
            const newISBN = generateRandomISBN();
            bookData.isbn = newISBN;
            document.getElementById('bookISBN').value = newISBN;
        }
        
        if (bookData.isbn && !isValidISBN(bookData.isbn)) {
            showNotification('Invalid ISBN format. Please use format: 978-XXXXXXXXXXX (e.g., 978-1491950357)', 'error');
            return;
        }

        if (isEditing) {
            bookData.id = bookId;
        }

        const requiredFields = ['title', 'author', 'category_id', 'price', 'stock_quantity'];
        const missingFields = requiredFields.filter(field => !bookData[field]);
        
        if (missingFields.length > 0) {
            showNotification(`Please fill in all required fields: ${missingFields.join(', ')}`, 'error');
            return;
        }

        if (!isEditing) {
            try {
                const checkResponse = await fetch(`${API_ENDPOINTS.checkDuplicate}?title=${encodeURIComponent(bookData.title)}`);
                const checkData = await checkResponse.json();
                
                if (checkData.success && checkData.duplicate) {
                    showNotification(`Cannot save: A book titled "${bookData.title}" already exists!`, 'error');
                    return;
                }
            } catch (error) {
                console.warn('Could not verify title uniqueness:', error);
            }
        }

        const saveButton = document.querySelector('#bookModal .modal-footer .btn-primary');
        const originalText = saveButton.textContent;
        saveButton.innerHTML = '<span class="spinner"></span> Saving...';
        saveButton.disabled = true;

        try {
            const response = await fetch(API_ENDPOINTS.saveBook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(result.message, 'success');
                
                closeModal();
                
                setTimeout(() => {
                    if (document.getElementById('book-inventory').classList.contains('active')) {
                        loadBookInventoryData();
                    }
                    loadDashboardData();
                }, 500);
            } else {
                if (result.error && result.error.toLowerCase().includes('duplicate') || 
                    result.error.toLowerCase().includes('already exists')) {
                    showNotification(`Cannot save: A book with this title already exists!`, 'error');
                } else {
                    showNotification(`Error: ${result.error}`, 'error');
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error saving book. Please try again.', 'error');
        } finally {
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }
    }

    async function loadCategoriesForModal() {
        try {
            const response = await fetch(API_ENDPOINTS.categories);
            const data = await response.json();
            
            const categorySelect = document.getElementById('bookCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            
            if (data.success) {
                const categories = data.categories || data.data || [];
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_id;
                    option.textContent = category.category_name;
                    categorySelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    async function updateStock() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_inventory') && !isSuperAdmin) {
            showNotification('You do not have permission to update stock', 'error');
            return;
        }
        
        const stockData = {
            book_id: document.getElementById('stockBookId').value,
            stock_quantity: document.getElementById('newStockQuantity').value
        };

        try {
            const response = await fetch(API_ENDPOINTS.updateStock, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stockData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Stock updated successfully!', 'success');
                closeStockModal();
                loadSectionData('book-inventory');
                loadDashboardData();
            } else {
                showNotification('Error updating stock: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error updating stock. Please try again.', 'error');
        }
    }

    async function deleteBook(bookId) {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_books') && !isSuperAdmin) {
            showNotification('You do not have permission to delete books', 'error');
            return;
        }
        
        if (confirm('Are you sure you want to delete this book?')) {
            try {
                const response = await fetch(API_ENDPOINTS.deleteBook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: bookId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Book deleted successfully!', 'success');
                    loadSectionData('book-inventory');
                    loadDashboardData();
                } else {
                    showNotification('Error deleting book: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error deleting book. Please try again.', 'error');
            }
        }
    }

    // ============ SALES OVERVIEW FUNCTIONS ============

    async function loadSalesOverview() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('view_analytics') && !isSuperAdmin) {
            return;
        }
        
        try {
            const response = await fetch(API_ENDPOINTS.salesOverview);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                displaySalesOverview(data);
            } else {
                console.error('Error loading sales overview:', data.error);
                showNotification('Error loading sales overview', 'error');
            }
        } catch (error) {
            console.error('Error loading sales overview:', error);
            showNotification('Error loading sales overview', 'error');
        }
    }

    function displaySalesOverview(data) {
        const chartContainer = document.getElementById('salesOverviewChart');
        
        if (!chartContainer) return;
        
        if (!data || !data.sales_data || data.sales_data.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No sales data available</div>';
            return;
        }
        
        // ÁÆÄÂçïÁöÑÂõæË°®ÊòæÁ§∫
        const salesData = data.sales_data;
        const totalRevenue = salesData.reduce((sum, item) => sum + (item.revenue || 0), 0);
        const totalOrders = salesData.reduce((sum, item) => sum + (item.order_count || 0), 0);
        
        const chartHTML = `
            <div style="padding: 20px; height: 100%;">
                <div style="display: flex; justify-content: space-around; margin-bottom: 30px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--success);">RM ${totalRevenue.toFixed(2)}</div>
                        <div style="color: #666; font-size: 0.9rem;">Total Revenue</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--accent);">${totalOrders}</div>
                        <div style="color: #666; font-size: 0.9rem;">Total Orders</div>
                    </div>
                </div>
                
                <div style="height: 200px; display: flex; align-items: flex-end; gap: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    ${salesData.map((item, index) => {
                        const date = new Date(item.date || item.day);
                        const dateStr = date.getDate() + '/' + (date.getMonth() + 1);
                        const maxRevenue = Math.max(...salesData.map(s => s.revenue || 0));
                        const height = maxRevenue > 0 ? ((item.revenue || 0) / maxRevenue * 100) : 0;
                        
                        return `
                            <div style="flex: 1; text-align: center;">
                                <div style="background: linear-gradient(to top, var(--success), #27ae60); 
                                          height: ${height}%; 
                                          border-radius: 4px 4px 0 0;
                                          position: relative;"
                                          title="${dateStr}: RM ${(item.revenue || 0).toFixed(2)}">
                                    <div style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); 
                                              font-size: 0.7rem; color: #666; white-space: nowrap;">
                                        RM ${(item.revenue || 0).toFixed(0)}
                                    </div>
                                </div>
                                <div style="font-size: 0.7rem; margin-top: 5px; color: #666;">${dateStr}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; color: #666;">
                    <div>Period: ${salesData.length} days</div>
                    <div>Average Daily: RM ${(totalRevenue / salesData.length).toFixed(2)}</div>
                </div>
            </div>
        `;
        
        chartContainer.innerHTML = chartHTML;
    }

    // ============ SALES ANALYTICS FUNCTIONS ============
    
    async function loadSalesAnalytics(period = '30days') {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('view_analytics') && !isSuperAdmin) {
            return;
        }
        
        try {
            const response = await fetch(`${API_ENDPOINTS.salesAnalytics}?period=${period}`);
            const data = await response.json();
            
            if (data.success) {
                displaySalesAnalytics(data);
            } else {
                console.error('Error loading sales report:', data.error);
                showAnalyticsError(data.error);
            }
        } catch (error) {
            console.error('Error loading sales report:', error);
            showAnalyticsError('Failed to load sales report');
        }
    }

    function displaySalesAnalytics(data) {
        updateAnalyticsSummary(data.summary);
        updateSalesTrendChart(data.sales_trend);
        updateTopBooksChart(data.top_books);
        updateCategoryRevenueChart(data.category_revenue);
    }

    function updateAnalyticsSummary(summary) {
        const summaryContainer = document.getElementById('analyticsSummary');
        
        if (!summaryContainer) return;
        
        const summaryHTML = `
            <div class="stat-card" style="border-top-color: var(--success);">
                <div class="stat-number">${summary.total_orders || 0}</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card" style="border-top-color: var(--accent);">
                <div class="stat-number">RM ${(summary.total_revenue || 0).toFixed(2)}</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card" style="border-top-color: var(--info);">
                <div class="stat-number">${summary.total_customers || 0}</div>
                <div class="stat-label">Customers</div>
            </div>
            <div class="stat-card" style="border-top-color: var(--warning);">
                <div class="stat-number">RM ${(summary.avg_order_value || 0).toFixed(2)}</div>
                <div class="stat-label">Avg Order Value</div>
            </div>
        `;
        
        summaryContainer.innerHTML = summaryHTML;
    }

    function updateSalesTrendChart(salesTrend) {
        const chartContainer = document.getElementById('salesTrendChart');
        
        if (!chartContainer) return;
        
        if (!salesTrend || salesTrend.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No trend data available</div>';
            return;
        }
        
        const trendData = [...salesTrend].reverse();
        const maxRevenue = Math.max(...trendData.map(s => s.total_revenue));
        const maxOrders = Math.max(...trendData.map(s => s.order_count));
        
        const chartHTML = `
            <div style="padding: 20px; height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 0.9rem; color: #666;">
                        ${trendData.length} days of data
                    </div>
                    <div style="display: flex; gap: 10px; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background: var(--success); border-radius: 2px;"></div>
                            <span>Revenue</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background: var(--accent); border-radius: 2px; opacity: 0.7;"></div>
                            <span>Orders</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-end; height: 200px; gap: 5px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px;">
                    ${trendData.map(day => {
                        const date = new Date(day.date);
                        const dateStr = `${date.getDate()}/${date.getMonth() + 1}`;
                        const revenueHeight = maxRevenue > 0 ? (day.total_revenue / maxRevenue * 100) : 0;
                        const ordersHeight = maxOrders > 0 ? (day.order_count / maxOrders * 100) : 0;
                        
                        return `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; position: relative;">
                                <!-- Revenue bar -->
                                <div style="width: 70%; background: linear-gradient(to top, var(--success), #27ae60); 
                                           height: ${revenueHeight}%; border-radius: 3px 3px 0 0; position: absolute; bottom: 0; left: 15%;"
                                           title="${dateStr}: RM ${day.total_revenue.toFixed(2)} revenue">
                                </div>
                                <!-- Orders bar -->
                                <div style="width: 70%; background: linear-gradient(to top, var(--accent), #3498db); 
                                           height: ${ordersHeight}%; border-radius: 3px 3px 0 0; position: absolute; bottom: 0; right: 15%; opacity: 0.7;"
                                           title="${dateStr}: ${day.order_count} orders">
                                </div>
                                <div style="font-size: 0.7rem; margin-top: 110px; color: #666; transform: rotate(-45deg); transform-origin: left top;">
                                    ${dateStr}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.8rem; color: #666;">
                    <div>Total: RM ${trendData.reduce((sum, day) => sum + day.total_revenue, 0).toFixed(2)}</div>
                    <div>Avg Daily: RM ${(trendData.reduce((sum, day) => sum + day.total_revenue, 0) / trendData.length).toFixed(2)}</div>
                </div>
            </div>
        `;
        
        chartContainer.innerHTML = chartHTML;
    }

    function updateTopBooksChart(topBooks) {
        const chartContainer = document.getElementById('topBooksChart');
        
        if (!chartContainer) return;
        
        if (!topBooks || topBooks.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No top books data available</div>';
            return;
        }
        
        const maxRevenue = Math.max(...topBooks.map(b => b.total_revenue));
        
        const chartHTML = `
            <div style="padding: 20px; height: 100%; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                            <th style="padding: 10px; text-align: left; font-weight: bold; color: var(--primary);">#</th>
                            <th style="padding: 10px; text-align: left; font-weight: bold; color: var(--primary);">Book</th>
                            <th style="padding: 10px; text-align: left; font-weight: bold; color: var(--primary);">Revenue</th>
                            <th style="padding: 10px; text-align: left; font-weight: bold; color: var(--primary);">Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topBooks.map((book, index) => {
                            const barWidth = maxRevenue > 0 ? (book.total_revenue / maxRevenue * 100) : 0;
                            
                            return `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 10px; font-weight: bold; color: var(--primary); vertical-align: top;">
                                        ${index + 1}
                                    </td>
                                    <td style="padding: 10px; vertical-align: top;">
                                        <div style="font-weight: 500; margin-bottom: 4px;">${book.title}</div>
                                        <div style="font-size: 0.8rem; color: #666;">
                                            by ${book.author}
                                        </div>
                                        <div style="font-size: 0.7rem; color: #999;">
                                            ${book.category}
                                        </div>
                                    </td>
                                    <td style="padding: 10px; vertical-align: top; width: 200px;">
                                        <div style="font-weight: bold; color: var(--success); margin-bottom: 4px;">
                                            RM ${book.total_revenue.toFixed(2)}
                                        </div>
                                        <div style="background: #e9ecef; border-radius: 3px; height: 8px; overflow: hidden;">
                                            <div style="background: linear-gradient(90deg, var(--success), #27ae60); 
                                                     width: ${barWidth}%; height: 100%; border-radius: 3px;">
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 10px; vertical-align: top; text-align: center;">
                                        <div style="font-weight: bold; color: var(--info);">
                                            ${book.total_quantity}
                                        </div>
                                        <div style="font-size: 0.8rem; color: #666;">
                                            ${book.order_count} orders
                                        </div>
                                        <div class="${getStockStatusClass(book.stock_quantity)}" style="margin-top: 4px; display: inline-block;">
                                            ${book.stock_quantity} in stock
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        chartContainer.innerHTML = chartHTML;
    }

    function updateCategoryRevenueChart(categoryRevenue) {
        const chartContainer = document.getElementById('categoryRevenueChart');
        
        if (!chartContainer) return;
        
        if (!categoryRevenue || categoryRevenue.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No category data available</div>';
            return;
        }
        
        const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#d35400', '#34495e', '#16a085', '#8e44ad'];
        const maxRevenue = Math.max(...categoryRevenue.map(c => c.total_revenue));
        const totalRevenue = categoryRevenue.reduce((sum, cat) => sum + cat.total_revenue, 0);
        
        const chartHTML = `
            <div style="padding: 20px; height: 100%;">
                <div style="display: flex; height: 200px; margin-bottom: 20px;">
                    <!-- Bar chart -->
                    <div style="flex: 2; display: flex; align-items: flex-end; gap: 10px; padding-right: 20px;">
                        ${categoryRevenue.map((category, index) => {
                            const height = maxRevenue > 0 ? (category.total_revenue / maxRevenue * 100) : 0;
                            const color = colors[index % colors.length];
                            const percentage = totalRevenue > 0 ? (category.total_revenue / totalRevenue * 100) : 0;
                            
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <div style="width: 80%; background: linear-gradient(to top, ${color}, ${color}80); 
                                               height: ${height}%; border-radius: 5px 5px 0 0; position: relative;"
                                               title="${category.category_name}: RM ${category.total_revenue.toFixed(2)} (${percentage.toFixed(1)}%)">
                                        <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); 
                                                   font-size: 0.7rem; color: #666; white-space: nowrap;">
                                            ${percentage.toFixed(1)}%
                                        </div>
                                    </div>
                                    <div style="font-size: 0.7rem; margin-top: 5px; color: #666; text-align: center; 
                                               height: 40px; overflow: hidden; line-height: 1.2;">
                                        ${category.category_name}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Summary -->
                    <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Summary</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success); margin-bottom: 10px;">
                            RM ${totalRevenue.toFixed(2)}
                        </div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                            Total Revenue
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            ${categoryRevenue.length} categories
                        </div>
                    </div>
                </div>
                
                <!-- Category details -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${categoryRevenue.slice(0, 4).map((category, index) => `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid ${colors[index % colors.length]};">
                            <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 5px;">${category.category_name}</div>
                            <div style="color: var(--success); font-weight: bold;">
                                RM ${category.total_revenue.toFixed(2)}
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                ${category.order_count} orders ‚Ä¢ ${category.total_quantity} items
                            </div>
                            <div style="font-size: 0.7rem; color: #999; margin-top: 2px;">
                                ${category.customer_count} customers
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        chartContainer.innerHTML = chartHTML;
    }

    function showAnalyticsError(error) {
        const containers = ['salesTrendChart', 'topBooksChart', 'categoryRevenueChart'];
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger);">${error}</div>`;
            }
        });
    }

    // ============ ADMIN MANAGEMENT FUNCTIONS ============
    
    async function loadAdminManagementData() {
        if (!isSuperAdmin) {
            showNotification('Access denied. Super Admin only.', 'error');
            return;
        }
        
        try {
            const response = await fetch(API_ENDPOINTS.getAdmins);
            const data = await response.json();
            
            if (data.success) {
                currentAdmins = data.admins || [];
                updateAdminStats(currentAdmins);
                displayAdmins(currentAdmins);
            } else {
                document.getElementById('adminsTable').innerHTML = '<tr><td colspan="8" class="error">Error loading admin data: ' + (data.error || 'Unknown error') + '</td></tr>';
            }
        } catch (error) {
            console.error('Error loading admin data:', error);
            document.getElementById('adminsTable').innerHTML = '<tr><td colspan="8" class="error">Error loading admin data</td></tr>';
        }
    }

    function updateAdminStats(admins) {
        const totalAdmins = admins.length;
        const superadminCount = admins.filter(admin => admin.role === 'superadmin').length;
        const adminCount = admins.filter(admin => admin.role === 'admin').length;
       
        document.getElementById('totalAdmins').textContent = totalAdmins;
        document.getElementById('superadminCount').textContent = superadminCount;
        document.getElementById('adminCount').textContent = adminCount;
    }

    function displayAdmins(admins) {
        const adminsTable = document.getElementById('adminsTable');
        
        if (admins.length === 0) {
            adminsTable.innerHTML = '<tr><td colspan="7" class="loading">No admins found. Add your first admin!</td></tr>';
            return;
        }

        adminsTable.innerHTML = admins.map(admin => {
            const roleInfo = ADMIN_ROLE_MAP[admin.role] || { text: admin.role, class: 'role-admin' };
            
            let lastLogin = 'Never';
            if (admin.last_login) {
                try {
                    lastLogin = new Date(admin.last_login).toLocaleString();
                } catch (e) {
                    lastLogin = admin.last_login;
                }
            } else if (admin.last_login_time) {
                try {
                    lastLogin = new Date(admin.last_login_time).toLocaleString();
                } catch (e) {
                    lastLogin = admin.last_login_time;
                }
            }
            
            let createdDate = 'N/A';
            if (admin.created_at) {
                try {
                    createdDate = new Date(admin.created_at).toLocaleDateString();
                } catch (e) {
                    createdDate = admin.created_at;
                }
            }
            
            return `
            <tr>
                <td>${admin.auto_id || admin.id || admin.admin_id}</td>
                <td><strong>${admin.username}</strong></td>
                <td>${admin.email || 'N/A'}</td>
                <td>
                    <span class="admin-role ${roleInfo.class}">
                        ${roleInfo.text}
                    </span>
                </td>
                <td>${createdDate}</td>
                <td>${lastLogin}</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-primary" onclick="viewAdminDetails(${admin.auto_id || admin.id || admin.admin_id})">
                        üëÅÔ∏è View
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="editAdmin(${admin.auto_id || admin.id || admin.admin_id})">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAdmin(${admin.auto_id || admin.id || admin.admin_id}, '${admin.username.replace(/'/g, "\\'")}')">
                        üóëÔ∏è Delete
                    </button>
                    <button class="btn btn-sm btn-info" onclick="openSendPasswordModal(${admin.auto_id || admin.id || admin.admin_id}, '${admin.username.replace(/'/g, "\\'")}', '${(admin.email || '').replace(/'/g, "\\'")}')">
                        üìß Send Password
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }
    
    function searchAdmins() {
        if (lastSearchTimeout) {
            clearTimeout(lastSearchTimeout);
        }
        
        lastSearchTimeout = setTimeout(function() {
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            
            if (searchTerm.length < 2) {
                displayAdmins(currentAdmins);
                return;
            }
            
            const filteredAdmins = currentAdmins.filter(admin => 
                admin.username.toLowerCase().includes(searchTerm) ||
                (admin.email && admin.email.toLowerCase().includes(searchTerm))
            );
            
            displayAdmins(filteredAdmins);
        }, 300);
    }

    function filterAdmins() {
        const roleFilter = document.getElementById('adminRoleFilter').value;
        const statusFilter = document.getElementById('adminStatusFilter').value;
        
        let filteredAdmins = currentAdmins;
        
        if (roleFilter !== 'all') {
            filteredAdmins = filteredAdmins.filter(admin => admin.role === roleFilter);
        }
        
        if (statusFilter !== 'all') {
            filteredAdmins = filteredAdmins.filter(admin => admin.status === statusFilter);
        }
        
        displayAdmins(filteredAdmins);
    }

    // ============ ADMIN MODAL FUNCTIONS ============
    
    async function openAddAdminModal() {
        if (!isSuperAdmin) {
            showNotification('Access denied. Super Admin only.', 'error');
            return;
        }
        
        console.log('Opening add admin modal');
        
        document.getElementById('adminModalTitle').textContent = 'Add New Admin';
        document.getElementById('adminForm').reset();
        document.getElementById('adminId').value = '';
        document.getElementById('adminRole').value = 'admin';
        
        const permissionsGrid = document.getElementById('permissionsGrid');
        if (permissionsGrid) {
            permissionsGrid.innerHTML = '<div class="loading">Loading permissions...</div>';
        }
        
        await loadPermissions();
        
        setTimeout(() => {
            const basicPermissions = ['view_dashboard', 'view_books', 'view_customers', 'manage_orders'];
            basicPermissions.forEach(permKey => {
                const checkbox = document.querySelector(`input[value="${permKey}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    console.log('Auto-checked permission:', permKey);
                } else {
                    console.log('Permission checkbox not found:', permKey);
                }
            });
            
            togglePermissions();
        }, 100);
        
        document.getElementById('adminModal').style.display = 'flex';
        console.log('Admin modal opened');
    }

    // ============ PERMISSIONS SELECT/DESELECT FUNCTIONS ============

    function selectAllPermissions() {
        console.log('Selecting all permissions');
        const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updatePermissionsCount();
        showNotification(`All ${checkboxes.length} permissions selected`, 'success');
    }

    function deselectAllPermissions() {
        console.log('Deselecting all permissions');
        const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updatePermissionsCount();
        showNotification(`All permissions deselected`, 'warning');
    }

    // ============ PERMISSIONS FUNCTIONS ============

    async function loadPermissions() {
        console.log('Loading permissions...');
        
        try {
            const response = await fetch(API_ENDPOINTS.getPermissions);
            console.log('Permissions response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Parsed permissions data:', data);
            
            if (data.success) {
                currentPermissions = data.permissions || [];
                console.log('Permissions loaded successfully:', currentPermissions.length, 'permissions');
                displayPermissions(currentPermissions);
            } else {
                console.error('API returned error:', data.error);
                fallbackToDefaultPermissions();
            }
        } catch (error) {
            console.error('Error loading permissions:', error);
            fallbackToDefaultPermissions();
        }
    }

    function fallbackToDefaultPermissions() {
        console.log('Using fallback permissions');
        currentPermissions = [
            { 
                permission_id: 1, 
                permission_key: 'manage_admins', 
                description: 'Can manage other admin users', 
                category: 'Administration' 
            },
            { 
                permission_id: 2, 
                permission_key: 'manage_books', 
                description: 'Manage Books (Add/Edit/Delete)', 
                category: 'Books' 
            },
            { 
                permission_id: 3, 
                permission_key: 'view_books', 
                description: 'Can view books only', 
                category: 'Inventory' 
            },
            { 
                permission_id: 4, 
                permission_key: 'manage_categories', 
                description: 'Manage Book Categories', 
                category: 'Categories' 
            },
            { 
                permission_id: 5, 
                permission_key: 'manage_orders', 
                description: 'View and Update Orders', 
                category: 'Orders' 
            },
            { 
                permission_id: 6, 
                permission_key: 'manage_customers', 
                description: 'Can manage customer accounts', 
                category: 'Customer Service' 
            },
            { 
                permission_id: 7, 
                permission_key: 'view_customers', 
                description: 'Can view customer information only', 
                category: 'Customer Service' 
            },
            { 
                permission_id: 8, 
                permission_key: 'view_reports', 
                description: 'Can view sales and inventory reports', 
                category: 'Reporting' 
            },
            { 
                permission_id: 9, 
                permission_key: 'manage_discounts', 
                description: 'Can create and manage discounts', 
                category: 'Sales' 
            },
            { 
                permission_id: 10, 
                permission_key: 'manage_preorders', 
                description: 'Can manage pre-orders', 
                category: 'Sales' 
            },
            { 
                permission_id: 11, 
                permission_key: 'view_dashboard', 
                description: 'Can view admin dashboard', 
                category: 'General' 
            },
            { 
                permission_id: 12, 
                permission_key: 'manage_settings', 
                description: 'Can manage system settings', 
                category: 'Administration' 
            },
            { 
                permission_id: 18, 
                permission_key: 'manage_inventory', 
                description: 'Update Stock Levels', 
                category: 'Inventory' 
            },
            { 
                permission_id: 19, 
                permission_key: 'view_analytics', 
                description: 'View Sales Reports', 
                category: 'Analytics' 
            }
        ];
        
        displayPermissions(currentPermissions);
    }

    // ============ PERMISSIONS DISPLAY FUNCTION ============

    function displayPermissions(permissions) {
        const permissionsGrid = document.getElementById('permissionsGrid');
        
        if (!permissionsGrid) {
            console.error('Permissions grid element not found!');
            return;
        }
        
        if (!permissions || permissions.length === 0) {
            permissionsGrid.innerHTML = '<div class="loading">No permissions defined</div>';
            return;
        }
        
        console.log('Displaying', permissions.length, 'permissions');
        
        const groupedPermissions = {};
        permissions.forEach(permission => {
            const category = permission.category || 'General';
            if (!groupedPermissions[category]) {
                groupedPermissions[category] = [];
            }
            groupedPermissions[category].push(permission);
        });
        
        const html = Object.keys(groupedPermissions).map(category => `
            <div class="permission-category">
                <h4>${category} (${groupedPermissions[category].length})</h4>
                ${groupedPermissions[category].map(perm => {
                    if (perm.permission_key === 'manage_admins') {
                        return '';
                    }
                    return `
                        <div class="permission-item">
                            <input type="checkbox" 
                                   id="perm_${perm.permission_id || perm.permission_key}" 
                                   name="permissions" 
                                   value="${perm.permission_key}"
                                   ${perm.permission_key === 'view_dashboard' ? 'checked' : ''}>
                            <label for="perm_${perm.permission_id || perm.permission_key}">
                                ${perm.description || perm.permission_key}
                            </label>
                        </div>
                    `;
                }).join('')}
            </div>
        `).join('');
        
        permissionsGrid.innerHTML = html;
        console.log('Permissions displayed in grid');
        
        setTimeout(() => {
            updatePermissionsCount();
        }, 100);
    }

    function updatePermissionsCount() {
        const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]');
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        const totalCount = checkboxes.length;
        
        const headerElement = document.querySelector('#permissionsSection h4');
        if (headerElement) {
            headerElement.innerHTML = `üîë Permissions (${checkedCount}/${totalCount} selected)`;
        }
    }

    function setupPermissionsListeners() {
        const permissionsGrid = document.getElementById('permissionsGrid');
        if (permissionsGrid) {
            permissionsGrid.addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    updatePermissionsCount();
                }
            });
        }
    }

    function togglePermissions() {
        const role = document.getElementById('adminRole').value;
        const permissionsSection = document.getElementById('permissionsSection');
        
        console.log('Role changed to:', role);
        console.log('Permissions section:', permissionsSection);
        
        if (role === 'superadmin') {
            if (permissionsSection) {
                permissionsSection.style.display = 'none';
                console.log('Hiding permissions section for superadmin');
            }
        } else {
            if (permissionsSection) {
                permissionsSection.style.display = 'block';
                console.log('Showing permissions section for admin');
            }
        }
    }

    function closeAdminModal() {
        document.getElementById('adminModal').style.display = 'none';
    }

    async function saveAdmin() {
        if (!isSuperAdmin) {
            showNotification('Access denied. Super Admin only.', 'error');
            return;
        }
        
        const adminData = {
            username: document.getElementById('adminUsername').value.trim(),
            email: document.getElementById('adminEmail').value.trim(),
            role: document.getElementById('adminRole').value,
        };
        
        const adminId = document.getElementById('adminId').value;
        const isEditing = !!adminId;
        
        const apiEndpoint = isEditing ? API_ENDPOINTS.updateAdmin : API_ENDPOINTS.saveAdmin;
        
        if (isEditing) {
            adminData.admin_id = adminId;
        }
        
        if (adminData.role === 'admin') {
            const selectedPermissions = [];
            document.querySelectorAll('#permissionsGrid input[type="checkbox"]:checked').forEach(checkbox => {
                selectedPermissions.push({
                    permission_key: checkbox.value
                });
            });
            
            if (selectedPermissions.length === 0) {
                showNotification('Please select at least one permission for the admin', 'warning');
                return;
            }
            
            adminData.permissions = selectedPermissions;
        }

        if (!adminData.username) {
            showNotification('Please enter a username', 'warning');
            return;
        }

        if (isEditing && currentAdminInfo && currentAdminInfo.admin_id == adminId && adminData.username !== currentAdminInfo.username) {
            if (!confirm('You are changing your own username. You may need to login again. Continue?')) {
                return;
            }
        }

        const saveButton = document.querySelector('#adminModal .modal-footer .btn-primary');
        const originalText = saveButton.textContent;
        saveButton.innerHTML = '<span class="spinner"></span> Saving...';
        saveButton.disabled = true;

        try {
            const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(adminData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (isEditing) {
                    showNotification(`Admin "${adminData.username}" updated successfully!`, 'success');
                } else {
                    const passwordInfo = result.generated_password ? `
                        <div style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 15px; margin-top: 10px;">
                            <strong>üìù IMPORTANT: Save this password!</strong><br>
                            Username: <strong>${adminData.username}</strong><br>
                            Password: <strong style="color: #e74c3c;">${result.generated_password}</strong><br>
                            <small style="color: #666;">Share this password securely with the new admin.</small>
                        </div>
                    ` : '';
                    
                    showNotification(`Admin created successfully! ${passwordInfo}`, 'success', 10000);
                    
                    if (adminData.email) {
                        setTimeout(() => {
                            openSendPasswordModal(result.admin_id, adminData.username, adminData.email);
                        }, 1000);
                    }
                }
                
                closeAdminModal();
                loadAdminManagementData();
                
            } else {
                if (result.error && result.error.toLowerCase().includes('already exists') || 
                    result.error.toLowerCase().includes('username already')) {
                    showNotification(`Cannot save: ${result.error}`, 'error');
                } else {
                    showNotification(isEditing ? 'Error updating admin: ' : 'Error creating admin: ' + result.error, 'error');
                }
            }
        } catch (error) {
            console.error('Error saving admin:', error);
            showNotification('Error saving admin. Please try again.', 'error');
        } finally {
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }
    }

    function closeAdminDetailsModal() {
        document.getElementById('adminDetailsModal').style.display = 'none';
    }

    function closeSendPasswordModal() {
        document.getElementById('sendPasswordModal').style.display = 'none';
    }

    // ============ ADMIN DETAILS FUNCTIONS ============

    async function viewAdminDetails(adminId) {
        if (!isSuperAdmin) {
            showNotification('Access denied. Super Admin only.', 'error');
            return;
        }
        
        try {
            const response = await fetch(`${API_ENDPOINTS.getAdminDetail}?admin_id=${adminId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showAdminDetailsModal(data.admin || data.data);
            } else {
                showNotification('Error loading admin details: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error loading admin details:', error);
            showNotification('Error loading admin details. Please try again.', 'error');
        }
    }

    function showAdminDetailsModal(admin) {
        if (!admin) {
            showNotification('No admin data available', 'error');
            return;
        }
        
        const roleInfo = ADMIN_ROLE_MAP[admin.role] || { text: admin.role, class: 'role-admin' };
        
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleString();
            } catch (e) {
                return dateString;
            }
        };
        
        document.getElementById('adminDetailsTitle').textContent = `Admin Details - ${admin.username}`;
        
        document.getElementById('adminDetailsBody').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Basic Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div style="margin-bottom: 8px;">
                            <strong>Admin ID:</strong> ${admin.auto_id || admin.id || admin.admin_id}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Username:</strong> ${admin.username}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Email:</strong> ${admin.email || 'Not set'}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Role:</strong> 
                            <span class="admin-role ${roleInfo.class}">
                                ${roleInfo.text}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Account Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div style="margin-bottom: 8px;">
                            <strong>Created:</strong> ${formatDate(admin.created_at)}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Last Updated:</strong> ${formatDate(admin.updated_at) || 'N/A'}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Last Login:</strong> ${formatDate(admin.last_login) || 'Never'}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Login Count:</strong> ${admin.login_count || '0'}
                        </div>
                    </div>
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Permissions</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        ${admin.permissions && admin.permissions.length > 0 ? 
                            `<ul style="margin: 0; padding-left: 20px;">
                                ${admin.permissions.map(perm => 
                                    `<li>${perm.description || perm.permission_key}</li>`
                                ).join('')}
                            </ul>` : 
                            '<div style="color: #666; font-style: italic;">No specific permissions assigned</div>'
                        }
                    </div>
                </div>
                
                ${admin.note ? `
                <div style="grid-column: 1 / -1;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Notes</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-line;">
                        ${admin.note}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        document.getElementById('editAdminBtn').setAttribute('onclick', `editAdmin(${admin.auto_id || admin.id || admin.admin_id})`);
        document.getElementById('deleteAdminBtn').setAttribute('onclick', `deleteAdmin(${admin.auto_id || admin.id || admin.admin_id}, '${admin.username.replace(/'/g, "\\'")}')`);
        
        document.getElementById('adminDetailsModal').style.display = 'flex';
    }

    async function editAdmin(adminId) {
        if (!isSuperAdmin) {
            showNotification('Access denied. Super Admin only.', 'error');
            return;
        }
        
        try {
            const response = await fetch(`${API_ENDPOINTS.getAdminDetail}?admin_id=${adminId}`);
            const data = await response.json();
            
            if (data.success) {
                const admin = data.admin || data.data;
                
                document.getElementById('adminModalTitle').textContent = 'Edit Admin';
                document.getElementById('adminId').value = admin.auto_id || admin.id || admin.admin_id;
                document.getElementById('adminUsername').value = admin.username;
                document.getElementById('adminEmail').value = admin.email || '';
                document.getElementById('adminRole').value = admin.role;
               
                await loadPermissions();
                
                if (admin.permissions) {
                    setTimeout(() => {
                        document.querySelectorAll('#permissionsGrid input[type="checkbox"]').forEach(checkbox => {
                            const permKey = checkbox.value;
                            const hasPermission = admin.permissions.some(perm => 
                                perm.permission_key === permKey || 
                                (typeof perm === 'object' && perm.permission_key === permKey)
                            );
                            checkbox.checked = hasPermission;
                        });
                    }, 100);
                }
                
                togglePermissions();
                document.getElementById('adminModal').style.display = 'flex';
            } else {
                showNotification('Error loading admin data: ' + data.error, 'error');
            }
        } catch (error) {
            console.error('Error loading admin:', error);
            showNotification('Error loading admin data', 'error');
        }
    }

    // ============ ADMIN DELETE FUNCTION ============
    async function deleteAdmin(adminId, adminName, adminRole) {
        console.log('Deleting admin:', { adminId, adminName, adminRole });
        
        if (!currentAdminInfo || currentAdminInfo.role !== 'superadmin') {
            showNotification('Access denied. Super Admin only.', 'error');
            return;
        }
        
        let confirmMessage = `Are you sure you want to delete admin "${adminName}"?\n\nThis action cannot be undone!`;
        
        if (adminRole === 'superadmin') {
            confirmMessage = `‚ö†Ô∏è WARNING: This is a SUPER ADMIN account!\n\nAre you sure you want to delete super admin "${adminName}"?\n\nThis may affect system access!`;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        const deleteData = {
            admin_id: adminId
        };
        
        try {
            console.log('Sending delete request to:', API_ENDPOINTS.deleteAdmin);
            console.log('Delete data:', deleteData);
            
            const response = await fetch(API_ENDPOINTS.deleteAdmin, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(deleteData)
            });
            
            console.log('Response status:', response.status);
            
            const result = await response.json();
            console.log('Response result:', result);
            
            if (result.success) {
                showNotification(result.message || `Admin "${adminName}" deleted successfully!`, 'success');
                
                if (document.getElementById('adminDetailsModal').style.display === 'flex') {
                    closeAdminDetailsModal();
                }
                
                loadAdminManagementData();
                
            } else {
                if (result.requires_confirmation && adminRole === 'superadmin') {
                    const finalConfirm = confirm(`‚ö†Ô∏è FINAL CONFIRMATION: SUPER ADMIN DELETION!\n\nAdmin "${result.admin_name || adminName}" is a super admin.\n\nClick OK to confirm deletion or Cancel to abort.`);
                    
                    if (finalConfirm) {
                        deleteData.confirm_superadmin = true;
                        
                        const confirmResponse = await fetch(API_ENDPOINTS.deleteAdmin, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(deleteData)
                        });
                        
                        const confirmResult = await confirmResponse.json();
                        
                        if (confirmResult.success) {
                            showNotification(`Super Admin "${adminName}" deleted successfully!`, 'success');
                            closeAdminDetailsModal();
                            loadAdminManagementData();
                        } else {
                            showNotification('Error: ' + (confirmResult.error || 'Unknown error'), 'error');
                        }
                    }
                } else {
                    showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            }
            
        } catch (error) {
            console.error('Error deleting admin:', error);
            showNotification('Delete failed. Please check your connection.', 'error');
        }
    }

    function closeAdminDetailsModal() {
        document.getElementById('adminDetailsModal').style.display = 'none';
    }
    
    async function sendPasswordEmail() {
        const adminId = document.getElementById('passwordAdminId').value;
        const email = document.getElementById('passwordEmail').value;
        
        if (!email || !validateEmail(email)) {
            showNotification('Please enter a valid email address', 'warning');
            return;
        }
        
        if (!adminId) {
            showNotification('Admin ID is required', 'warning');
            return;
        }
        
        const sendButton = document.querySelector('#sendPasswordModal .btn-primary');
        const originalText = sendButton.textContent;
        sendButton.innerHTML = '<span class="spinner"></span> Sending...';
        sendButton.disabled = true;
        
        try {
            const response = await fetch(API_ENDPOINTS.sendPasswordEmail, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_id: parseInt(adminId),
                    email: email
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const passwordMessage = `
                    <div style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 15px; margin-top: 10px;">
                        <strong>üìß Password Reset Successful!</strong><br>
                        New password: <strong style="color: #e74c3c;">${result.generated_password}</strong><br>
                        <small style="color: #666;">
                            ${result.email_sent_to ? `Sent to: ${result.email_sent_to}` : ''}<br>
                            Share this password securely with the admin.
                        </small>
                    </div>
                `;
                
                showNotification(`Password reset completed! ${passwordMessage}`, 'success', 10000);
                closeSendPasswordModal();
            } else {
                showNotification('Error sending password: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error sending password email:', error);
            showNotification('Error sending password email. Please try again.', 'error');
        } finally {
            sendButton.innerHTML = originalText;
            sendButton.disabled = false;
        }
    }

    function openSendPasswordModal(adminId, adminName, adminEmail) {
        document.getElementById('passwordAdminId').value = adminId;
        document.getElementById('passwordAdminName').value = adminName;
        
        const emailInput = document.getElementById('passwordEmail');
        if (adminEmail && adminEmail !== 'Not set' && adminEmail !== 'N/A') {
            emailInput.value = adminEmail;
        } else {
            emailInput.value = '';
            emailInput.placeholder = 'Enter email address for password reset';
        }
        
        document.getElementById('sendPasswordModal').style.display = 'flex';
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // ============ ISBN FUNCTIONS ============
    
    function generateRandomISBN() {
        const prefix = "978";
        let middleDigits = "";
        for (let i = 0; i < 10; i++) {
            middleDigits += Math.floor(Math.random() * 10);
        }
        return `${prefix}-${middleDigits}`;
    }

    function isValidISBN(isbn) {
        if (!isbn || typeof isbn !== 'string') return false;
        const isbnPattern = /^978-\d{10}$/;
        return isbnPattern.test(isbn);
    }

    function regenerateISBN() {
        const newISBN = generateRandomISBN();
        setGeneratedISBN(newISBN);
        showNotification(`New ISBN generated: ${newISBN}`, 'info');
    }

    function setGeneratedISBN(isbn) {
        let cleanISBN = String(isbn || '').trim();
        
        if (!isValidISBN(cleanISBN)) {
            console.warn('ISBN format invalid, regenerating:', cleanISBN);
            const newISBN = generateRandomISBN();
            setGeneratedISBN(newISBN);
            return;
        }
        
        currentGeneratedISBN = cleanISBN;
        const isbnInput = document.getElementById('bookISBN');
        isbnInput.value = cleanISBN;
        isbnInput.classList.add('isbn-generated');
        
        const statusLabel = document.getElementById('isbnStatusLabel');
        if (statusLabel) {
            statusLabel.textContent = 'Auto-generated';
            statusLabel.style.background = '#3498db';
        }
    }

    function formatISBN(rawISBN) {
        if (isValidISBN(rawISBN)) {
            return rawISBN;
        }
        
        const cleanDigits = rawISBN.replace(/\D/g, '');
        
        if (cleanDigits.length !== 13) {
            return rawISBN;
        }
        
        return `${cleanDigits.substring(0, 3)}-${cleanDigits.substring(3, 13)}`;
    }

    // ============ NOTIFICATION FUNCTIONS ============
    
    function showNotification(message, type = 'info', duration = 3000) {
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) existingNotification.remove();
        
        const notification = document.createElement('div');
        notification.className = `custom-notification ${type}`;
        notification.innerHTML = `
            <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }

    // ============ CATEGORY FUNCTIONS ============
    
    async function loadCategoriesData() {
        try {
            const [categoriesResponse, booksResponse] = await Promise.all([
                fetch(API_ENDPOINTS.categories),
                fetch(API_ENDPOINTS.books)
            ]);
            
            const categoriesData = await categoriesResponse.json();
            const booksData = await booksResponse.json();
            
            if (booksData.success) {
                currentBooks = booksData.books || booksData.data || [];
            }
            
            if (categoriesData.success) {
                const categories = categoriesData.categories || categoriesData.data || [];
                displayCategories(categories);
                updateCategoryManagementSection();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            const categoriesTable = document.getElementById('categoriesTable');
            categoriesTable.innerHTML = '<tr><td colspan="4" class="error">Error loading categories</td></tr>';
        }
    }

    function displayCategories(categories) {
        const categoriesTable = document.getElementById('categoriesTable');
        
        if (!categories || categories.length === 0) {
            categoriesTable.innerHTML = '<tr><td colspan="4" class="loading">No categories found. Add your first category!</td></tr>';
            return;
        }
        
        categoriesTable.innerHTML = categories.map(category => {
            const bookCount = currentBooks ? 
                currentBooks.filter(book => book.category_id == category.category_id).length : 0;
            
            return `
                <tr>
                    <td>${category.category_id}</td>
                    <td>
                        <strong>${category.category_name}</strong>
                        ${category.description ? `<div style="font-size: 0.9em; color: #666; margin-top: 4px;">${category.description}</div>` : ''}
                    </td>
                    <td>
                        <span class="${bookCount > 0 ? 'in-stock' : 'out-of-stock'}" style="display: inline-block;">
                            ${bookCount} books
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="openEditCategoryModal(${category.category_id}, '${category.category_name.replace(/'/g, "\\'")}', '${(category.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory(${category.category_id})" ${bookCount > 0 ? 'disabled title="Cannot delete category with books"' : ''}>
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============ CATEGORY MODAL FUNCTIONS ============
    
    async function openAddCategoryModal() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_categories') && !isSuperAdmin) {
            showNotification('You do not have permission to add categories', 'error');
            return;
        }
        
        const modalHTML = `
            <div class="modal" id="addCategoryModal" style="display: flex;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>‚ûï Add New Category</h3>
                        <button class="close" onclick="closeAddCategoryModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="categoryForm">
                            <div class="form-group">
                                <label for="categoryName">Category Name *</label>
                                <input type="text" id="categoryName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="categoryDescription">Description</label>
                                <textarea id="categoryDescription" class="form-control" rows="3" placeholder="Optional description..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeAddCategoryModal()">‚ùå Cancel</button>
                        <button class="btn btn-primary" onclick="saveCategory()">üíæ Save Category</button>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('addCategoryModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeAddCategoryModal() {
        const modal = document.getElementById('addCategoryModal');
        if (modal) modal.remove();
    }

    async function saveCategory() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_categories') && !isSuperAdmin) {
            showNotification('You do not have permission to save categories', 'error');
            return;
        }
        
        const categoryName = document.getElementById('categoryName').value;
        const categoryDescription = document.getElementById('categoryDescription').value;
        
        if (!categoryName.trim()) {
            showNotification('Please enter a category name', 'warning');
            return;
        }
        
        try {
            const response = await fetch(API_ENDPOINTS.addCategory, {
                method: 'POST',
                body: new URLSearchParams({
                    category_name: categoryName,
                    description: categoryDescription
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Category added successfully!', 'success');
                closeAddCategoryModal();
                await loadCategoriesData();
                loadDashboardData();
                
                if (document.getElementById('book-inventory').classList.contains('active')) {
                    loadCategoryFilter();
                }
            } else {
                showNotification('Error adding category: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error adding category:', error);
            showNotification('Error adding category: ' + error.message, 'error');
        }
    }

    async function openEditCategoryModal(categoryId, categoryName, categoryDescription = '') {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_categories') && !isSuperAdmin) {
            showNotification('You do not have permission to edit categories', 'error');
            return;
        }
        
        const safeCategoryName = categoryName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeDescription = (categoryDescription || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        const modalHTML = `
            <div class="modal" id="editCategoryModal" style="display: flex;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Edit Category</h3>
                        <button class="close" onclick="closeEditCategoryModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editCategoryForm">
                            <input type="hidden" id="editCategoryId" value="${categoryId}">
                            <div class="form-group">
                                <label for="editCategoryName">Category Name *</label>
                                <input type="text" id="editCategoryName" class="form-control" value="${safeCategoryName}" required>
                            </div>
                            <div class="form-group">
                                <label for="editCategoryDescription">Description</label>
                                <textarea id="editCategoryDescription" class="form-control" rows="3">${safeDescription}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeEditCategoryModal()">‚ùå Cancel</button>
                        <button class="btn btn-primary" onclick="updateCategory()">üíæ Update Category</button>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('editCategoryModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeEditCategoryModal() {
        const modal = document.getElementById('editCategoryModal');
        if (modal) modal.remove();
    }

    async function updateCategory() {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_categories') && !isSuperAdmin) {
            showNotification('You do not have permission to update categories', 'error');
            return;
        }
        
        const categoryId = document.getElementById('editCategoryId').value;
        const categoryName = document.getElementById('editCategoryName').value;
        const categoryDescription = document.getElementById('editCategoryDescription').value;
        
        if (!categoryName.trim()) {
            showNotification('Please enter a category name', 'warning');
            return;
        }
        
        try {
            const response = await fetch(API_ENDPOINTS.updateCategory, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category_id: categoryId,
                    category_name: categoryName,
                    description: categoryDescription
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Category updated successfully!', 'success');
                closeEditCategoryModal();
                await loadCategoriesData();
                loadBookInventoryData();
            } else {
                showNotification('Error updating category: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error updating category:', error);
            showNotification('Error updating category', 'error');
        }
    }

    async function deleteCategory(categoryId) {
        // Ê£ÄÊü•ÊùÉÈôê
        if (!hasPermission('manage_categories') && !isSuperAdmin) {
            showNotification('You do not have permission to delete categories', 'error');
            return;
        }
        
        const bookCount = currentBooks ? 
            currentBooks.filter(book => book.category_id == categoryId).length : 0;
        
        if (bookCount > 0) {
            if (!confirm(`This category has ${bookCount} book(s).\n\nBooks in this category will be moved to "Uncategorized".\n\nAre you sure you want to delete this category?`)) {
                return;
            }
        } else {
            if (!confirm('Are you sure you want to delete this category?')) {
                return;
            }
        }
        
        try {
            const response = await fetch(API_ENDPOINTS.deleteCategory, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category_id: categoryId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Category deleted successfully!', 'success');
                await Promise.all([
                    loadCategoriesData(),
                    loadBookInventoryData()
                ]);
                loadDashboardData();
            } else {
                showNotification('Error deleting category: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            showNotification('Error deleting category', 'error');
        }
    }
// ============ PDF REPORT FUNCTIONS ============

function generatePDFReport() {
    const reportType = document.getElementById('pdfReportType').value;
    const period = document.getElementById('analyticsPeriod').value;
    
    // ÂàõÂª∫ÊâìÂç∞Á™óÂè£
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    // ÊûÑÂª∫ÊâìÂç∞ÂÜÖÂÆπ
    let printContent = buildPrintContent(reportType, period);
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Sales Report - ${getPeriodText(period)} - ${getReportTypeText(reportType)}</title>
            <style>
                /* ÊâìÂç∞Ê†∑Âºè */
                @media print {
                    @page { margin: 1cm; }
                    body { font-family: Arial, sans-serif; font-size: 12px; }
                    .no-print { display: none !important; }
                }
                
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    line-height: 1.6;
                }
                
                .report-header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 15px;
                }
                
                .report-title {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 5px;
                }
                
                .report-subtitle {
                    font-size: 14px;
                    color: #666;
                }
                
                .report-date {
                    margin-top: 10px;
                    font-size: 12px;
                    color: #999;
                }
                
                .section {
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                
                .section-title {
                    background: #2c3e50;
                    color: white;
                    padding: 10px 15px;
                    font-size: 16px;
                    margin-bottom: 15px;
                    border-radius: 4px;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 10px 0;
                }
                
                th {
                    background: #f5f5f5;
                    border: 1px solid #ddd;
                    padding: 10px;
                    text-align: left;
                    font-weight: bold;
                }
                
                td {
                    border: 1px solid #ddd;
                    padding: 8px 10px;
                }
                
                .stat-box {
                    display: inline-block;
                    background: #f8f9fa;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    padding: 15px;
                    margin: 10px;
                    min-width: 150px;
                    text-align: center;
                }
                
                .stat-value {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2c3e50;
                }
                
                .stat-label {
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                }
                
                .chart-container {
                    margin: 20px 0;
                    text-align: center;
                }
                
                .chart-placeholder {
                    height: 300px;
                    border: 1px solid #ddd;
                    background: #f9f9f9;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #666;
                    margin: 15px 0;
                }
                
                .footer {
                    margin-top: 50px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    font-size: 11px;
                    color: #999;
                    text-align: center;
                }
            </style>
        </head>
        <body>
            ${printContent}
            
            <script>
                // È°µÈù¢Âä†ËΩΩÂêéËá™Âä®ÊâìÂç∞
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        // ÊâìÂç∞ÂêéÂÖ≥Èó≠Á™óÂè£ÔºàÂèØÈÄâÔºâ
                        // setTimeout(function() { window.close(); }, 1000);
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

function buildPrintContent(reportType, period) {
    // Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆ
    const summary = getCurrentAnalyticsSummary();
    const salesTrend = getCurrentSalesTrend();
    const topBooks = getCurrentTopBooks();
    const categoryRevenue = getCurrentCategoryRevenue();
    
    const periodText = getPeriodText(period);
    const reportTypeText = getReportTypeText(reportType);
    const currentDate = new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let content = `
        <div class="report-header">
            <div class="report-title">Virtual BookStore Sales Report</div>
            <div class="report-subtitle">${reportTypeText} - ${periodText}</div>
            <div class="report-date">Generated on: ${currentDate}</div>
        </div>
    `;
    
    // Ê†πÊçÆÈÄâÊã©ÁöÑÊä•ÂëäÁ±ªÂûãÊûÑÂª∫ÂÜÖÂÆπ
    switch(reportType) {
        case 'summary':
            content += buildSummarySection(summary);
            break;
            
        case 'sales_trend':
            content += buildSalesTrendSection(salesTrend, periodText);
            break;
            
        case 'top_books':
            content += buildTopBooksSection(topBooks);
            break;
            
        case 'category':
            content += buildCategorySection(categoryRevenue);
            break;
            
        case 'all':
        default:
            content += buildFullReport(summary, salesTrend, topBooks, categoryRevenue, periodText);
            break;
    }
    
    // Ê∑ªÂä†È°µËÑö
    content += `
        <div class="footer">
            <p>Virtual BookStore Management System</p>
            <p>Report ID: ${generateReportId()}</p>
            <p>Confidential - For Internal Use Only</p>
        </div>
    `;
    
    return content;
}

function getCurrentAnalyticsSummary() {
    // ‰ªéÈ°µÈù¢Ëé∑ÂèñÁªüËÆ°ÊëòË¶ÅÊï∞ÊçÆ
    const summaryElements = document.querySelectorAll('#analyticsSummary .stat-card');
    const summary = {};
    
    if (summaryElements.length >= 4) {
        summary.total_orders = parseInt(summaryElements[0].querySelector('.stat-number').textContent) || 0;
        summary.total_revenue = parseFloat(summaryElements[1].querySelector('.stat-number').textContent.replace('RM ', '')) || 0;
        summary.total_customers = parseInt(summaryElements[2].querySelector('.stat-number').textContent) || 0;
        summary.avg_order_value = parseFloat(summaryElements[3].querySelector('.stat-number').textContent.replace('RM ', '')) || 0;
    }
    
    return summary;
}

function getCurrentSalesTrend() {
    // ‰ªéÂõæË°®‰∏≠Ëé∑ÂèñÈîÄÂîÆË∂ãÂäøÊï∞ÊçÆ
    const chartContainer = document.getElementById('salesTrendChart');
    const trendData = [];
    
    // ÁÆÄÂçïËß£ÊûêÂõæË°®Êï∞ÊçÆÔºàÂÆûÈôÖÂÆûÁé∞ÈúÄË¶ÅÊõ¥Â§çÊùÇÁöÑÊï∞ÊçÆÊèêÂèñÔºâ
    if (chartContainer) {
        const trendBars = chartContainer.querySelectorAll('div[style*="background: linear-gradient(to top"]');
        trendBars.forEach((bar, index) => {
            const title = bar.getAttribute('title') || '';
            const match = title.match(/RM (\d+\.?\d*)/);
            if (match) {
                trendData.push({
                    date: `Day ${index + 1}`,
                    total_revenue: parseFloat(match[1]),
                    order_count: Math.floor(Math.random() * 20) + 5 // Á§∫‰æãÊï∞ÊçÆ
                });
            }
        });
    }
    
    return trendData;
}

function getCurrentTopBooks() {
    // ‰ªéÈ°µÈù¢Ëé∑ÂèñÁÉ≠ÈîÄ‰π¶Á±çÊï∞ÊçÆ
    const topBooks = [];
    const tableRows = document.querySelectorAll('#topBooksChart tbody tr');
    
    tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            const rank = cells[0].textContent.trim();
            const titleCell = cells[1];
            const revenueCell = cells[2];
            const quantityCell = cells[3];
            
            const book = {
                rank: parseInt(rank),
                title: titleCell.querySelector('div[style*="font-weight: 500"]')?.textContent || '',
                author: titleCell.querySelector('div[style*="font-size: 0.8rem"]')?.textContent?.replace('by ', '') || '',
                category: titleCell.querySelector('div[style*="font-size: 0.7rem"]')?.textContent || '',
                total_revenue: parseFloat(revenueCell.querySelector('div[style*="font-weight: bold"]')?.textContent?.replace('RM ', '')) || 0,
                total_quantity: parseInt(quantityCell.querySelector('div[style*="font-weight: bold"]')?.textContent) || 0
            };
            
            if (book.title) {
                topBooks.push(book);
            }
        }
    });
    
    return topBooks;
}

function getCurrentCategoryRevenue() {
    // ‰ªéÈ°µÈù¢Ëé∑ÂèñÂàÜÁ±ªÊî∂ÂÖ•Êï∞ÊçÆ
    const categories = [];
    const categoryElements = document.querySelectorAll('#categoryRevenueChart div[style*="background: #f8f9fa; padding: 12px;"]');
    
    categoryElements.forEach(element => {
        const nameElement = element.querySelector('div[style*="font-weight: bold"]');
        const revenueElement = element.querySelector('div[style*="color: var(--success)"]');
        
        if (nameElement && revenueElement) {
            categories.push({
                category_name: nameElement.textContent,
                total_revenue: parseFloat(revenueElement.textContent.replace('RM ', '')) || 0,
                order_count: Math.floor(Math.random() * 10) + 1 // Á§∫‰æãÊï∞ÊçÆ
            });
        }
    });
    
    return categories;
}

function buildSummarySection(summary) {
    return `
        <div class="section">
            <div class="section-title">üìä Executive Summary</div>
            <div style="text-align: center; margin: 20px 0;">
                <div class="stat-box">
                    <div class="stat-value">${summary.total_orders || 0}</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">RM ${(summary.total_revenue || 0).toFixed(2)}</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${summary.total_customers || 0}</div>
                    <div class="stat-label">Customers</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">RM ${(summary.avg_order_value || 0).toFixed(2)}</div>
                    <div class="stat-label">Avg Order Value</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Performance Overview</h3>
                <p>This report summarizes the sales performance for the selected period. Key metrics include:</p>
                <ul>
                    <li><strong>Total Revenue:</strong> RM ${(summary.total_revenue || 0).toFixed(2)}</li>
                    <li><strong>Order Volume:</strong> ${summary.total_orders || 0} orders</li>
                    <li><strong>Customer Base:</strong> ${summary.total_customers || 0} customers</li>
                    <li><strong>Average Order Value:</strong> RM ${(summary.avg_order_value || 0).toFixed(2)}</li>
                </ul>
            </div>
        </div>
    `;
}

function buildSalesTrendSection(salesTrend, periodText) {
    let tableRows = '';
    let totalRevenue = 0;
    let totalOrders = 0;
    
    salesTrend.forEach(day => {
        totalRevenue += day.total_revenue;
        totalOrders += day.order_count;
        tableRows += `
            <tr>
                <td>${day.date}</td>
                <td>RM ${day.total_revenue.toFixed(2)}</td>
                <td>${day.order_count}</td>
                <td>RM ${(day.total_revenue / day.order_count || 0).toFixed(2)}</td>
            </tr>
        `;
    });
    
    return `
        <div class="section">
            <div class="section-title">üìà Sales Trend Analysis</div>
            <p><strong>Period:</strong> ${periodText}</p>
            
            <div class="chart-container">
                <div class="chart-placeholder">
                    Sales Trend Chart<br>
                    (For detailed charts, please view in the admin panel)
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date/Period</th>
                        <th>Revenue (RM)</th>
                        <th>Orders</th>
                        <th>Avg Revenue per Order</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                    <tr style="font-weight: bold; background: #f5f5f5;">
                        <td>TOTAL</td>
                        <td>RM ${totalRevenue.toFixed(2)}</td>
                        <td>${totalOrders}</td>
                        <td>RM ${(totalRevenue / totalOrders || 0).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px;">
                <h4>Trend Analysis:</h4>
                <p>‚Ä¢ Average daily revenue: <strong>RM ${(totalRevenue / salesTrend.length).toFixed(2)}</strong></p>
                <p>‚Ä¢ Average daily orders: <strong>${(totalOrders / salesTrend.length).toFixed(1)}</strong></p>
                <p>‚Ä¢ Best performing day: <strong>Day ${salesTrend.reduce((max, day, idx) => day.total_revenue > max.value ? {index: idx, value: day.total_revenue} : max, {index: 0, value: 0}).index + 1}</strong></p>
            </div>
        </div>
    `;
}

function buildTopBooksSection(topBooks) {
    let tableRows = '';
    let totalRevenue = 0;
    let totalQuantity = 0;
    
    topBooks.forEach(book => {
        totalRevenue += book.total_revenue;
        totalQuantity += book.total_quantity;
        tableRows += `
            <tr>
                <td>${book.rank}</td>
                <td>
                    <strong>${book.title}</strong><br>
                    <small>by ${book.author}</small><br>
                    <small style="color: #666;">${book.category}</small>
                </td>
                <td>RM ${book.total_revenue.toFixed(2)}</td>
                <td>${book.total_quantity}</td>
                <td>RM ${(book.total_revenue / book.total_quantity || 0).toFixed(2)}</td>
            </tr>
        `;
    });
    
    return `
        <div class="section">
            <div class="section-title">üî• Top Selling Books</div>
            
            <div class="chart-container">
                <div class="chart-placeholder">
                    Top Books Chart<br>
                    (For detailed charts, please view in the admin panel)
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Book Details</th>
                        <th>Revenue (RM)</th>
                        <th>Quantity Sold</th>
                        <th>Avg Price per Unit</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                    <tr style="font-weight: bold; background: #f5f5f5;">
                        <td colspan="2">TOTAL</td>
                        <td>RM ${totalRevenue.toFixed(2)}</td>
                        <td>${totalQuantity}</td>
                        <td>RM ${(totalRevenue / totalQuantity || 0).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px;">
                <h4>Top Performers Analysis:</h4>
                <p>‚Ä¢ Total revenue from top sellers: <strong>RM ${totalRevenue.toFixed(2)}</strong></p>
                <p>‚Ä¢ Total units sold: <strong>${totalQuantity}</strong></p>
                <p>‚Ä¢ Average price per unit: <strong>RM ${(totalRevenue / totalQuantity || 0).toFixed(2)}</strong></p>
            </div>
        </div>
    `;
}

function buildCategorySection(categories) {
    let tableRows = '';
    let totalRevenue = 0;
    let totalOrders = 0;
    
    categories.forEach(cat => {
        totalRevenue += cat.total_revenue;
        totalOrders += cat.order_count;
        const percentage = totalRevenue > 0 ? ((cat.total_revenue / totalRevenue) * 100).toFixed(1) : 0;
        
        tableRows += `
            <tr>
                <td>${cat.category_name}</td>
                <td>RM ${cat.total_revenue.toFixed(2)}</td>
                <td>${percentage}%</td>
                <td>${cat.order_count}</td>
                <td>RM ${(cat.total_revenue / cat.order_count || 0).toFixed(2)}</td>
            </tr>
        `;
    });
    
    return `
        <div class="section">
            <div class="section-title">üè∑Ô∏è Revenue by Category</div>
            
            <div class="chart-container">
                <div class="chart-placeholder">
                    Category Revenue Chart<br>
                    (For detailed charts, please view in the admin panel)
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Revenue (RM)</th>
                        <th>% of Total</th>
                        <th>Orders</th>
                        <th>Avg Revenue per Order</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                    <tr style="font-weight: bold; background: #f5f5f5;">
                        <td>TOTAL</td>
                        <td>RM ${totalRevenue.toFixed(2)}</td>
                        <td>100%</td>
                        <td>${totalOrders}</td>
                        <td>RM ${(totalRevenue / totalOrders || 0).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px;">
                <h4>Category Performance:</h4>
                ${categories.map((cat, idx) => {
                    const percentage = totalRevenue > 0 ? ((cat.total_revenue / totalRevenue) * 100).toFixed(1) : 0;
                    return `<p>‚Ä¢ ${cat.category_name}: <strong>RM ${cat.total_revenue.toFixed(2)}</strong> (${percentage}% of total)</p>`;
                }).join('')}
            </div>
        </div>
    `;
}

function buildFullReport(summary, salesTrend, topBooks, categoryRevenue, periodText) {
    return `
        ${buildSummarySection(summary)}
        ${buildSalesTrendSection(salesTrend, periodText)}
        ${buildTopBooksSection(topBooks)}
        ${buildCategorySection(categoryRevenue)}
    `;
}

function getPeriodText(period) {
    const texts = {
        '7days': 'Last 7 Days',
        '30days': 'Last 30 Days',
        '90days': 'Last 90 Days',
        'year': 'Last Year'
    };
    return texts[period] || period;
}

function getReportTypeText(reportType) {
    const texts = {
        'all': 'Full Report',
        'summary': 'Executive Summary',
        'sales_trend': 'Sales Trend Analysis',
        'top_books': 'Top Selling Books',
        'category': 'Category Revenue Analysis'
    };
    return texts[reportType] || reportType;
}

function generateReportId() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000);
    return `SR-${timestamp}-${random}`;
}
    // Close modal when clicking outside
    window.onclick = function(event) {
        const bookModal = document.getElementById('bookModal');
        const stockModal = document.getElementById('stockModal');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const adminModal = document.getElementById('adminModal');
        const adminDetailsModal = document.getElementById('adminDetailsModal');
        const sendPasswordModal = document.getElementById('sendPasswordModal');
        
        if (event.target === bookModal) closeModal();
        if (event.target === stockModal) closeStockModal();
        if (event.target === orderDetailsModal) closeOrderDetailsModal();
        if (event.target === adminModal) closeAdminModal();
        if (event.target === adminDetailsModal) closeAdminDetailsModal();
        if (event.target === sendPasswordModal) closeSendPasswordModal();
    }
</script>
</body>
</html>